
<!DOCTYPE html>

<html data-content_root="" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>langchain_aws.chat_models.bedrock_converse â€” ðŸ¦œðŸ”— LangChain  documentation</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/autodoc_pydantic.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/css/custom.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" rel="preload"/>
<link as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" rel="preload"/>
<script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>
<script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/doctools.js"></script>
<script src="../../../_static/sphinx_highlight.js"></script>
<script src="../../../_static/clipboard.min.js"></script>
<script src="../../../_static/copybutton.js"></script>
<script src="../../../_static/design-tabs.js"></script>
<script>DOCUMENTATION_OPTIONS.pagename = '_modules/langchain_aws/chat_models/bedrock_converse';</script>
<link href="../../../_static/favicon.png" rel="icon"/>
<link href="../../../search.html" rel="search" title="Search"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
<meta content="Aug 28, 2024" name="docbuild:last-update"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
<div class="skip-link d-print-none" id="pst-skip-link"><a href="#main-content">Skip to main content</a></div>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>Back to top</button>
<input class="sidebar-toggle" id="pst-primary-sidebar-checkbox" type="checkbox"/>
<label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
<input class="sidebar-toggle" id="pst-secondary-sidebar-checkbox" type="checkbox"/>
<label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
</div>
<div class="pst-async-banner-revealer d-none">
<aside aria-label="Version warning" class="d-none d-print-none" id="bd-header-version-warning"></aside>
</div>
<header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
<button aria-label="Site navigation" class="pst-navbar-icon sidebar-toggle primary-toggle">
<span class="fa-solid fa-bars"></span>
</button>
<div class="navbar-header-items__start">
<div class="navbar-item">
<a class="navbar-brand logo" href="../../../index.html">
<img alt="ðŸ¦œðŸ”— LangChain  documentation - Home" class="logo__image only-light" src="../../../_static/wordmark-api.svg"/>
<script>document.write(`<img src="../../../_static/wordmark-api-dark.svg" class="logo__image only-dark" alt="ðŸ¦œðŸ”— LangChain  documentation - Home"/>`);</script>
</a></div>
</div>
<div class="navbar-header-items">
<div class="me-auto navbar-header-items__center">
<div class="navbar-item">
<nav>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../reference.html">
    Reference
  </a>
</li>
<li class="nav-item">
<a class="nav-link nav-external" href="https://api.python.langchain.com/">
    Legacy reference
  </a>
</li>
</ul>
</nav></div>
</div>
<div class="navbar-header-items__end">
<div class="navbar-item navbar-persistent--container">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
<div class="navbar-item"><!-- This will display a link to LangChain docs -->
<head>
<style>
        .text-link {
            text-decoration: none; /* Remove underline */
            color: inherit;        /* Inherit color from parent element */
        }
    </style>
</head>
<body>
<a class="text-link" href="https://python.langchain.com/">Docs</a>
</body></div>
<div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
<div class="navbar-item"><ul aria-label="Quick Links" class="navbar-icon-links">
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/langchain-ai/langchain" rel="noopener" target="_blank" title="GitHub"><i aria-hidden="true" class="fa-brands fa-square-github fa-lg"></i>
<span class="sr-only">GitHub</span></a>
</li>
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/langchainai" rel="noopener" target="_blank" title="X / Twitter"><i aria-hidden="true" class="fab fa-twitter-square fa-lg"></i>
<span class="sr-only">X / Twitter</span></a>
</li>
</ul></div>
</div>
</div>
<div class="navbar-persistent--mobile">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
</div>
</header>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar hide-on-wide">
<div class="sidebar-header-items sidebar-primary__section">
<div class="sidebar-header-items__center">
<div class="navbar-item">
<nav>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../reference.html">
    Reference
  </a>
</li>
<li class="nav-item">
<a class="nav-link nav-external" href="https://api.python.langchain.com/">
    Legacy reference
  </a>
</li>
</ul>
</nav></div>
</div>
<div class="sidebar-header-items__end">
<div class="navbar-item"><!-- This will display a link to LangChain docs -->
<head>
<style>
        .text-link {
            text-decoration: none; /* Remove underline */
            color: inherit;        /* Inherit color from parent element */
        }
    </style>
</head>
<body>
<a class="text-link" href="https://python.langchain.com/">Docs</a>
</body></div>
<div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
<div class="navbar-item"><ul aria-label="Quick Links" class="navbar-icon-links">
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/langchain-ai/langchain" rel="noopener" target="_blank" title="GitHub"><i aria-hidden="true" class="fa-brands fa-square-github fa-lg"></i>
<span class="sr-only">GitHub</span></a>
</li>
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/langchainai" rel="noopener" target="_blank" title="X / Twitter"><i aria-hidden="true" class="fab fa-twitter-square fa-lg"></i>
<span class="sr-only">X / Twitter</span></a>
</li>
</ul></div>
</div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content" role="main">
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item">
<nav aria-label="Breadcrumb" class="d-print-none">
<ul class="bd-breadcrumbs">
<li class="breadcrumb-item breadcrumb-home">
<a aria-label="Home" class="nav-link" href="../../../index.html">
<i class="fa-solid fa-home"></i>
</a>
</li>
<li class="breadcrumb-item"><a class="nav-link" href="../../index.html">Module code</a></li>
<li aria-current="page" class="breadcrumb-item active">langchain_aw...</li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article">
<h1>Source code for langchain_aws.chat_models.bedrock_converse</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">langchain_core.callbacks</span> <span class="kn">import</span> <span class="n">CallbackManagerForLLMRun</span>
<span class="kn">from</span> <span class="nn">langchain_core.language_models</span> <span class="kn">import</span> <span class="n">BaseChatModel</span><span class="p">,</span> <span class="n">LanguageModelInput</span>
<span class="kn">from</span> <span class="nn">langchain_core.language_models.chat_models</span> <span class="kn">import</span> <span class="n">LangSmithParams</span>
<span class="kn">from</span> <span class="nn">langchain_core.messages</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AIMessage</span><span class="p">,</span>
    <span class="n">BaseMessage</span><span class="p">,</span>
    <span class="n">BaseMessageChunk</span><span class="p">,</span>
    <span class="n">HumanMessage</span><span class="p">,</span>
    <span class="n">HumanMessageChunk</span><span class="p">,</span>
    <span class="n">SystemMessage</span><span class="p">,</span>
    <span class="n">ToolCall</span><span class="p">,</span>
    <span class="n">ToolMessage</span><span class="p">,</span>
    <span class="n">merge_message_runs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">langchain_core.messages.ai</span> <span class="kn">import</span> <span class="n">AIMessageChunk</span><span class="p">,</span> <span class="n">UsageMetadata</span>
<span class="kn">from</span> <span class="nn">langchain_core.messages.tool</span> <span class="kn">import</span> <span class="n">tool_call</span> <span class="k">as</span> <span class="n">create_tool_call</span>
<span class="kn">from</span> <span class="nn">langchain_core.messages.tool</span> <span class="kn">import</span> <span class="n">tool_call_chunk</span>
<span class="kn">from</span> <span class="nn">langchain_core.output_parsers</span> <span class="kn">import</span> <span class="n">JsonOutputKeyToolsParser</span><span class="p">,</span> <span class="n">PydanticToolsParser</span>
<span class="kn">from</span> <span class="nn">langchain_core.output_parsers.base</span> <span class="kn">import</span> <span class="n">OutputParserLike</span>
<span class="kn">from</span> <span class="nn">langchain_core.outputs</span> <span class="kn">import</span> <span class="n">ChatGeneration</span><span class="p">,</span> <span class="n">ChatGenerationChunk</span><span class="p">,</span> <span class="n">ChatResult</span>
<span class="kn">from</span> <span class="nn">langchain_core.pydantic_v1</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Extra</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">root_validator</span>
<span class="kn">from</span> <span class="nn">langchain_core.runnables</span> <span class="kn">import</span> <span class="n">Runnable</span><span class="p">,</span> <span class="n">RunnableMap</span><span class="p">,</span> <span class="n">RunnablePassthrough</span>
<span class="kn">from</span> <span class="nn">langchain_core.tools</span> <span class="kn">import</span> <span class="n">BaseTool</span>
<span class="kn">from</span> <span class="nn">langchain_core.utils</span> <span class="kn">import</span> <span class="n">get_from_dict_or_env</span>
<span class="kn">from</span> <span class="nn">langchain_core.utils.function_calling</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">convert_to_openai_function</span><span class="p">,</span>
    <span class="n">convert_to_openai_tool</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">langchain_core.utils.pydantic</span> <span class="kn">import</span> <span class="n">TypeBaseModel</span><span class="p">,</span> <span class="n">is_basemodel_subclass</span>

<span class="kn">from</span> <span class="nn">langchain_aws.function_calling</span> <span class="kn">import</span> <span class="n">ToolsOutputParser</span>

<span class="n">_BM</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">"_BM"</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">BaseModel</span><span class="p">)</span>
<span class="n">_DictOrPydanticClass</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_BM</span><span class="p">],</span> <span class="n">Type</span><span class="p">]</span>


<div class="viewcode-block" id="ChatBedrockConverse"><a class="viewcode-back" href="../../../aws/chat_models/langchain_aws.chat_models.bedrock_converse.ChatBedrockConverse.html#langchain_aws.chat_models.bedrock_converse.ChatBedrockConverse">[docs]</a><span class="k">class</span> <span class="nc">ChatBedrockConverse</span><span class="p">(</span><span class="n">BaseChatModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Bedrock chat model integration built on the Bedrock converse API.</span>

<span class="sd">    This implementation will eventually replace the existing ChatBedrock implementation</span>
<span class="sd">    once the Bedrock converse API has feature parity with older Bedrock API.</span>
<span class="sd">    Specifically the converse API does not yet support custom Bedrock models.</span>

<span class="sd">    Setup:</span>
<span class="sd">        To use Amazon Bedrock make sure you've gone through all the steps described</span>
<span class="sd">        here: https://docs.aws.amazon.com/bedrock/latest/userguide/setting-up.html</span>

<span class="sd">        Once that's completed, install the LangChain integration:</span>

<span class="sd">        .. code-block:: bash</span>

<span class="sd">            pip install -U langchain-aws</span>

<span class="sd">    Key init args â€” completion params:</span>
<span class="sd">        model: str</span>
<span class="sd">            Name of BedrockConverse model to use.</span>
<span class="sd">        temperature: float</span>
<span class="sd">            Sampling temperature.</span>
<span class="sd">        max_tokens: Optional[int]</span>
<span class="sd">            Max number of tokens to generate.</span>

<span class="sd">    Key init args â€” client params:</span>
<span class="sd">        region_name: Optional[str]</span>
<span class="sd">            AWS region to use, e.g. 'us-west-2'.</span>
<span class="sd">        base_url: Optional[str]</span>
<span class="sd">            Bedrock endpoint to use. Needed if you don't want to default to us-east-</span>
<span class="sd">            1 endpoint.</span>
<span class="sd">        credentials_profile_name: Optional[str]</span>
<span class="sd">            The name of the profile in the ~/.aws/credentials or ~/.aws/config files.</span>

<span class="sd">    See full list of supported init args and their descriptions in the params section.</span>

<span class="sd">    Instantiate:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            from langchain_aws import ChatBedrockConverse</span>

<span class="sd">            llm = ChatBedrockConverse(</span>
<span class="sd">                model="anthropic.claude-3-sonnet-20240229-v1:0",</span>
<span class="sd">                temperature=0,</span>
<span class="sd">                max_tokens=None,</span>
<span class="sd">                # other params...</span>
<span class="sd">            )</span>

<span class="sd">    Invoke:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            messages = [</span>
<span class="sd">                ("system", "You are a helpful translator. Translate the user sentence to French."),</span>
<span class="sd">                ("human", "I love programming."),</span>
<span class="sd">            ]</span>
<span class="sd">            llm.invoke(messages)</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            AIMessage(content=[{'type': 'text', 'text': "J'aime la programmation."}], response_metadata={'ResponseMetadata': {'RequestId': '9ef1e313-a4c1-4f79-b631-171f658d3c0e', 'HTTPStatusCode': 200, 'HTTPHeaders': {'date': 'Sat, 15 Jun 2024 01:19:24 GMT', 'content-type': 'application/json', 'content-length': '205', 'connection': 'keep-alive', 'x-amzn-requestid': '9ef1e313-a4c1-4f79-b631-171f658d3c0e'}, 'RetryAttempts': 0}, 'stopReason': 'end_turn', 'metrics': {'latencyMs': 609}}, id='run-754e152b-2b41-4784-9538-d40d71a5c3bc-0', usage_metadata={'input_tokens': 25, 'output_tokens': 11, 'total_tokens': 36})</span>

<span class="sd">    Stream:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            for chunk in llm.stream(messages):</span>
<span class="sd">                print(chunk)</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            AIMessageChunk(content=[], id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[{'type': 'text', 'text': 'J', 'index': 0}], id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[{'text': "'", 'index': 0}], id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[{'text': 'a', 'index': 0}], id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[{'text': 'ime', 'index': 0}], id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[{'text': ' la', 'index': 0}], id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[{'text': ' programm', 'index': 0}], id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[{'text': 'ation', 'index': 0}], id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[{'text': '.', 'index': 0}], id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[{'index': 0}], id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[], response_metadata={'stopReason': 'end_turn'}, id='run-da3c2606-4792-440a-ac66-72e0d1f6d117')</span>
<span class="sd">            AIMessageChunk(content=[], response_metadata={'metrics': {'latencyMs': 581}}, id='run-da3c2606-4792-440a-ac66-72e0d1f6d117', usage_metadata={'input_tokens': 25, 'output_tokens': 11, 'total_tokens': 36})</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            stream = llm.stream(messages)</span>
<span class="sd">            full = next(stream)</span>
<span class="sd">            for chunk in stream:</span>
<span class="sd">                full += chunk</span>
<span class="sd">            full</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            AIMessageChunk(content=[{'type': 'text', 'text': "J'aime la programmation.", 'index': 0}], response_metadata={'stopReason': 'end_turn', 'metrics': {'latencyMs': 554}}, id='run-56a5a5e0-de86-412b-9835-624652dc3539', usage_metadata={'input_tokens': 25, 'output_tokens': 11, 'total_tokens': 36})</span>

<span class="sd">    Tool calling:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            from langchain_core.pydantic_v1 import BaseModel, Field</span>

<span class="sd">            class GetWeather(BaseModel):</span>
<span class="sd">                '''Get the current weather in a given location'''</span>

<span class="sd">                location: str = Field(..., description="The city and state, e.g. San Francisco, CA")</span>

<span class="sd">            class GetPopulation(BaseModel):</span>
<span class="sd">                '''Get the current population in a given location'''</span>

<span class="sd">                location: str = Field(..., description="The city and state, e.g. San Francisco, CA")</span>

<span class="sd">            llm_with_tools = llm.bind_tools([GetWeather, GetPopulation])</span>
<span class="sd">            ai_msg = llm_with_tools.invoke("Which city is hotter today and which is bigger: LA or NY?")</span>
<span class="sd">            ai_msg.tool_calls</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            [{'name': 'GetWeather',</span>
<span class="sd">              'args': {'location': 'Los Angeles, CA'},</span>
<span class="sd">              'id': 'tooluse_Mspi2igUTQygp-xbX6XGVw'},</span>
<span class="sd">             {'name': 'GetWeather',</span>
<span class="sd">              'args': {'location': 'New York, NY'},</span>
<span class="sd">              'id': 'tooluse_tOPHiDhvR2m0xF5_5tyqWg'},</span>
<span class="sd">             {'name': 'GetPopulation',</span>
<span class="sd">              'args': {'location': 'Los Angeles, CA'},</span>
<span class="sd">              'id': 'tooluse__gcY_klbSC-GqB-bF_pxNg'},</span>
<span class="sd">             {'name': 'GetPopulation',</span>
<span class="sd">              'args': {'location': 'New York, NY'},</span>
<span class="sd">              'id': 'tooluse_-1HSoGX0TQCSaIg7cdFy8Q'}]</span>

<span class="sd">        See ``ChatBedrockConverse.bind_tools()`` method for more.</span>

<span class="sd">    Structured output:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            from typing import Optional</span>

<span class="sd">            from langchain_core.pydantic_v1 import BaseModel, Field</span>

<span class="sd">            class Joke(BaseModel):</span>
<span class="sd">                '''Joke to tell user.'''</span>

<span class="sd">                setup: str = Field(description="The setup of the joke")</span>
<span class="sd">                punchline: str = Field(description="The punchline to the joke")</span>
<span class="sd">                rating: Optional[int] = Field(description="How funny the joke is, from 1 to 10")</span>

<span class="sd">            structured_llm = llm.with_structured_output(Joke)</span>
<span class="sd">            structured_llm.invoke("Tell me a joke about cats")</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            Joke(setup='What do you call a cat that gets all dressed up?', punchline='A purrfessional!', rating=7)</span>

<span class="sd">        See ``ChatBedrockConverse.with_structured_output()`` for more.</span>

<span class="sd">    Image input:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            import base64</span>
<span class="sd">            import httpx</span>
<span class="sd">            from langchain_core.messages import HumanMessage</span>

<span class="sd">            image_url = "https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Gfp-wisconsin-madison-the-nature-boardwalk.jpg/2560px-Gfp-wisconsin-madison-the-nature-boardwalk.jpg"</span>
<span class="sd">            image_data = base64.b64encode(httpx.get(image_url).content).decode("utf-8")</span>
<span class="sd">            message = HumanMessage(</span>
<span class="sd">                content=[</span>
<span class="sd">                    {"type": "text", "text": "describe the weather in this image"},</span>
<span class="sd">                    {</span>
<span class="sd">                        "type": "image",</span>
<span class="sd">                        "source": {"type": "base64", "media_type": "image/jpeg", "data": image_data},</span>
<span class="sd">                    },</span>
<span class="sd">                ],</span>
<span class="sd">            )</span>
<span class="sd">            ai_msg = llm.invoke([message])</span>
<span class="sd">            ai_msg.content</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            [{'type': 'text',</span>
<span class="sd">              'text': 'The image depicts a sunny day with a partly cloudy sky. The sky is a brilliant blue color with scattered white clouds drifting across. The lighting and cloud patterns suggest pleasant, mild weather conditions. The scene shows an open grassy field or meadow, indicating warm temperatures conducive for vegetation growth. Overall, the weather portrayed in this scenic outdoor image appears to be sunny with some clouds, likely representing a nice, comfortable day.'}]</span>

<span class="sd">    Token usage:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            ai_msg = llm.invoke(messages)</span>
<span class="sd">            ai_msg.usage_metadata</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {'input_tokens': 25, 'output_tokens': 11, 'total_tokens': 36}</span>

<span class="sd">    Response metadata</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            ai_msg = llm.invoke(messages)</span>
<span class="sd">            ai_msg.response_metadata</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {'ResponseMetadata': {'RequestId': '776a2a26-5946-45ae-859e-82dc5f12017c',</span>
<span class="sd">              'HTTPStatusCode': 200,</span>
<span class="sd">              'HTTPHeaders': {'date': 'Mon, 17 Jun 2024 01:37:05 GMT',</span>
<span class="sd">               'content-type': 'application/json',</span>
<span class="sd">               'content-length': '206',</span>
<span class="sd">               'connection': 'keep-alive',</span>
<span class="sd">               'x-amzn-requestid': '776a2a26-5946-45ae-859e-82dc5f12017c'},</span>
<span class="sd">              'RetryAttempts': 0},</span>
<span class="sd">             'stopReason': 'end_turn',</span>
<span class="sd">             'metrics': {'latencyMs': 1290}}</span>
<span class="sd">    """</span>  <span class="c1"># noqa: E501</span>

    <span class="n">client</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1">#: :meta private:</span>

    <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="s2">"model"</span><span class="p">)</span>
<span class="w">    </span><span class="sd">"""Id of the model to call.</span>
<span class="sd">    </span>
<span class="sd">    e.g., ``"anthropic.claude-3-sonnet-20240229-v1:0"``. This is equivalent to the </span>
<span class="sd">    modelID property in the list-foundation-models api. For custom and provisioned </span>
<span class="sd">    models, an ARN value is expected. See </span>
<span class="sd">    https://docs.aws.amazon.com/bedrock/latest/userguide/model-ids.html#model-ids-arns </span>
<span class="sd">    for a list of all supported built-in models.</span>
<span class="sd">    """</span>

    <span class="n">max_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Max tokens to generate."""</span>

    <span class="n">stop_sequences</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">"stop"</span><span class="p">)</span>
<span class="w">    </span><span class="sd">"""Stop generation if any of these substrings occurs."""</span>

    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Sampling temperature. Must be 0 to 1."""</span>

    <span class="n">top_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""The percentage of most-likely candidates that are considered for the next token.</span>
<span class="sd">    </span>
<span class="sd">    Must be 0 to 1.</span>
<span class="sd">    </span>
<span class="sd">    For example, if you choose a value of 0.8 for topP, the model selects from </span>
<span class="sd">    the top 80% of the probability distribution of tokens that could be next in the </span>
<span class="sd">    sequence."""</span>

    <span class="n">region_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""The aws region, e.g., `us-west-2`. </span>
<span class="sd">    </span>
<span class="sd">    Falls back to AWS_DEFAULT_REGION env variable or region specified in ~/.aws/config </span>
<span class="sd">    in case it is not provided here.</span>
<span class="sd">    """</span>

    <span class="n">credentials_profile_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="w">    </span><span class="sd">"""The name of the profile in the ~/.aws/credentials or ~/.aws/config files.</span>
<span class="sd">    </span>
<span class="sd">    Profile should either have access keys or role information specified.</span>
<span class="sd">    If not specified, the default credential profile or, if on an EC2 instance,</span>
<span class="sd">    credentials from IMDS will be used. See: </span>
<span class="sd">    https://boto3.amazonaws.com/v1/documentation/api/latest/guide/credentials.html</span>
<span class="sd">    """</span>

    <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
<span class="w">    </span><span class="sd">"""The model provider, e.g., amazon, cohere, ai21, etc. </span>
<span class="sd">    </span>
<span class="sd">    When not supplied, provider is extracted from the first part of the model_id, e.g. </span>
<span class="sd">    'amazon' in 'amazon.titan-text-express-v1'. This value should be provided for model </span>
<span class="sd">    ids that do not have the provider in them, like custom and provisioned models that </span>
<span class="sd">    have an ARN associated with them.</span>
<span class="sd">    """</span>

    <span class="n">endpoint_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">"base_url"</span><span class="p">)</span>
<span class="w">    </span><span class="sd">"""Needed if you don't want to default to us-east-1 endpoint"""</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""An optional botocore.config.Config instance to pass to the client."""</span>

    <span class="n">guardrail_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">"guardrails"</span><span class="p">)</span>
<span class="w">    </span><span class="sd">"""Configuration information for a guardrail that you want to use in the request."""</span>

    <span class="n">additional_model_request_fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Additional inference parameters that the model supports.</span>
<span class="sd">    </span>
<span class="sd">    Parameters beyond the base set of inference parameters that Converse supports in the</span>
<span class="sd">    inferenceConfig field.</span>
<span class="sd">    """</span>

    <span class="n">additional_model_response_field_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Additional model parameters field paths to return in the response. </span>
<span class="sd">    </span>
<span class="sd">    Converse returns the requested fields as a JSON Pointer object in the </span>
<span class="sd">    additionalModelResponseFields field. The following is example JSON for </span>
<span class="sd">    additionalModelResponseFieldPaths.</span>
<span class="sd">    """</span>

    <span class="n">supports_tool_choice_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Sequence</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">,</span> <span class="s2">"tool"</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">"""Which types of tool_choice values the model supports.</span>
<span class="sd">    </span>
<span class="sd">    Inferred if not specified. Inferred as ('auto', 'any', 'tool') if a 'claude-3' </span>
<span class="sd">    model is used, ('auto', 'any') if a 'mistral-large' model is used, empty otherwise.</span>
<span class="sd">    """</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Configuration for this pydantic object."""</span>

        <span class="n">extra</span> <span class="o">=</span> <span class="n">Extra</span><span class="o">.</span><span class="n">forbid</span>
        <span class="n">allow_population_by_field_name</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@root_validator</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_disable_streaming</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">values</span><span class="p">[</span><span class="s2">"provider"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"provider"</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"model_id"</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="s2">"model"</span><span class="p">]))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># As of 08/05/24 only Anthropic models support streamed tool calling</span>
        <span class="k">if</span> <span class="s2">"disable_streaming"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">"disable_streaming"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">False</span> <span class="k">if</span> <span class="s2">"anthropic"</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="s2">"provider"</span><span class="p">]</span> <span class="k">else</span> <span class="s2">"tool_calling"</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="nd">@root_validator</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_on_failure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_environment</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Validate that AWS credentials to and python package exists in environment."""</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s2">"client"</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">values</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s2">"credentials_profile_name"</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="s2">"credentials_profile_name"</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error raised by bedrock service: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"Could not load credentials to authenticate with AWS client. "</span>
                <span class="s2">"Please check that credentials in the specified "</span>
                <span class="sa">f</span><span class="s2">"profile name are valid. Bedrock error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="n">values</span><span class="p">[</span><span class="s2">"region_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_from_dict_or_env</span><span class="p">(</span>
            <span class="n">values</span><span class="p">,</span>
            <span class="s2">"region_name"</span><span class="p">,</span>
            <span class="s2">"AWS_DEFAULT_REGION"</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">region_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">client_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s2">"region_name"</span><span class="p">]:</span>
            <span class="n">client_params</span><span class="p">[</span><span class="s2">"region_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">"region_name"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s2">"endpoint_url"</span><span class="p">]:</span>
            <span class="n">client_params</span><span class="p">[</span><span class="s2">"endpoint_url"</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">"endpoint_url"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s2">"config"</span><span class="p">]:</span>
            <span class="n">client_params</span><span class="p">[</span><span class="s2">"config"</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">"config"</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">"client"</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">"bedrock-runtime"</span><span class="p">,</span> <span class="o">**</span><span class="n">client_params</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error raised by bedrock service: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"Could not load credentials to authenticate with AWS client. "</span>
                <span class="s2">"Please check that credentials in the specified "</span>
                <span class="sa">f</span><span class="s2">"profile name are valid. Bedrock error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># As of 08/05/24 only claude-3 and mistral-large models support tool choice:</span>
        <span class="c1"># https://docs.aws.amazon.com/bedrock/latest/APIReference/API_runtime_ToolChoice.html</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s2">"supports_tool_choice_values"</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">"claude-3"</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="s2">"model_id"</span><span class="p">]:</span>
                <span class="n">values</span><span class="p">[</span><span class="s2">"supports_tool_choice_values"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">,</span> <span class="s2">"tool"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">"mistral-large"</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="s2">"model_id"</span><span class="p">]:</span>
                <span class="n">values</span><span class="p">[</span><span class="s2">"supports_tool_choice_values"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="s2">"supports_tool_choice_values"</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">_generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span>
        <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">run_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CallbackManagerForLLMRun</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Top Level call"""</span>
        <span class="n">bedrock_messages</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="n">_messages_to_bedrock</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converse_params</span><span class="p">(</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">_snake_to_camel_keys</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">excluded_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">"inputSchema"</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">converse</span><span class="p">(</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">bedrock_messages</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span>
        <span class="p">)</span>
        <span class="n">response_message</span> <span class="o">=</span> <span class="n">_parse_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ChatResult</span><span class="p">(</span><span class="n">generations</span><span class="o">=</span><span class="p">[</span><span class="n">ChatGeneration</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">response_message</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">_stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span>
        <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">run_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CallbackManagerForLLMRun</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">ChatGenerationChunk</span><span class="p">]:</span>
        <span class="n">bedrock_messages</span><span class="p">,</span> <span class="n">system</span> <span class="o">=</span> <span class="n">_messages_to_bedrock</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converse_params</span><span class="p">(</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">_snake_to_camel_keys</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">excluded_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">"inputSchema"</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">converse_stream</span><span class="p">(</span>
            <span class="n">messages</span><span class="o">=</span><span class="n">bedrock_messages</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">"stream"</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">message_chunk</span> <span class="o">:=</span> <span class="n">_parse_stream_event</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">ChatGenerationChunk</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message_chunk</span><span class="p">)</span>

    <span class="c1"># TODO: Add async support once there are async bedrock.converse methods.</span>

<div class="viewcode-block" id="ChatBedrockConverse.bind_tools"><a class="viewcode-back" href="../../../aws/chat_models/langchain_aws.chat_models.bedrock_converse.ChatBedrockConverse.html#langchain_aws.chat_models.bedrock_converse.ChatBedrockConverse.bind_tools">[docs]</a>    <span class="k">def</span> <span class="nf">bind_tools</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">TypeBaseModel</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">LanguageModelInput</span><span class="p">,</span> <span class="n">BaseMessage</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">tool_choice</span><span class="p">:</span>
            <span class="n">tool_choice</span> <span class="o">=</span> <span class="n">_format_tool_choice</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">)</span>
            <span class="n">tool_choice_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tool_choice</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tool_choice_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supports_tool_choice_values</span> <span class="ow">or</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_tool_choice_values</span><span class="p">:</span>
                    <span class="n">supported</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"Model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> does not currently support tool_choice "</span>
                        <span class="sa">f</span><span class="s2">"of type </span><span class="si">{</span><span class="n">tool_choice_type</span><span class="si">}</span><span class="s2">. The following tool_choice types "</span>
                        <span class="sa">f</span><span class="s2">"are supported: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">supports_tool_choice_values</span><span class="si">}</span><span class="s2">."</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">supported</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"Model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> does not currently support tool_choice."</span>
                    <span class="p">)</span>

                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">supported</span><span class="si">}</span><span class="s2"> Please see "</span>
                    <span class="sa">f</span><span class="s2">"https://docs.aws.amazon.com/bedrock/latest/APIReference/API_runtime_ToolChoice.html "</span>  <span class="c1"># noqa: E501</span>
                    <span class="sa">f</span><span class="s2">"for the latest documentation on models that support tool choice."</span>
                <span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"tool_choice"</span><span class="p">]</span> <span class="o">=</span> <span class="n">_format_tool_choice</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">tools</span><span class="o">=</span><span class="n">_format_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChatBedrockConverse.with_structured_output"><a class="viewcode-back" href="../../../aws/chat_models/langchain_aws.chat_models.bedrock_converse.ChatBedrockConverse.html#langchain_aws.chat_models.bedrock_converse.ChatBedrockConverse.with_structured_output">[docs]</a>    <span class="k">def</span> <span class="nf">with_structured_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">_DictOrPydanticClass</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Runnable</span><span class="p">[</span><span class="n">LanguageModelInput</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">]]:</span>
        <span class="n">supports_tool_choice_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_tool_choice_values</span> <span class="ow">or</span> <span class="p">()</span>
        <span class="k">if</span> <span class="s2">"tool"</span> <span class="ow">in</span> <span class="n">supports_tool_choice_values</span><span class="p">:</span>
            <span class="n">tool_choice</span> <span class="o">=</span> <span class="n">convert_to_openai_function</span><span class="p">(</span><span class="n">schema</span><span class="p">)[</span><span class="s2">"name"</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">"any"</span> <span class="ow">in</span> <span class="n">supports_tool_choice_values</span><span class="p">:</span>
            <span class="n">tool_choice</span> <span class="o">=</span> <span class="s2">"any"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tool_choice</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">([</span><span class="n">schema</span><span class="p">],</span> <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_basemodel_subclass</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_streaming</span><span class="p">:</span>
                <span class="n">output_parser</span><span class="p">:</span> <span class="n">OutputParserLike</span> <span class="o">=</span> <span class="n">ToolsOutputParser</span><span class="p">(</span>
                    <span class="n">first_tool_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pydantic_schemas</span><span class="o">=</span><span class="p">[</span><span class="n">schema</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_parser</span> <span class="o">=</span> <span class="n">PydanticToolsParser</span><span class="p">(</span>
                    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">schema</span><span class="p">],</span>
                    <span class="n">first_tool_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tool_name</span> <span class="o">=</span> <span class="n">convert_to_openai_tool</span><span class="p">(</span><span class="n">schema</span><span class="p">)[</span><span class="s2">"function"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_streaming</span><span class="p">:</span>
                <span class="n">output_parser</span> <span class="o">=</span> <span class="n">ToolsOutputParser</span><span class="p">(</span><span class="n">first_tool_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_parser</span> <span class="o">=</span> <span class="n">JsonOutputKeyToolsParser</span><span class="p">(</span>
                    <span class="n">key_name</span><span class="o">=</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">first_tool_only</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">include_raw</span><span class="p">:</span>
            <span class="n">parser_assign</span> <span class="o">=</span> <span class="n">RunnablePassthrough</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">parsed</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s2">"raw"</span><span class="p">)</span> <span class="o">|</span> <span class="n">output_parser</span><span class="p">,</span> <span class="n">parsing_error</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">parser_none</span> <span class="o">=</span> <span class="n">RunnablePassthrough</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">parsed</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">parser_with_fallback</span> <span class="o">=</span> <span class="n">parser_assign</span><span class="o">.</span><span class="n">with_fallbacks</span><span class="p">(</span>
                <span class="p">[</span><span class="n">parser_none</span><span class="p">],</span> <span class="n">exception_key</span><span class="o">=</span><span class="s2">"parsing_error"</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">RunnableMap</span><span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span> <span class="o">|</span> <span class="n">parser_with_fallback</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">llm</span> <span class="o">|</span> <span class="n">output_parser</span></div>

    <span class="k">def</span> <span class="nf">_converse_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stopSequences</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">maxTokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">topP</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">toolChoice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">modelId</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inferenceConfig</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">toolConfig</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">additionalModelRequestFields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">additionalModelResponseFieldPaths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">guardrailConfig</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inferenceConfig</span><span class="p">:</span>
            <span class="n">inferenceConfig</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">"maxTokens"</span><span class="p">:</span> <span class="n">maxTokens</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span><span class="p">,</span>
                <span class="s2">"temperature"</span><span class="p">:</span> <span class="n">temperature</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
                <span class="s2">"topP"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_p</span> <span class="ow">or</span> <span class="n">topP</span><span class="p">,</span>
                <span class="s2">"stopSequences"</span><span class="p">:</span> <span class="n">stop</span> <span class="ow">or</span> <span class="n">stopSequences</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_sequences</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">toolConfig</span> <span class="ow">and</span> <span class="n">tools</span><span class="p">:</span>
            <span class="n">toolChoice</span> <span class="o">=</span> <span class="n">_format_tool_choice</span><span class="p">(</span><span class="n">toolChoice</span><span class="p">)</span> <span class="k">if</span> <span class="n">toolChoice</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">toolConfig</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"tools"</span><span class="p">:</span> <span class="n">_format_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">),</span> <span class="s2">"toolChoice"</span><span class="p">:</span> <span class="n">toolChoice</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">_drop_none</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">"modelId"</span><span class="p">:</span> <span class="n">modelId</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span>
                <span class="s2">"inferenceConfig"</span><span class="p">:</span> <span class="n">inferenceConfig</span><span class="p">,</span>
                <span class="s2">"toolConfig"</span><span class="p">:</span> <span class="n">toolConfig</span><span class="p">,</span>
                <span class="s2">"additionalModelRequestFields"</span><span class="p">:</span> <span class="n">additionalModelRequestFields</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_model_request_fields</span><span class="p">,</span>
                <span class="s2">"additionalModelResponseFieldPaths"</span><span class="p">:</span> <span class="n">additionalModelResponseFieldPaths</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_model_response_field_paths</span><span class="p">,</span>
                <span class="s2">"guardrailConfig"</span><span class="p">:</span> <span class="n">guardrailConfig</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">guardrail_config</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_ls_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LangSmithParams</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get standard params for tracing."""</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_invocation_params</span><span class="p">(</span><span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ls_params</span> <span class="o">=</span> <span class="n">LangSmithParams</span><span class="p">(</span>
            <span class="n">ls_provider</span><span class="o">=</span><span class="s2">"amazon_bedrock"</span><span class="p">,</span>
            <span class="n">ls_model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span>
            <span class="n">ls_model_type</span><span class="o">=</span><span class="s2">"chat"</span><span class="p">,</span>
            <span class="n">ls_temperature</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"temperature"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">ls_max_tokens</span> <span class="o">:=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"max_tokens"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span><span class="p">):</span>
            <span class="n">ls_params</span><span class="p">[</span><span class="s2">"ls_max_tokens"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ls_max_tokens</span>
        <span class="k">if</span> <span class="n">ls_stop</span> <span class="o">:=</span> <span class="n">stop</span> <span class="ow">or</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"stop"</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ls_params</span><span class="p">[</span><span class="s2">"ls_stop"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ls_stop</span>
        <span class="k">return</span> <span class="n">ls_params</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_llm_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return type of chat model."""</span>
        <span class="k">return</span> <span class="s2">"amazon_bedrock_converse_chat"</span></div>


<span class="k">def</span> <span class="nf">_messages_to_bedrock</span><span class="p">(</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">"""Handle Bedrock converse and Anthropic style content blocks"""</span>
    <span class="n">bedrock_messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bedrock_system</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Merge system, human, ai message runs because Anthropic expects (at most) 1</span>
    <span class="c1"># system message then alternating human/ai messages.</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">merge_message_runs</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">_anthropic_to_bedrock</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">HumanMessage</span><span class="p">):</span>
            <span class="c1"># If there's a human, tool, human message sequence, the</span>
            <span class="c1"># tool message will be merged with the first human message, so the second</span>
            <span class="c1"># human message will now be preceded by a human message and should also</span>
            <span class="c1"># be merged with it.</span>
            <span class="k">if</span> <span class="n">bedrock_messages</span> <span class="ow">and</span> <span class="n">bedrock_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"user"</span><span class="p">:</span>
                <span class="n">bedrock_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">"content"</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bedrock_messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"role"</span><span class="p">:</span> <span class="s2">"user"</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">:</span> <span class="n">content</span><span class="p">})</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">AIMessage</span><span class="p">):</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">_upsert_tool_calls_to_bedrock_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">)</span>
            <span class="n">bedrock_messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"role"</span><span class="p">:</span> <span class="s2">"assistant"</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">:</span> <span class="n">content</span><span class="p">})</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SystemMessage</span><span class="p">):</span>
            <span class="n">bedrock_system</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ToolMessage</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bedrock_messages</span> <span class="ow">and</span> <span class="n">bedrock_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"user"</span><span class="p">:</span>
                <span class="n">curr</span> <span class="o">=</span> <span class="n">bedrock_messages</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">curr</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"role"</span><span class="p">:</span> <span class="s2">"user"</span><span class="p">,</span> <span class="s2">"content"</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="n">curr</span><span class="p">[</span><span class="s2">"content"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">"toolResult"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"content"</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
                        <span class="s2">"toolUseId"</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">tool_call_id</span><span class="p">,</span>
                        <span class="s2">"status"</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">bedrock_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">bedrock_messages</span><span class="p">,</span> <span class="n">bedrock_system</span>


<span class="k">def</span> <span class="nf">_parse_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AIMessage</span><span class="p">:</span>
    <span class="n">anthropic_content</span> <span class="o">=</span> <span class="n">_bedrock_to_anthropic</span><span class="p">(</span>
        <span class="n">response</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"output"</span><span class="p">)[</span><span class="s2">"message"</span><span class="p">][</span><span class="s2">"content"</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">_extract_tool_calls</span><span class="p">(</span><span class="n">anthropic_content</span><span class="p">)</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="n">UsageMetadata</span><span class="p">(</span><span class="n">_camel_to_snake_keys</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"usage"</span><span class="p">)))</span>  <span class="c1"># type: ignore[misc]</span>
    <span class="k">return</span> <span class="n">AIMessage</span><span class="p">(</span>
        <span class="n">content</span><span class="o">=</span><span class="n">_str_if_single_text_block</span><span class="p">(</span><span class="n">anthropic_content</span><span class="p">),</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="n">usage_metadata</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span>
        <span class="n">response_metadata</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
        <span class="n">tool_calls</span><span class="o">=</span><span class="n">tool_calls</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_stream_event</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseMessageChunk</span><span class="p">]:</span>
    <span class="k">if</span> <span class="s2">"messageStart"</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
        <span class="c1"># TODO: needed?</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">AIMessageChunk</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="p">[])</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">"messageStart"</span><span class="p">][</span><span class="s2">"role"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"assistant"</span>
            <span class="k">else</span> <span class="n">HumanMessageChunk</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="p">[])</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="s2">"contentBlockStart"</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
        <span class="n">block</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">_bedrock_to_anthropic</span><span class="p">([</span><span class="n">event</span><span class="p">[</span><span class="s2">"contentBlockStart"</span><span class="p">][</span><span class="s2">"start"</span><span class="p">]])[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">"index"</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s2">"contentBlockStart"</span><span class="p">][</span><span class="s2">"contentBlockIndex"</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">tool_call_chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"tool_use"</span><span class="p">:</span>
            <span class="n">tool_call_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">tool_call_chunk</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">),</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">),</span>
                    <span class="n">args</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"input"</span><span class="p">),</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s2">"contentBlockStart"</span><span class="p">][</span><span class="s2">"contentBlockIndex"</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">AIMessageChunk</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">block</span><span class="p">],</span> <span class="n">tool_call_chunks</span><span class="o">=</span><span class="n">tool_call_chunks</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">"contentBlockDelta"</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
        <span class="n">block</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">_bedrock_to_anthropic</span><span class="p">([</span><span class="n">event</span><span class="p">[</span><span class="s2">"contentBlockDelta"</span><span class="p">][</span><span class="s2">"delta"</span><span class="p">]])[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">"index"</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s2">"contentBlockDelta"</span><span class="p">][</span><span class="s2">"contentBlockIndex"</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">tool_call_chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"tool_use"</span><span class="p">:</span>
            <span class="n">tool_call_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">tool_call_chunk</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"name"</span><span class="p">),</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"id"</span><span class="p">),</span>
                    <span class="n">args</span><span class="o">=</span><span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"input"</span><span class="p">),</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s2">"contentBlockDelta"</span><span class="p">][</span><span class="s2">"contentBlockIndex"</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">AIMessageChunk</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">block</span><span class="p">],</span> <span class="n">tool_call_chunks</span><span class="o">=</span><span class="n">tool_call_chunks</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">"contentBlockStop"</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
        <span class="c1"># TODO: needed?</span>
        <span class="k">return</span> <span class="n">AIMessageChunk</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[{</span><span class="s2">"index"</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s2">"contentBlockStop"</span><span class="p">][</span><span class="s2">"contentBlockIndex"</span><span class="p">]}]</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="s2">"messageStop"</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
        <span class="c1"># TODO: snake case response metadata?</span>
        <span class="k">return</span> <span class="n">AIMessageChunk</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="p">[],</span> <span class="n">response_metadata</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s2">"messageStop"</span><span class="p">])</span>
    <span class="k">elif</span> <span class="s2">"metadata"</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
        <span class="n">usage</span> <span class="o">=</span> <span class="n">UsageMetadata</span><span class="p">(</span><span class="n">_camel_to_snake_keys</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">"metadata"</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"usage"</span><span class="p">)))</span>  <span class="c1"># type: ignore[misc]</span>
        <span class="k">return</span> <span class="n">AIMessageChunk</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[],</span> <span class="n">response_metadata</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s2">"metadata"</span><span class="p">],</span> <span class="n">usage_metadata</span><span class="o">=</span><span class="n">usage</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="s2">"Exception"</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Received AWS exception </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Received unsupported stream event:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_anthropic_to_bedrock</span><span class="p">(</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">"text"</span><span class="p">:</span> <span class="n">content</span><span class="p">}]</span>
    <span class="n">bedrock_content</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">_snake_to_camel_keys</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"text"</span><span class="p">:</span> <span class="n">block</span><span class="p">})</span>
        <span class="c1"># Assume block is already in bedrock format.</span>
        <span class="k">elif</span> <span class="s2">"type"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"text"</span><span class="p">:</span>
            <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"text"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]})</span>
        <span class="k">elif</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image"</span><span class="p">:</span>
            <span class="c1"># Assume block is already in bedrock format.</span>
            <span class="k">if</span> <span class="s2">"image"</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
                <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"image"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"image"</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">"image"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">"format"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"source"</span><span class="p">][</span><span class="s2">"mediaType"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="s2">"source"</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">"bytes"</span><span class="p">:</span> <span class="n">_b64str_to_bytes</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="s2">"source"</span><span class="p">][</span><span class="s2">"data"</span><span class="p">])</span>
                            <span class="p">},</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image_url"</span><span class="p">:</span>
            <span class="c1"># Support OpenAI image format as well.</span>
            <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">"image"</span><span class="p">:</span> <span class="n">_format_openai_image_url</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="s2">"imageUrl"</span><span class="p">][</span><span class="s2">"url"</span><span class="p">])}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"document"</span><span class="p">:</span>
            <span class="c1"># Assume block in bedrock document format</span>
            <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"document"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"document"</span><span class="p">]})</span>
        <span class="k">elif</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"tool_use"</span><span class="p">:</span>
            <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">"toolUse"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"toolUseId"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span>
                        <span class="s2">"input"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"input"</span><span class="p">],</span>
                        <span class="s2">"name"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"tool_result"</span><span class="p">:</span>
            <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">"toolResult"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"toolUseId"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"toolUseId"</span><span class="p">],</span>
                        <span class="s2">"content"</span><span class="p">:</span> <span class="n">_anthropic_to_bedrock</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="s2">"content"</span><span class="p">]),</span>
                        <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"error"</span> <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"isError"</span><span class="p">)</span> <span class="k">else</span> <span class="s2">"success"</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="c1"># Only needed for tool_result content blocks.</span>
        <span class="k">elif</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"json"</span><span class="p">:</span>
            <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"json"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"json"</span><span class="p">]})</span>
        <span class="k">elif</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"guard_content"</span><span class="p">:</span>
            <span class="n">bedrock_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"guardContent"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]}}})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unsupported content block type:</span><span class="se">\n</span><span class="si">{</span><span class="n">block</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="c1"># drop empty text blocks</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">bedrock_content</span> <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">_bedrock_to_anthropic</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">anthropic_content</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">_camel_to_snake_keys</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">"text"</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">anthropic_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"text"</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]})</span>
        <span class="k">elif</span> <span class="s2">"tool_use"</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">"tool_use"</span><span class="p">][</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="s2">"tool_use"</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"tool_use_id"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">anthropic_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"tool_use"</span><span class="p">,</span> <span class="o">**</span><span class="n">block</span><span class="p">[</span><span class="s2">"tool_use"</span><span class="p">]})</span>
        <span class="k">elif</span> <span class="s2">"image"</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">anthropic_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"image"</span><span class="p">,</span>
                    <span class="s2">"source"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"media_type"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"image/</span><span class="si">{</span><span class="n">block</span><span class="p">[</span><span class="s1">'image'</span><span class="p">][</span><span class="s1">'format'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                        <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"base64"</span><span class="p">,</span>
                        <span class="s2">"data"</span><span class="p">:</span> <span class="n">_bytes_to_b64_str</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="s2">"image"</span><span class="p">][</span><span class="s2">"source"</span><span class="p">][</span><span class="s2">"bytes"</span><span class="p">]),</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">"tool_result"</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">anthropic_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"tool_result"</span><span class="p">,</span>
                    <span class="s2">"tool_use_id"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"tool_result"</span><span class="p">][</span><span class="s2">"tool_use_id"</span><span class="p">],</span>
                    <span class="s2">"is_error"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"tool_result"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"status"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"error"</span><span class="p">,</span>
                    <span class="s2">"content"</span><span class="p">:</span> <span class="n">_bedrock_to_anthropic</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="s2">"tool_result"</span><span class="p">][</span><span class="s2">"content"</span><span class="p">]),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="c1"># Only occurs in content blocks of a tool_result:</span>
        <span class="k">elif</span> <span class="s2">"json"</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">anthropic_content</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"type"</span><span class="p">:</span> <span class="s2">"json"</span><span class="p">,</span> <span class="o">**</span><span class="n">block</span><span class="p">})</span>
        <span class="k">elif</span> <span class="s2">"guard_content"</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">anthropic_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"guard_content"</span><span class="p">,</span>
                    <span class="s2">"guard_content"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"text"</span><span class="p">,</span>
                        <span class="s2">"text"</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s2">"guard_content"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">],</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"Unexpected content block type in content. Expected to have one of "</span>
                <span class="s2">"'text', 'tool_use', 'image', or 'tool_result' keys. Received:</span><span class="se">\n\n</span><span class="s2">"</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">block</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">anthropic_content</span>


<span class="k">def</span> <span class="nf">_format_tools</span><span class="p">(</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">TypeBaseModel</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">],],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">"toolSpec"</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]]]:</span>
    <span class="n">formatted_tools</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"toolSpec"</span> <span class="ow">in</span> <span class="n">tool</span><span class="p">:</span>
            <span class="n">formatted_tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">convert_to_openai_function</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>
            <span class="n">spec</span><span class="p">[</span><span class="s2">"inputSchema"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"json"</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"parameters"</span><span class="p">)}</span>
            <span class="n">formatted_tools</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"toolSpec"</span><span class="p">:</span> <span class="n">spec</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">formatted_tools</span>


<span class="k">def</span> <span class="nf">_format_tool_choice</span><span class="p">(</span>
    <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_choice</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tool_choice</span>
    <span class="k">elif</span> <span class="n">tool_choice</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"auto"</span><span class="p">,</span> <span class="s2">"any"</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">tool_choice</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"tool"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="n">tool_choice</span><span class="p">}}</span>


<span class="k">def</span> <span class="nf">_extract_tool_calls</span><span class="p">(</span><span class="n">anthropic_content</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]:</span>
    <span class="n">tool_calls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">anthropic_content</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"tool_use"</span><span class="p">:</span>
            <span class="n">tool_calls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">create_tool_call</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">block</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="n">block</span><span class="p">[</span><span class="s2">"input"</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="n">block</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">tool_calls</span>


<span class="k">def</span> <span class="nf">_snake_to_camel</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_"</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>


<span class="k">def</span> <span class="nf">_camel_to_snake</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(?&lt;=[a-z])(?=[A-Z])|(?&lt;=[A-Z])(?=[A-Z][a-z])"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">"_"</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">"_T"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_camel_to_snake_keys</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">_T</span><span class="p">,</span> <span class="p">[</span><span class="n">_camel_to_snake_keys</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span>
            <span class="n">_T</span><span class="p">,</span> <span class="p">{</span><span class="n">_camel_to_snake</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">_camel_to_snake_keys</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span> <span class="nf">_snake_to_camel_keys</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">_T</span><span class="p">,</span> <span class="n">excluded_keys</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span>
            <span class="n">_T</span><span class="p">,</span> <span class="p">[</span><span class="n">_snake_to_camel_keys</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">excluded_keys</span><span class="o">=</span><span class="n">excluded_keys</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">excluded_keys</span><span class="p">:</span>
                <span class="n">_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_dict</span><span class="p">[</span><span class="n">_snake_to_camel</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">_snake_to_camel_keys</span><span class="p">(</span>
                    <span class="n">v</span><span class="p">,</span> <span class="n">excluded_keys</span><span class="o">=</span><span class="n">excluded_keys</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">_T</span><span class="p">,</span> <span class="n">_dict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span> <span class="nf">_drop_none</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_drop_none</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">_drop_none</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">new</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span> <span class="nf">_b64str_to_bytes</span><span class="p">(</span><span class="n">base64_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">base64_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_bytes_to_b64_str</span><span class="p">(</span><span class="n">bytes_</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">bytes_</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_str_if_single_text_block</span><span class="p">(</span>
    <span class="n">anthropic_content</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">anthropic_content</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">anthropic_content</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"text"</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">anthropic_content</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">anthropic_content</span>


<span class="k">def</span> <span class="nf">_upsert_tool_calls_to_bedrock_content</span><span class="p">(</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">tool_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
    <span class="n">existing_tc_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">content</span> <span class="k">if</span> <span class="s2">"toolUse"</span> <span class="ow">in</span> <span class="n">block</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">block</span><span class="p">[</span><span class="s2">"toolUse"</span><span class="p">][</span><span class="s2">"toolUseId"</span><span class="p">]</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">existing_tc_blocks</span>
        <span class="p">]:</span>
            <span class="n">tc_block</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">block</span>
                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">existing_tc_blocks</span>
                <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="s2">"toolUse"</span><span class="p">][</span><span class="s2">"toolUseId"</span><span class="p">]</span> <span class="o">==</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">tc_block</span><span class="p">[</span><span class="s2">"toolUse"</span><span class="p">][</span><span class="s2">"input"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"args"</span><span class="p">]</span>
            <span class="n">tc_block</span><span class="p">[</span><span class="s2">"toolUse"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">"toolUse"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"toolUseId"</span><span class="p">:</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span>
                        <span class="s2">"input"</span><span class="p">:</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"args"</span><span class="p">],</span>
                        <span class="s2">"name"</span><span class="p">:</span> <span class="n">tool_call</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">content</span>


<span class="k">def</span> <span class="nf">_format_openai_image_url</span><span class="p">(</span><span class="n">image_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Formats an image of format data:image/jpeg;base64,{b64_string}</span>
<span class="sd">    to a dict for bedrock api.</span>

<span class="sd">    And throws an error if url is not a b64 image.</span>
<span class="sd">    """</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"^data:image/(?P&lt;media_type&gt;.+);base64,(?P&lt;data&gt;.+)$"</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">image_url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">"Bedrock does not currently support OpenAI-format image URLs, only "</span>
            <span class="s2">"base64-encoded images. Example: data:image/png;base64,'/9j/4AAQSk'..."</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">"format"</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"media_type"</span><span class="p">),</span>
        <span class="s2">"source"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"bytes"</span><span class="p">:</span> <span class="n">_b64str_to_bytes</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">"data"</span><span class="p">))},</span>
    <span class="p">}</span>
</pre></div>
</article>
</div>
</div>
<footer class="bd-footer-content">
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>
<footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
<div class="footer-items__start">
<div class="footer-item">
<p class="copyright">
    
      Â© Copyright 2023, LangChain Inc.
      <br/>
</p>
</div>
</div>
</div>
</footer>
</body>
</html>