
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>langchain_postgres.vectorstores &#8212; ðŸ¦œðŸ”— LangChain  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=b7c2929a" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script src="../../_static/documentation_options.js?v=7f41d439"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/langchain_postgres/vectorstores';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Aug 08, 2024"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the api  ..."
         aria-label="Search the api  ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/wordmark-small.png" class="logo__image only-light" alt="ðŸ¦œðŸ”— LangChain  documentation - Home"/>
    <script>document.write(`<img src="../../_static/wordmark-dark-small.png" class="logo__image only-dark" alt="ðŸ¦œðŸ”— LangChain  documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../core/index.html">
                        Core
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../langchain/index.html">
                        LangchAIn
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../ai21/index.html">
                        Ai21
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../airbyte/index.html">
                        Airbyte
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../anthropic/index.html">
                        Anthropic
                      </a>
                    </li>
                
            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../astradb/index.html">
                        AstraDB
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../aws/index.html">
                        Aws
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../chroma/index.html">
                        Chroma
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../cohere/index.html">
                        Cohere
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../couchbase/index.html">
                        Couchbase
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../elasticsearch/index.html">
                        Elasticsearch
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../exa/index.html">
                        Exa
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../fireworks/index.html">
                        Fireworks
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../groq/index.html">
                        Groq
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../huggingface/index.html">
                        Huggingface
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../milvus/index.html">
                        Milvus
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../mistralai/index.html">
                        MistralAI
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../mongodb/index.html">
                        MongoDB
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../nomic/index.html">
                        Nomic
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../ollama/index.html">
                        Ollama
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../openai/index.html">
                        OpenAI
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../pinecone/index.html">
                        Pinecone
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../postgres/index.html">
                        Postgres
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../prompty/index.html">
                        Prompty
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../qdrant/index.html">
                        Qdrant
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../robocorp/index.html">
                        Robocorp
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../together/index.html">
                        Together
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../unstructured/index.html">
                        Unstructured
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../voyageai/index.html">
                        VoyageAI
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../weaviate/index.html">
                        Weaviate
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link dropdown-item nav-external" href="https://python.langchain.com">
                    User guide
                  </a>
                </li>
                
                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Quick Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/langchain-ai/langchain" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/langchainai" title="X / Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">X / Twitter</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../core/index.html">
                        Core
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../langchain/index.html">
                        LangchAIn
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../ai21/index.html">
                        Ai21
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../airbyte/index.html">
                        Airbyte
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../anthropic/index.html">
                        Anthropic
                      </a>
                    </li>
                
            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links-2">
                    More
                </button>
                <ul id="pst-nav-more-links-2" class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../astradb/index.html">
                        AstraDB
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../aws/index.html">
                        Aws
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../chroma/index.html">
                        Chroma
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../cohere/index.html">
                        Cohere
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../couchbase/index.html">
                        Couchbase
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../elasticsearch/index.html">
                        Elasticsearch
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../exa/index.html">
                        Exa
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../fireworks/index.html">
                        Fireworks
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../groq/index.html">
                        Groq
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../huggingface/index.html">
                        Huggingface
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../milvus/index.html">
                        Milvus
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../mistralai/index.html">
                        MistralAI
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../mongodb/index.html">
                        MongoDB
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../nomic/index.html">
                        Nomic
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../ollama/index.html">
                        Ollama
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../openai/index.html">
                        OpenAI
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../pinecone/index.html">
                        Pinecone
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../postgres/index.html">
                        Postgres
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../prompty/index.html">
                        Prompty
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../qdrant/index.html">
                        Qdrant
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../robocorp/index.html">
                        Robocorp
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../together/index.html">
                        Together
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../unstructured/index.html">
                        Unstructured
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../voyageai/index.html">
                        VoyageAI
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../weaviate/index.html">
                        Weaviate
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link dropdown-item nav-external" href="https://python.langchain.com">
                    User guide
                  </a>
                </li>
                
                </ul>
            </li>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Quick Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/langchain-ai/langchain" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/langchainai" title="X / Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fab fa-twitter-square fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">X / Twitter</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">langchain_po...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for langchain_postgres.vectorstores</h1><div class="highlight"><pre>
<span></span><span class="c1"># pylint: disable=too-many-lines</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AsyncGenerator</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cast</span> <span class="k">as</span> <span class="n">typing_cast</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">langchain_core.documents</span> <span class="kn">import</span> <span class="n">Document</span>
<span class="kn">from</span> <span class="nn">langchain_core.embeddings</span> <span class="kn">import</span> <span class="n">Embeddings</span>
<span class="kn">from</span> <span class="nn">langchain_core.indexing</span> <span class="kn">import</span> <span class="n">UpsertResponse</span>
<span class="kn">from</span> <span class="nn">langchain_core.utils</span> <span class="kn">import</span> <span class="n">get_from_dict_or_env</span>
<span class="kn">from</span> <span class="nn">langchain_core.vectorstores</span> <span class="kn">import</span> <span class="n">VectorStore</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLColumnExpression</span><span class="p">,</span> <span class="n">cast</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="kn">import</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">JSONB</span><span class="p">,</span> <span class="n">JSONPATH</span><span class="p">,</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">insert</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">Engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AsyncEngine</span><span class="p">,</span>
    <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="n">async_sessionmaker</span><span class="p">,</span>
    <span class="n">create_async_engine</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Session</span><span class="p">,</span>
    <span class="n">declarative_base</span><span class="p">,</span>
    <span class="n">relationship</span><span class="p">,</span>
    <span class="n">scoped_session</span><span class="p">,</span>
    <span class="n">sessionmaker</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">langchain_postgres._utils</span> <span class="kn">import</span> <span class="n">maximal_marginal_relevance</span>


<div class="viewcode-block" id="DistanceStrategy">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.DistanceStrategy.html#langchain_postgres.vectorstores.DistanceStrategy">[docs]</a>
<span class="k">class</span> <span class="nc">DistanceStrategy</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumerator of the Distance strategies.&quot;&quot;&quot;</span>

    <span class="n">EUCLIDEAN</span> <span class="o">=</span> <span class="s2">&quot;l2&quot;</span>
    <span class="n">COSINE</span> <span class="o">=</span> <span class="s2">&quot;cosine&quot;</span>
    <span class="n">MAX_INNER_PRODUCT</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span></div>



<span class="n">DEFAULT_DISTANCE_STRATEGY</span> <span class="o">=</span> <span class="n">DistanceStrategy</span><span class="o">.</span><span class="n">COSINE</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>  <span class="c1"># type: Any</span>


<span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span> <span class="o">=</span> <span class="s2">&quot;langchain&quot;</span>


<span class="n">_classes</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">COMPARISONS_TO_NATIVE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;$eq&quot;</span><span class="p">:</span> <span class="s2">&quot;==&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="s2">&quot;!=&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$lt&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$lte&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$gt&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$gte&quot;</span><span class="p">:</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">SPECIAL_CASED_OPERATORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;$in&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$nin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$between&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$exists&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">TEXT_OPERATORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;$like&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$ilike&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">LOGICAL_OPERATORS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$and&quot;</span><span class="p">,</span> <span class="s2">&quot;$or&quot;</span><span class="p">,</span> <span class="s2">&quot;$not&quot;</span><span class="p">}</span>

<span class="n">SUPPORTED_OPERATORS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">COMPARISONS_TO_NATIVE</span><span class="p">)</span>
    <span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">TEXT_OPERATORS</span><span class="p">)</span>
    <span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">LOGICAL_OPERATORS</span><span class="p">)</span>
    <span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">SPECIAL_CASED_OPERATORS</span><span class="p">)</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_embedding_collection_store</span><span class="p">(</span><span class="n">vector_dimension</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_classes</span>
    <span class="k">if</span> <span class="n">_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_classes</span>

    <span class="kn">from</span> <span class="nn">pgvector.sqlalchemy</span> <span class="kn">import</span> <span class="n">Vector</span>  <span class="c1"># type: ignore</span>

    <span class="k">class</span> <span class="nc">CollectionStore</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collection store.&quot;&quot;&quot;</span>

        <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;langchain_pg_collection&quot;</span>

        <span class="n">uuid</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="n">UUID</span><span class="p">(</span><span class="n">as_uuid</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span>
        <span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmetadata</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span>

        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
            <span class="s2">&quot;EmbeddingStore&quot;</span><span class="p">,</span>
            <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;collection&quot;</span><span class="p">,</span>
            <span class="n">passive_deletes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">get_by_name</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;CollectionStore&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">typing_cast</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>
                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="nd">@classmethod</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">aget_by_name</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;CollectionStore&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">select</span><span class="p">(</span><span class="n">CollectionStore</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">typing_cast</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">scalars</span><span class="p">()</span>
                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">cmetadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;CollectionStore&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get or create a collection.</span>
<span class="sd">            Returns:</span>
<span class="sd">                 Where the bool is True if the collection was created.</span>
<span class="sd">            &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
            <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">collection</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">collection</span><span class="p">,</span> <span class="n">created</span>

            <span class="n">collection</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">cmetadata</span><span class="o">=</span><span class="n">cmetadata</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">collection</span><span class="p">,</span> <span class="n">created</span>

        <span class="nd">@classmethod</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">aget_or_create</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">cmetadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;CollectionStore&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get or create a collection.</span>
<span class="sd">            Returns [Collection, bool] where the bool is True if the collection was created.</span>
<span class="sd">            &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
            <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">aget_by_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">collection</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">collection</span><span class="p">,</span> <span class="n">created</span>

            <span class="n">collection</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">cmetadata</span><span class="o">=</span><span class="n">cmetadata</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">collection</span><span class="p">,</span> <span class="n">created</span>

    <span class="k">class</span> <span class="nc">EmbeddingStore</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Embedding store.&quot;&quot;&quot;</span>

        <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;langchain_pg_embedding&quot;</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">collection_id</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
            <span class="n">UUID</span><span class="p">(</span><span class="n">as_uuid</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">CollectionStore</span><span class="o">.</span><span class="n">__tablename__</span><span class="si">}</span><span class="s2">.uuid&quot;</span><span class="p">,</span>
                <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;CASCADE&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">CollectionStore</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;embeddings&quot;</span><span class="p">)</span>

        <span class="n">embedding</span><span class="p">:</span> <span class="n">Vector</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">Vector</span><span class="p">(</span><span class="n">vector_dimension</span><span class="p">))</span>
        <span class="n">document</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmetadata</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">JSONB</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span>
                <span class="s2">&quot;ix_cmetadata_gin&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cmetadata&quot;</span><span class="p">,</span>
                <span class="n">postgresql_using</span><span class="o">=</span><span class="s2">&quot;gin&quot;</span><span class="p">,</span>
                <span class="n">postgresql_ops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cmetadata&quot;</span><span class="p">:</span> <span class="s2">&quot;jsonb_path_ops&quot;</span><span class="p">},</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="n">_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">EmbeddingStore</span><span class="p">,</span> <span class="n">CollectionStore</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_classes</span>


<span class="k">def</span> <span class="nf">_results_to_docs</span><span class="p">(</span><span class="n">docs_and_scores</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return docs from docs and scores.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">doc</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">docs_and_scores</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_create_vector_extension</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">Connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">statement</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;SELECT pg_advisory_xact_lock(1573678846307946496);&quot;</span>
        <span class="s2">&quot;CREATE EXTENSION IF NOT EXISTS vector;&quot;</span>
    <span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="n">DBConnection</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">Engine</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>


<div class="viewcode-block" id="PGVector">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector">[docs]</a>
<span class="k">class</span> <span class="nc">PGVector</span><span class="p">(</span><span class="n">VectorStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Postgres vector store integration.</span>

<span class="sd">    Setup:</span>
<span class="sd">        Install ``langchain_postgres`` and run the docker container.</span>

<span class="sd">        .. code-block:: bash</span>

<span class="sd">            pip install -qU langchain-postgres</span>
<span class="sd">            docker run --name pgvector-container -e POSTGRES_USER=langchain -e POSTGRES_PASSWORD=langchain -e POSTGRES_DB=langchain -p 6024:5432 -d pgvector/pgvector:pg16</span>

<span class="sd">    Key init args â€” indexing params:</span>
<span class="sd">        collection_name: str</span>
<span class="sd">            Name of the collection.</span>
<span class="sd">        embeddings: Embeddings</span>
<span class="sd">            Embedding function to use.</span>

<span class="sd">    Key init args â€” client params:</span>
<span class="sd">        connection: Union[None, DBConnection, Engine, AsyncEngine, str]</span>
<span class="sd">            Connection string or engine.</span>

<span class="sd">    Instantiate:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            from langchain_postgres import PGVector</span>
<span class="sd">            from langchain_postgres.vectorstores import PGVector</span>
<span class="sd">            from langchain_openai import OpenAIEmbeddings</span>

<span class="sd">            # See docker command above to launch a postgres instance with pgvector enabled.</span>
<span class="sd">            connection = &quot;postgresql+psycopg://langchain:langchain@localhost:6024/langchain&quot;  # Uses psycopg3!</span>
<span class="sd">            collection_name = &quot;my_docs&quot;</span>

<span class="sd">            vector_store = PGVector(</span>
<span class="sd">                embeddings=OpenAIEmbeddings(model=&quot;text-embedding-3-large&quot;),</span>
<span class="sd">                collection_name=collection_name,</span>
<span class="sd">                connection=connection,</span>
<span class="sd">                use_jsonb=True,</span>
<span class="sd">            )</span>

<span class="sd">    Add Documents:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            from langchain_core.documents import Document</span>

<span class="sd">            document_1 = Document(page_content=&quot;foo&quot;, metadata={&quot;baz&quot;: &quot;bar&quot;})</span>
<span class="sd">            document_2 = Document(page_content=&quot;thud&quot;, metadata={&quot;bar&quot;: &quot;baz&quot;})</span>
<span class="sd">            document_3 = Document(page_content=&quot;i will be deleted :(&quot;)</span>

<span class="sd">            documents = [document_1, document_2, document_3]</span>
<span class="sd">            ids = [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;]</span>
<span class="sd">            vector_store.add_documents(documents=documents, ids=ids)</span>

<span class="sd">    Delete Documents:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            vector_store.delete(ids=[&quot;3&quot;])</span>

<span class="sd">    Search:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            results = vector_store.similarity_search(query=&quot;thud&quot;,k=1)</span>
<span class="sd">            for doc in results:</span>
<span class="sd">                print(f&quot;* {doc.page_content} [{doc.metadata}]&quot;)</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            * thud [{&#39;bar&#39;: &#39;baz&#39;}]</span>

<span class="sd">    Search with filter:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            results = vector_store.similarity_search(query=&quot;thud&quot;,k=1,filter={&quot;bar&quot;: &quot;baz&quot;})</span>
<span class="sd">            for doc in results:</span>
<span class="sd">                print(f&quot;* {doc.page_content} [{doc.metadata}]&quot;)</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            * thud [{&#39;bar&#39;: &#39;baz&#39;}]</span>

<span class="sd">    Search with score:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            results = vector_store.similarity_search_with_score(query=&quot;qux&quot;,k=1)</span>
<span class="sd">            for doc, score in results:</span>
<span class="sd">                print(f&quot;* [SIM={score:3f}] {doc.page_content} [{doc.metadata}]&quot;)</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            * [SIM=0.499243] foo [{&#39;baz&#39;: &#39;bar&#39;}]</span>

<span class="sd">    Async:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            # add documents</span>
<span class="sd">            # await vector_store.aadd_documents(documents=documents, ids=ids)</span>

<span class="sd">            # delete documents</span>
<span class="sd">            # await vector_store.adelete(ids=[&quot;3&quot;])</span>

<span class="sd">            # search</span>
<span class="sd">            # results = vector_store.asimilarity_search(query=&quot;thud&quot;,k=1)</span>

<span class="sd">            # search with score</span>
<span class="sd">            results = await vector_store.asimilarity_search_with_score(query=&quot;qux&quot;,k=1)</span>
<span class="sd">            for doc,score in results:</span>
<span class="sd">                print(f&quot;* [SIM={score:3f}] {doc.page_content} [{doc.metadata}]&quot;)</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            * [SIM=0.499243] foo [{&#39;baz&#39;: &#39;bar&#39;}]</span>

<span class="sd">    Use as Retriever:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            retriever = vector_store.as_retriever(</span>
<span class="sd">                search_type=&quot;mmr&quot;,</span>
<span class="sd">                search_kwargs={&quot;k&quot;: 1, &quot;fetch_k&quot;: 2, &quot;lambda_mult&quot;: 0.5},</span>
<span class="sd">            )</span>
<span class="sd">            retriever.invoke(&quot;thud&quot;)</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            [Document(metadata={&#39;bar&#39;: &#39;baz&#39;}, page_content=&#39;thud&#39;)]</span>

<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>

<div class="viewcode-block" id="PGVector.__init__">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embeddings</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">connection</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">DBConnection</span><span class="p">,</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">AsyncEngine</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">embedding_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">collection_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">relevance_score_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">engine_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_jsonb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">create_extension</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">async_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the PGVector store.</span>
<span class="sd">        For an async version, use `PGVector.acreate()` instead.</span>

<span class="sd">        Args:</span>
<span class="sd">            connection: Postgres connection string or (async)engine.</span>
<span class="sd">            embeddings: Any embedding function implementing</span>
<span class="sd">                `langchain.embeddings.base.Embeddings` interface.</span>
<span class="sd">            embedding_length: The length of the embedding vector. (default: None)</span>
<span class="sd">                NOTE: This is not mandatory. Defining it will prevent vectors of</span>
<span class="sd">                any other size to be added to the embeddings table but, without it,</span>
<span class="sd">                the embeddings can&#39;t be indexed.</span>
<span class="sd">            collection_name: The name of the collection to use. (default: langchain)</span>
<span class="sd">                NOTE: This is not the name of the table, but the name of the collection.</span>
<span class="sd">                The tables will be created when initializing the store (if not exists)</span>
<span class="sd">                So, make sure the user has the right permissions to create tables.</span>
<span class="sd">            distance_strategy: The distance strategy to use. (default: COSINE)</span>
<span class="sd">            pre_delete_collection: If True, will delete the collection if it exists.</span>
<span class="sd">                (default: False). Useful for testing.</span>
<span class="sd">            engine_args: SQLAlchemy&#39;s create engine arguments.</span>
<span class="sd">            use_jsonb: Use JSONB instead of JSON for metadata. (default: True)</span>
<span class="sd">                Strongly discouraged from using JSON as it&#39;s not as efficient</span>
<span class="sd">                for querying.</span>
<span class="sd">                It&#39;s provided here for backwards compatibility with older versions,</span>
<span class="sd">                and will be removed in the future.</span>
<span class="sd">            create_extension: If True, will create the vector extension if it</span>
<span class="sd">                doesn&#39;t exist. disabling creation is useful when using ReadOnly</span>
<span class="sd">                Databases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_mode</span> <span class="o">=</span> <span class="n">async_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span> <span class="o">=</span> <span class="n">embeddings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_length</span> <span class="o">=</span> <span class="n">embedding_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_metadata</span> <span class="o">=</span> <span class="n">collection_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_distance_strategy</span> <span class="o">=</span> <span class="n">distance_strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_delete_collection</span> <span class="o">=</span> <span class="n">pre_delete_collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">override_relevance_score_fn</span> <span class="o">=</span> <span class="n">relevance_score_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Engine</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncEngine</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_async_init</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">async_mode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span>
                    <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">engine_args</span> <span class="ow">or</span> <span class="p">{})</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">engine_args</span> <span class="ow">or</span> <span class="p">{}))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">Engine</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">async_mode</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">AsyncEngine</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">async_mode</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;connection should be a connection string or an instance of &quot;</span>
                <span class="s2">&quot;sqlalchemy.engine.Engine or sqlalchemy.ext.asyncio.engine.AsyncEngine&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_maker</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">scoped_session</span><span class="p">,</span> <span class="n">async_sessionmaker</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_maker</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_maker</span> <span class="o">=</span> <span class="n">scoped_session</span><span class="p">(</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_jsonb</span> <span class="o">=</span> <span class="n">use_jsonb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_extension</span> <span class="o">=</span> <span class="n">create_extension</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_jsonb</span><span class="p">:</span>
            <span class="c1"># Replace with a deprecation warning.</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;use_jsonb=False is no longer supported.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the store.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_extension</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_vector_extension</span><span class="p">()</span>

        <span class="n">EmbeddingStore</span><span class="p">,</span> <span class="n">CollectionStore</span> <span class="o">=</span> <span class="n">_get_embedding_collection_store</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_length</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CollectionStore</span> <span class="o">=</span> <span class="n">CollectionStore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span> <span class="o">=</span> <span class="n">EmbeddingStore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_tables_if_not_exists</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_collection</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__apost_init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Async initialize the store (use lazy approach).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_init</span><span class="p">:</span>  <span class="c1"># Warning: possible race condition</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_async_init</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">EmbeddingStore</span><span class="p">,</span> <span class="n">CollectionStore</span> <span class="o">=</span> <span class="n">_get_embedding_collection_store</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_length</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CollectionStore</span> <span class="o">=</span> <span class="n">CollectionStore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span> <span class="o">=</span> <span class="n">EmbeddingStore</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_extension</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">acreate_vector_extension</span><span class="p">()</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">acreate_tables_if_not_exists</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">acreate_collection</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Embeddings</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span>

<div class="viewcode-block" id="PGVector.create_vector_extension">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.create_vector_extension">[docs]</a>
    <span class="k">def</span> <span class="nf">create_vector_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span> <span class="s2">&quot;engine not found&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">_create_vector_extension</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create vector extension: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>


<div class="viewcode-block" id="PGVector.acreate_vector_extension">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.acreate_vector_extension">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acreate_vector_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;_async_engine not found&quot;</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">_create_vector_extension</span><span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.create_tables_if_not_exists">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.create_tables_if_not_exists">[docs]</a>
    <span class="k">def</span> <span class="nf">create_tables_if_not_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_sync_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get_bind</span><span class="p">())</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="PGVector.acreate_tables_if_not_exists">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.acreate_tables_if_not_exists">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acreate_tables_if_not_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called with async_mode&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.drop_tables">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.drop_tables">[docs]</a>
    <span class="k">def</span> <span class="nf">drop_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_sync_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get_bind</span><span class="p">())</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="PGVector.adrop_tables">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.adrop_tables">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">adrop_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called with async_mode&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.create_collection">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.create_collection">[docs]</a>
    <span class="k">def</span> <span class="nf">create_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_delete_collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_collection</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_sync_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CollectionStore</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">cmetadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_metadata</span>
            <span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="PGVector.acreate_collection">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.acreate_collection">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acreate_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_async_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_delete_collection</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adelete_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectionStore</span><span class="o">.</span><span class="n">aget_or_create</span><span class="p">(</span>
                <span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span> <span class="n">cmetadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_metadata</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_delete_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Collection not found&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_adelete_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aget_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Collection not found&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>

<div class="viewcode-block" id="PGVector.delete_collection">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.delete_collection">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_sync_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Collection not found&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="PGVector.adelete_collection">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.adelete_collection">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">adelete_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_async_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aget_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Collection not found&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="PGVector.delete">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.delete">[docs]</a>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete vectors by ids or uuids.</span>

<span class="sd">        Args:</span>
<span class="sd">            ids: List of ids to delete.</span>
<span class="sd">            collection_only: Only delete ids in the collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_sync_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Trying to delete vectors by ids (represented by the model &quot;</span>
                    <span class="s2">&quot;using the custom ids field)&quot;</span>
                <span class="p">)</span>

                <span class="n">stmt</span> <span class="o">=</span> <span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">collection_only</span><span class="p">:</span>
                    <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Collection not found&quot;</span><span class="p">)</span>
                        <span class="k">return</span>

                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">uuid</span>
                    <span class="p">)</span>

                <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="PGVector.adelete">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.adelete">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">adelete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Async delete vectors by ids or uuids.</span>

<span class="sd">        Args:</span>
<span class="sd">            ids: List of ids to delete.</span>
<span class="sd">            collection_only: Only delete ids in the collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_async_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Trying to delete vectors by ids (represented by the model &quot;</span>
                    <span class="s2">&quot;using the custom ids field)&quot;</span>
                <span class="p">)</span>

                <span class="n">stmt</span> <span class="o">=</span> <span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">collection_only</span><span class="p">:</span>
                    <span class="n">collection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aget_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Collection not found&quot;</span><span class="p">)</span>
                        <span class="k">return</span>

                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">uuid</span>
                    <span class="p">)</span>

                <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="PGVector.get_collection">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.get_collection">[docs]</a>
    <span class="k">def</span> <span class="nf">get_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called without async_mode&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectionStore</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.aget_collection">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.aget_collection">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">aget_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called with async_mode&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectionStore</span><span class="o">.</span><span class="n">aget_by_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">)</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__from</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">embeddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">use_jsonb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PGVector</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadatas</span><span class="p">:</span>
            <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>

        <span class="n">store</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">embeddings</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">distance_strategy</span><span class="o">=</span><span class="n">distance_strategy</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="n">use_jsonb</span><span class="o">=</span><span class="n">use_jsonb</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">store</span><span class="o">.</span><span class="n">add_embeddings</span><span class="p">(</span>
            <span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span> <span class="n">embeddings</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">store</span>

    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">__afrom</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">embeddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">use_jsonb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PGVector</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadatas</span><span class="p">:</span>
            <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>

        <span class="n">store</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">embeddings</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">distance_strategy</span><span class="o">=</span><span class="n">distance_strategy</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="n">use_jsonb</span><span class="o">=</span><span class="n">use_jsonb</span><span class="p">,</span>
            <span class="n">async_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">await</span> <span class="n">store</span><span class="o">.</span><span class="n">aadd_embeddings</span><span class="p">(</span>
            <span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span> <span class="n">embeddings</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">store</span>

<div class="viewcode-block" id="PGVector.add_embeddings">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.add_embeddings">[docs]</a>
    <span class="k">def</span> <span class="nf">add_embeddings</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">embeddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add embeddings to the vectorstore.</span>

<span class="sd">        Args:</span>
<span class="sd">            texts: Iterable of strings to add to the vectorstore.</span>
<span class="sd">            embeddings: List of list of embedding vectors.</span>
<span class="sd">            metadatas: List of metadatas associated with the texts.</span>
<span class="sd">            ids: Optional list of ids for the documents.</span>
<span class="sd">                 If not provided, will generate a new id for each document.</span>
<span class="sd">            kwargs: vectorstore specific parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called with sync_mode&quot;</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadatas</span><span class="p">:</span>
            <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_sync_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Collection not found&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span>
                    <span class="s2">&quot;collection_id&quot;</span><span class="p">:</span> <span class="n">collection</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                    <span class="s2">&quot;embedding&quot;</span><span class="p">:</span> <span class="n">embedding</span><span class="p">,</span>
                    <span class="s2">&quot;document&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
                    <span class="s2">&quot;cmetadata&quot;</span><span class="p">:</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{},</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">embedding</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">texts</span><span class="p">,</span> <span class="n">metadatas</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">ids</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">on_conflict_stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">on_conflict_do_update</span><span class="p">(</span>
                <span class="n">index_elements</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="c1"># Conflict detection based on these columns</span>
                <span class="n">set_</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;embedding&quot;</span><span class="p">:</span> <span class="n">stmt</span><span class="o">.</span><span class="n">excluded</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
                    <span class="s2">&quot;document&quot;</span><span class="p">:</span> <span class="n">stmt</span><span class="o">.</span><span class="n">excluded</span><span class="o">.</span><span class="n">document</span><span class="p">,</span>
                    <span class="s2">&quot;cmetadata&quot;</span><span class="p">:</span> <span class="n">stmt</span><span class="o">.</span><span class="n">excluded</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">on_conflict_stmt</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ids</span></div>


<div class="viewcode-block" id="PGVector.aadd_embeddings">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.aadd_embeddings">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">aadd_embeddings</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">embeddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Async add embeddings to the vectorstore.</span>

<span class="sd">        Args:</span>
<span class="sd">            texts: Iterable of strings to add to the vectorstore.</span>
<span class="sd">            embeddings: List of list of embedding vectors.</span>
<span class="sd">            metadatas: List of metadatas associated with the texts.</span>
<span class="sd">            ids: Optional list of ids for the texts.</span>
<span class="sd">                 If not provided, will generate a new id for each text.</span>
<span class="sd">            kwargs: vectorstore specific parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metadatas</span><span class="p">:</span>
            <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_async_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aget_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Collection not found&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span>
                    <span class="s2">&quot;collection_id&quot;</span><span class="p">:</span> <span class="n">collection</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                    <span class="s2">&quot;embedding&quot;</span><span class="p">:</span> <span class="n">embedding</span><span class="p">,</span>
                    <span class="s2">&quot;document&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
                    <span class="s2">&quot;cmetadata&quot;</span><span class="p">:</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{},</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">embedding</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">texts</span><span class="p">,</span> <span class="n">metadatas</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">ids</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">on_conflict_stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">on_conflict_do_update</span><span class="p">(</span>
                <span class="n">index_elements</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                <span class="c1"># Conflict detection based on these columns</span>
                <span class="n">set_</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;embedding&quot;</span><span class="p">:</span> <span class="n">stmt</span><span class="o">.</span><span class="n">excluded</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
                    <span class="s2">&quot;document&quot;</span><span class="p">:</span> <span class="n">stmt</span><span class="o">.</span><span class="n">excluded</span><span class="o">.</span><span class="n">document</span><span class="p">,</span>
                    <span class="s2">&quot;cmetadata&quot;</span><span class="p">:</span> <span class="n">stmt</span><span class="o">.</span><span class="n">excluded</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">on_conflict_stmt</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ids</span></div>


<div class="viewcode-block" id="PGVector.similarity_search">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.similarity_search">[docs]</a>
    <span class="k">def</span> <span class="nf">similarity_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run similarity search with PGVector with distance.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str): Query text to search for.</span>
<span class="sd">            k (int): Number of results to return. Defaults to 4.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Documents most similar to the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called without async_mode&quot;</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_search_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.asimilarity_search">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.asimilarity_search">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">asimilarity_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run similarity search with PGVector with distance.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str): Query text to search for.</span>
<span class="sd">            k (int): Number of results to return. Defaults to 4.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Documents most similar to the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">asimilarity_search_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.similarity_search_with_score">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.similarity_search_with_score">[docs]</a>
    <span class="k">def</span> <span class="nf">similarity_search_with_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs most similar to query.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Text to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Documents most similar to the query and score for each.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called without async_mode&quot;</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_search_with_score_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">docs</span></div>


<div class="viewcode-block" id="PGVector.asimilarity_search_with_score">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.asimilarity_search_with_score">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">asimilarity_search_with_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs most similar to query.</span>

<span class="sd">        Args:</span>
<span class="sd">            query: Text to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Documents most similar to the query and score for each.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">asimilarity_search_with_score_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">docs</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">distance_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_strategy</span> <span class="o">==</span> <span class="n">DistanceStrategy</span><span class="o">.</span><span class="n">EUCLIDEAN</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">l2_distance</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_strategy</span> <span class="o">==</span> <span class="n">DistanceStrategy</span><span class="o">.</span><span class="n">COSINE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">cosine_distance</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_strategy</span> <span class="o">==</span> <span class="n">DistanceStrategy</span><span class="o">.</span><span class="n">MAX_INNER_PRODUCT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">max_inner_product</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Got unexpected value for distance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_distance_strategy</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Should be one of </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ds</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ds</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">DistanceStrategy</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="PGVector.similarity_search_with_score_by_vector">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.similarity_search_with_score_by_vector">[docs]</a>
    <span class="k">def</span> <span class="nf">similarity_search_with_score_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called without async_mode&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query_collection</span><span class="p">(</span><span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_to_docs_and_scores</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.asimilarity_search_with_score_by_vector">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.asimilarity_search_with_score_by_vector">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">asimilarity_search_with_score_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_async_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__aquery_collection</span><span class="p">(</span>
                <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_to_docs_and_scores</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_results_to_docs_and_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs and scores from results.&quot;&quot;&quot;</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">Document</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                    <span class="n">page_content</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">document</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">result</span><span class="o">.</span><span class="n">distance</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">docs</span>

    <span class="k">def</span> <span class="nf">_handle_field_filter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SQLColumnExpression</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a filter for a specific field.</span>

<span class="sd">        Args:</span>
<span class="sd">            field: name of field</span>
<span class="sd">            value: value to filter</span>
<span class="sd">                If provided as is then this will be an equality filter</span>
<span class="sd">                If provided as a dictionary then this will be a filter, the key</span>
<span class="sd">                will be the operator and the value will be the value to filter by</span>

<span class="sd">        Returns:</span>
<span class="sd">            sqlalchemy expression</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;field should be a string but got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="si">}</span><span class="s2"> with value: </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid filter condition. Expected a field but got an operator: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Allow [a-zA-Z0-9_], disallow $ for now until we support escape characters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid field name: </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">. Expected a valid identifier.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># This is a filter specification</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid filter condition. Expected a value which &quot;</span>
                    <span class="s2">&quot;is a dictionary with a single key that corresponds to an operator &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;but got a dictionary with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2"> keys. The first few &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;keys are: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">operator</span><span class="p">,</span> <span class="n">filter_value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Verify that that operator is an operator</span>
            <span class="k">if</span> <span class="n">operator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_OPERATORS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid operator: </span><span class="si">{</span><span class="n">operator</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected one of </span><span class="si">{</span><span class="n">SUPPORTED_OPERATORS</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Then we assume an equality operator</span>
            <span class="n">operator</span> <span class="o">=</span> <span class="s2">&quot;$eq&quot;</span>
            <span class="n">filter_value</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">COMPARISONS_TO_NATIVE</span><span class="p">:</span>
            <span class="c1"># Then we implement an equality filter</span>
            <span class="c1"># native is trusted input</span>
            <span class="n">native</span> <span class="o">=</span> <span class="n">COMPARISONS_TO_NATIVE</span><span class="p">[</span><span class="n">operator</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">jsonb_path_match</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">,</span>
                <span class="n">cast</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">native</span><span class="si">}</span><span class="s2"> $value&quot;</span><span class="p">,</span> <span class="n">JSONPATH</span><span class="p">),</span>
                <span class="n">cast</span><span class="p">({</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">filter_value</span><span class="p">},</span> <span class="n">JSONB</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s2">&quot;$between&quot;</span><span class="p">:</span>
            <span class="c1"># Use AND with two comparisons</span>
            <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">filter_value</span>

            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">jsonb_path_match</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">,</span>
                <span class="n">cast</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> &gt;= $value&quot;</span><span class="p">,</span> <span class="n">JSONPATH</span><span class="p">),</span>
                <span class="n">cast</span><span class="p">({</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">low</span><span class="p">},</span> <span class="n">JSONB</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">jsonb_path_match</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">,</span>
                <span class="n">cast</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> &lt;= $value&quot;</span><span class="p">,</span> <span class="n">JSONPATH</span><span class="p">),</span>
                <span class="n">cast</span><span class="p">({</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">high</span><span class="p">},</span> <span class="n">JSONB</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">,</span> <span class="s2">&quot;$nin&quot;</span><span class="p">,</span> <span class="s2">&quot;$like&quot;</span><span class="p">,</span> <span class="s2">&quot;$ilike&quot;</span><span class="p">}:</span>
            <span class="c1"># We&#39;ll do force coercion to text</span>
            <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">,</span> <span class="s2">&quot;$nin&quot;</span><span class="p">}:</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">filter_value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Unsupported type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s2"> for value: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>  <span class="c1"># b/c bool is an instance of int</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Unsupported type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s2"> for value: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

            <span class="n">queried_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span>

            <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="n">queried_field</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">filter_value</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;$nin&quot;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="o">~</span><span class="n">queried_field</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">filter_value</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;$like&quot;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="n">queried_field</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">filter_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;$ilike&quot;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="n">queried_field</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="n">filter_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s2">&quot;$exists&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Expected a boolean value for $exists &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;operator, but got: </span><span class="si">{</span><span class="n">filter_value</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">jsonb_exists</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">,</span>
                <span class="n">field</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">condition</span> <span class="k">if</span> <span class="n">filter_value</span> <span class="k">else</span> <span class="o">~</span><span class="n">condition</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_filter_clause_deprecated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  <span class="c1"># type: ignore[no-untyped-def]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deprecated functionality.</span>

<span class="sd">        This is for backwards compatibility with the JSON based schema for metadata.</span>
<span class="sd">        It uses incorrect operator syntax (operators are not prefixed with $).</span>

<span class="sd">        This implementation is not efficient, and has bugs associated with</span>
<span class="sd">        the way that it handles numeric filter clauses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">IN</span><span class="p">,</span> <span class="n">NIN</span><span class="p">,</span> <span class="n">BETWEEN</span><span class="p">,</span> <span class="n">GT</span><span class="p">,</span> <span class="n">LT</span><span class="p">,</span> <span class="n">NE</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;nin&quot;</span><span class="p">,</span> <span class="s2">&quot;between&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="s2">&quot;ne&quot;</span>
        <span class="n">EQ</span><span class="p">,</span> <span class="n">LIKE</span><span class="p">,</span> <span class="n">CONTAINS</span><span class="p">,</span> <span class="n">OR</span><span class="p">,</span> <span class="n">AND</span> <span class="o">=</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="s2">&quot;like&quot;</span><span class="p">,</span> <span class="s2">&quot;contains&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">,</span> <span class="s2">&quot;and&quot;</span>

        <span class="n">value_case_insensitive</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">IN</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
                <span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">IN</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">NIN</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span><span class="o">.</span><span class="n">not_in</span><span class="p">(</span>
                <span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">NIN</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">BETWEEN</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span><span class="o">.</span><span class="n">between</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">BETWEEN</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">BETWEEN</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">GT</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span> <span class="o">&gt;</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">GT</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">LT</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span> <span class="o">&lt;</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">LT</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">NE</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">NE</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">EQ</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">EQ</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">LIKE</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span><span class="o">.</span><span class="n">like</span><span class="p">(</span>
                <span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">LIKE</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">CONTAINS</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
                <span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">CONTAINS</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">OR</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">or_clauses</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sub_value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">OR</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span><span class="o">*</span><span class="n">or_clauses</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">AND</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="n">and_clauses</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sub_value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub_value</span> <span class="ow">in</span> <span class="n">value_case_insensitive</span><span class="p">[</span><span class="n">AND</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">and_clauses</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">filter_by_metadata</span>

    <span class="k">def</span> <span class="nf">_create_filter_clause_json_deprecated</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SQLColumnExpression</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert filters from IR to SQL clauses.</span>

<span class="sd">        **DEPRECATED** This functionality will be deprecated in the future.</span>

<span class="sd">        It implements translation of filters for a schema that uses JSON</span>
<span class="sd">        for metadata rather than the JSONB field which is more efficient</span>
<span class="sd">        for querying.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filter_clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">filter</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause_deprecated</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">filter_by_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">filter_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_by_metadata</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filter_by_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="n">value</span>
                <span class="p">)</span>
                <span class="n">filter_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_by_metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filter_clauses</span>

    <span class="k">def</span> <span class="nf">_create_filter_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert LangChain IR filter representation to matching SQLAlchemy clauses.</span>

<span class="sd">        At the top level, we still don&#39;t know if we&#39;re working with a field</span>
<span class="sd">        or an operator for the keys. After we&#39;ve determined that we can</span>
<span class="sd">        call the appropriate logic to handle filter creation.</span>

<span class="sd">        Args:</span>
<span class="sd">            filters: Dictionary of filters to apply to the query.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SQLAlchemy clause to apply to the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># The only operators allowed at the top level are $AND, $OR, and $NOT</span>
                <span class="c1"># First check if an operator or a field</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">):</span>
                    <span class="c1"># Then it&#39;s an operator</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">,</span> <span class="s2">&quot;$or&quot;</span><span class="p">,</span> <span class="s2">&quot;$not&quot;</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Invalid filter condition. Expected $and, $or or $not &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;but got: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Then it&#39;s a field</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_field_filter</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">filters</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;$and&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Expected a list, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2"> for value: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="n">and_</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">and_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">and_</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">and_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">and_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Invalid filter condition. Expected a dictionary &quot;</span>
                            <span class="s2">&quot;but got an empty dictionary&quot;</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;$or&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Expected a list, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2"> for value: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="n">or_</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span><span class="o">*</span><span class="n">or_</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">or_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">or_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Invalid filter condition. Expected a dictionary &quot;</span>
                            <span class="s2">&quot;but got an empty dictionary&quot;</span>
                        <span class="p">)</span>
                <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;$not&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">not_conditions</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span>
                        <span class="p">]</span>
                        <span class="n">not_</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span>
                            <span class="o">*</span><span class="p">[</span>
                                <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">not_</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">not_conditions</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="n">not_</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">not_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">not_</span><span class="p">(</span><span class="n">not_</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Invalid filter condition. Expected a dictionary &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;or a list but got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid filter condition. Expected $and, $or or $not &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;but got: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Then all keys have to be fields (they cannot be operators)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Invalid filter condition. Expected a field but got: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="c1"># These should all be fields and combined using an $and operator</span>
                <span class="n">and_</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_field_filter</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">and_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">and_</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">and_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">and_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Invalid filter condition. Expected a dictionary &quot;</span>
                        <span class="s2">&quot;but got an empty dictionary&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Got an empty dictionary for filters.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid type: Expected a dictionary but got type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__query_collection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query the collection.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_sync_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Collection not found&quot;</span><span class="p">)</span>

            <span class="n">filter_by</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_jsonb</span><span class="p">:</span>
                    <span class="n">filter_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">filter_clauses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">filter_by</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_clauses</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Old way of doing things</span>
                    <span class="n">filter_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause_json_deprecated</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
                    <span class="n">filter_by</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filter_clauses</span><span class="p">)</span>

            <span class="n">_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">distance_strategy</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">filter_by</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">asc</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CollectionStore</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectionStore</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__aquery_collection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query the collection.&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_async_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aget_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Collection not found&quot;</span><span class="p">)</span>

            <span class="n">filter_by</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_jsonb</span><span class="p">:</span>
                    <span class="n">filter_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">filter_clauses</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">filter_by</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_clauses</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Old way of doing things</span>
                    <span class="n">filter_clauses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_filter_clause_json_deprecated</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
                    <span class="n">filter_by</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filter_clauses</span><span class="p">)</span>

            <span class="n">_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span>

            <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">select</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">distance_strategy</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">filter_by</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">asc</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CollectionStore</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectionStore</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="PGVector.similarity_search_by_vector">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.similarity_search_by_vector">[docs]</a>
    <span class="k">def</span> <span class="nf">similarity_search_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs most similar to embedding vector.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Documents most similar to the query vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called without async_mode&quot;</span>
        <span class="n">docs_and_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_search_with_score_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_results_to_docs</span><span class="p">(</span><span class="n">docs_and_scores</span><span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.asimilarity_search_by_vector">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.asimilarity_search_by_vector">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">asimilarity_search_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs most similar to embedding vector.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k: Number of Documents to return. Defaults to 4.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Documents most similar to the query vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called with async_mode&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="n">docs_and_scores</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">asimilarity_search_with_score_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_results_to_docs</span><span class="p">(</span><span class="n">docs_and_scores</span><span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.from_texts">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.from_texts">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_texts</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">PGVector</span><span class="p">],</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_jsonb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PGVector</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return VectorStore initialized from documents and embeddings.&quot;&quot;&quot;</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embedding</span><span class="o">.</span><span class="n">embed_documents</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__from</span><span class="p">(</span>
            <span class="n">texts</span><span class="p">,</span>
            <span class="n">embeddings</span><span class="p">,</span>
            <span class="n">embedding</span><span class="p">,</span>
            <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">distance_strategy</span><span class="o">=</span><span class="n">distance_strategy</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="n">use_jsonb</span><span class="o">=</span><span class="n">use_jsonb</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.afrom_texts">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.afrom_texts">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">afrom_texts</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">PGVector</span><span class="p">],</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">use_jsonb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PGVector</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return VectorStore initialized from documents and embeddings.&quot;&quot;&quot;</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embedding</span><span class="o">.</span><span class="n">embed_documents</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__afrom</span><span class="p">(</span>
            <span class="n">texts</span><span class="p">,</span>
            <span class="n">embeddings</span><span class="p">,</span>
            <span class="n">embedding</span><span class="p">,</span>
            <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">distance_strategy</span><span class="o">=</span><span class="n">distance_strategy</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="n">use_jsonb</span><span class="o">=</span><span class="n">use_jsonb</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.from_embeddings">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.from_embeddings">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_embeddings</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">text_embeddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PGVector</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct PGVector wrapper from raw documents and embeddings.</span>

<span class="sd">        Args:</span>
<span class="sd">            text_embeddings: List of tuples of text and embeddings.</span>
<span class="sd">            embedding: Embeddings object.</span>
<span class="sd">            metadatas: Optional list of metadatas associated with the texts.</span>
<span class="sd">            collection_name: Name of the collection.</span>
<span class="sd">            distance_strategy: Distance strategy to use.</span>
<span class="sd">            ids: Optional list of ids for the documents.</span>
<span class="sd">                 If not provided, will generate a new id for each document.</span>
<span class="sd">            pre_delete_collection: If True, will delete the collection if it exists.</span>
<span class="sd">                **Attention**: This will delete all the documents in the existing</span>
<span class="sd">                collection.</span>
<span class="sd">            kwargs: Additional arguments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PGVector: PGVector instance.</span>

<span class="sd">        Example:</span>
<span class="sd">            .. code-block:: python</span>

<span class="sd">                from langchain_postgres.vectorstores import PGVector</span>
<span class="sd">                from langchain_openai.embeddings import OpenAIEmbeddings</span>

<span class="sd">                embeddings = OpenAIEmbeddings()</span>
<span class="sd">                text_embeddings = embeddings.embed_documents(texts)</span>
<span class="sd">                text_embedding_pairs = list(zip(texts, text_embeddings))</span>
<span class="sd">                vectorstore = PGVector.from_embeddings(text_embedding_pairs, embeddings)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text_embeddings</span><span class="p">]</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text_embeddings</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__from</span><span class="p">(</span>
            <span class="n">texts</span><span class="p">,</span>
            <span class="n">embeddings</span><span class="p">,</span>
            <span class="n">embedding</span><span class="p">,</span>
            <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">distance_strategy</span><span class="o">=</span><span class="n">distance_strategy</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.afrom_embeddings">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.afrom_embeddings">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">afrom_embeddings</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">text_embeddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PGVector</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct PGVector wrapper from raw documents and pre-</span>
<span class="sd">        generated embeddings.</span>

<span class="sd">        Return VectorStore initialized from documents and embeddings.</span>
<span class="sd">        Postgres connection string is required</span>
<span class="sd">        &quot;Either pass it as a parameter</span>
<span class="sd">        or set the PGVECTOR_CONNECTION_STRING environment variable.</span>

<span class="sd">        Example:</span>
<span class="sd">            .. code-block:: python</span>

<span class="sd">                from langchain_community.vectorstores import PGVector</span>
<span class="sd">                from langchain_community.embeddings import OpenAIEmbeddings</span>
<span class="sd">                embeddings = OpenAIEmbeddings()</span>
<span class="sd">                text_embeddings = embeddings.embed_documents(texts)</span>
<span class="sd">                text_embedding_pairs = list(zip(texts, text_embeddings))</span>
<span class="sd">                faiss = PGVector.from_embeddings(text_embedding_pairs, embeddings)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text_embeddings</span><span class="p">]</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text_embeddings</span><span class="p">]</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__afrom</span><span class="p">(</span>
            <span class="n">texts</span><span class="p">,</span>
            <span class="n">embeddings</span><span class="p">,</span>
            <span class="n">embedding</span><span class="p">,</span>
            <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">distance_strategy</span><span class="o">=</span><span class="n">distance_strategy</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.from_existing_index">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.from_existing_index">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_existing_index</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">PGVector</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DBConnection</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PGVector</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get instance of an existing PGVector store.This method will</span>
<span class="sd">        return the instance of the store without inserting any new</span>
<span class="sd">        embeddings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">store</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">embeddings</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">distance_strategy</span><span class="o">=</span><span class="n">distance_strategy</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">store</span></div>


<div class="viewcode-block" id="PGVector.afrom_existing_index">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.afrom_existing_index">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">afrom_existing_index</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">PGVector</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DBConnection</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PGVector</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get instance of an existing PGVector store.This method will</span>
<span class="sd">        return the instance of the store without inserting any new</span>
<span class="sd">        embeddings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">PGVector</span><span class="p">(</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">embeddings</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">distance_strategy</span><span class="o">=</span><span class="n">distance_strategy</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="n">async_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">store</span></div>


<div class="viewcode-block" id="PGVector.get_connection_string">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.get_connection_string">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_connection_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">connection_string</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">get_from_dict_or_env</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;connection&quot;</span><span class="p">,</span>
            <span class="n">env_key</span><span class="o">=</span><span class="s2">&quot;PGVECTOR_CONNECTION_STRING&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">connection_string</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Postgres connection string is required&quot;</span>
                <span class="s2">&quot;Either pass it as a parameter&quot;</span>
                <span class="s2">&quot;or set the PGVECTOR_CONNECTION_STRING environment variable.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">connection_string</span></div>


<div class="viewcode-block" id="PGVector.from_documents">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.from_documents">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_documents</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">PGVector</span><span class="p">],</span>
        <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DBConnection</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_jsonb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PGVector</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return VectorStore initialized from documents and embeddings.&quot;&quot;&quot;</span>

        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">page_content</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>
        <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_texts</span><span class="p">(</span>
            <span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">distance_strategy</span><span class="o">=</span><span class="n">distance_strategy</span><span class="p">,</span>
            <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span>
            <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">use_jsonb</span><span class="o">=</span><span class="n">use_jsonb</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.afrom_documents">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.afrom_documents">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">afrom_documents</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">PGVector</span><span class="p">],</span>
        <span class="n">documents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">_LANGCHAIN_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">distance_strategy</span><span class="p">:</span> <span class="n">DistanceStrategy</span> <span class="o">=</span> <span class="n">DEFAULT_DISTANCE_STRATEGY</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">use_jsonb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PGVector</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return VectorStore initialized from documents and embeddings.</span>
<span class="sd">        Postgres connection string is required</span>
<span class="sd">        &quot;Either pass it as a parameter</span>
<span class="sd">        or set the PGVECTOR_CONNECTION_STRING environment variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">page_content</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>
        <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">documents</span><span class="p">]</span>
        <span class="n">connection_string</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_connection_string</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;connection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection_string</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">afrom_texts</span><span class="p">(</span>
            <span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">distance_strategy</span><span class="o">=</span><span class="n">distance_strategy</span><span class="p">,</span>
            <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">use_jsonb</span><span class="o">=</span><span class="n">use_jsonb</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.connection_string_from_db_params">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.connection_string_from_db_params">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">connection_string_from_db_params</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">driver</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return connection string from database parameters.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">driver</span> <span class="o">!=</span> <span class="s2">&quot;psycopg&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only psycopg3 driver is supported&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;postgresql+</span><span class="si">{</span><span class="n">driver</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">database</span><span class="si">}</span><span class="s2">&quot;</span></div>


    <span class="k">def</span> <span class="nf">_select_relevance_score_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The &#39;correct&#39; relevance function</span>
<span class="sd">        may differ depending on a few things, including:</span>
<span class="sd">        - the distance / similarity metric used by the VectorStore</span>
<span class="sd">        - the scale of your embeddings (OpenAI&#39;s are unit normed. Many others are not!)</span>
<span class="sd">        - embedding dimensionality</span>
<span class="sd">        - etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">override_relevance_score_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">override_relevance_score_fn</span>

        <span class="c1"># Default strategy is to rely on distance strategy provided</span>
        <span class="c1"># in vectorstore constructor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_strategy</span> <span class="o">==</span> <span class="n">DistanceStrategy</span><span class="o">.</span><span class="n">COSINE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cosine_relevance_score_fn</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_strategy</span> <span class="o">==</span> <span class="n">DistanceStrategy</span><span class="o">.</span><span class="n">EUCLIDEAN</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_euclidean_relevance_score_fn</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distance_strategy</span> <span class="o">==</span> <span class="n">DistanceStrategy</span><span class="o">.</span><span class="n">MAX_INNER_PRODUCT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_inner_product_relevance_score_fn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No supported normalization function&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; for distance_strategy of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_distance_strategy</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="s2">&quot;Consider providing relevance_score_fn to PGVector constructor.&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="PGVector.max_marginal_relevance_search_with_score_by_vector">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.max_marginal_relevance_search_with_score_by_vector">[docs]</a>
    <span class="k">def</span> <span class="nf">max_marginal_relevance_search_with_score_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs selected using the maximal marginal relevance with score</span>
<span class="sd">            to embedding vector.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">            among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k (int): Number of Documents to return. Defaults to 4.</span>
<span class="sd">            fetch_k (int): Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">                Defaults to 20.</span>
<span class="sd">            lambda_mult (float): Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Tuple[Document, float]]: List of Documents selected by maximal marginal</span>
<span class="sd">                relevance to the query and score for each.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">,</span> <span class="s2">&quot;This method must be called without async_mode&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query_collection</span><span class="p">(</span><span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span>

        <span class="n">embedding_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">embedding</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

        <span class="n">mmr_selected</span> <span class="o">=</span> <span class="n">maximal_marginal_relevance</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="n">embedding_list</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_to_docs_and_scores</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mmr_selected</span><span class="p">]</span></div>


<div class="viewcode-block" id="PGVector.amax_marginal_relevance_search_with_score_by_vector">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.amax_marginal_relevance_search_with_score_by_vector">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">amax_marginal_relevance_search_with_score_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs selected using the maximal marginal relevance with score</span>
<span class="sd">            to embedding vector.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">            among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding: Embedding to look up documents similar to.</span>
<span class="sd">            k (int): Number of Documents to return. Defaults to 4.</span>
<span class="sd">            fetch_k (int): Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">                Defaults to 20.</span>
<span class="sd">            lambda_mult (float): Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Tuple[Document, float]]: List of Documents selected by maximal marginal</span>
<span class="sd">                relevance to the query and score for each.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_async_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__aquery_collection</span><span class="p">(</span>
                <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span>
            <span class="p">)</span>

            <span class="n">embedding_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">embedding</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

            <span class="n">mmr_selected</span> <span class="o">=</span> <span class="n">maximal_marginal_relevance</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                <span class="n">embedding_list</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_to_docs_and_scores</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mmr_selected</span><span class="p">]</span></div>


<div class="viewcode-block" id="PGVector.max_marginal_relevance_search">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.max_marginal_relevance_search">[docs]</a>
    <span class="k">def</span> <span class="nf">max_marginal_relevance_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs selected using the maximal marginal relevance.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">            among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str): Text to look up documents similar to.</span>
<span class="sd">            k (int): Number of Documents to return. Defaults to 4.</span>
<span class="sd">            fetch_k (int): Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">                Defaults to 20.</span>
<span class="sd">            lambda_mult (float): Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Document]: List of Documents selected by maximal marginal relevance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_relevance_search_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.amax_marginal_relevance_search">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.amax_marginal_relevance_search">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">amax_marginal_relevance_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs selected using the maximal marginal relevance.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">            among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str): Text to look up documents similar to.</span>
<span class="sd">            k (int): Number of Documents to return. Defaults to 4.</span>
<span class="sd">            fetch_k (int): Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">                Defaults to 20.</span>
<span class="sd">            lambda_mult (float): Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Document]: List of Documents selected by maximal marginal relevance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">amax_marginal_relevance_search_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.max_marginal_relevance_search_with_score">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.max_marginal_relevance_search_with_score">[docs]</a>
    <span class="k">def</span> <span class="nf">max_marginal_relevance_search_with_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs selected using the maximal marginal relevance with score.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">            among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str): Text to look up documents similar to.</span>
<span class="sd">            k (int): Number of Documents to return. Defaults to 4.</span>
<span class="sd">            fetch_k (int): Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">                Defaults to 20.</span>
<span class="sd">            lambda_mult (float): Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Tuple[Document, float]]: List of Documents selected by maximal marginal</span>
<span class="sd">                relevance to the query and score for each.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_relevance_search_with_score_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">docs</span></div>


<div class="viewcode-block" id="PGVector.amax_marginal_relevance_search_with_score">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.amax_marginal_relevance_search_with_score">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">amax_marginal_relevance_search_with_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs selected using the maximal marginal relevance with score.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">            among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str): Text to look up documents similar to.</span>
<span class="sd">            k (int): Number of Documents to return. Defaults to 4.</span>
<span class="sd">            fetch_k (int): Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">                Defaults to 20.</span>
<span class="sd">            lambda_mult (float): Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Tuple[Document, float]]: List of Documents selected by maximal marginal</span>
<span class="sd">                relevance to the query and score for each.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">amax_marginal_relevance_search_with_score_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">docs</span></div>


<div class="viewcode-block" id="PGVector.max_marginal_relevance_search_by_vector">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.max_marginal_relevance_search_by_vector">[docs]</a>
    <span class="k">def</span> <span class="nf">max_marginal_relevance_search_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs selected using the maximal marginal relevance</span>
<span class="sd">            to embedding vector.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">            among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding (str): Text to look up documents similar to.</span>
<span class="sd">            k (int): Number of Documents to return. Defaults to 4.</span>
<span class="sd">            fetch_k (int): Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">                Defaults to 20.</span>
<span class="sd">            lambda_mult (float): Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Document]: List of Documents selected by maximal marginal relevance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">docs_and_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_relevance_search_with_score_by_vector</span><span class="p">(</span>
            <span class="n">embedding</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">_results_to_docs</span><span class="p">(</span><span class="n">docs_and_scores</span><span class="p">)</span></div>


<div class="viewcode-block" id="PGVector.amax_marginal_relevance_search_by_vector">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.amax_marginal_relevance_search_by_vector">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">amax_marginal_relevance_search_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return docs selected using the maximal marginal relevance</span>
<span class="sd">            to embedding vector.</span>

<span class="sd">        Maximal marginal relevance optimizes for similarity to query AND diversity</span>
<span class="sd">            among selected documents.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding (str): Text to look up documents similar to.</span>
<span class="sd">            k (int): Number of Documents to return. Defaults to 4.</span>
<span class="sd">            fetch_k (int): Number of Documents to fetch to pass to MMR algorithm.</span>
<span class="sd">                Defaults to 20.</span>
<span class="sd">            lambda_mult (float): Number between 0 and 1 that determines the degree</span>
<span class="sd">                of diversity among the results with 0 corresponding</span>
<span class="sd">                to maximum diversity and 1 to minimum diversity.</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">            filter (Optional[Dict[str, str]]): Filter by metadata. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Document]: List of Documents selected by maximal marginal relevance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">__apost_init__</span><span class="p">()</span>  <span class="c1"># Lazy async init</span>
        <span class="n">docs_and_scores</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">amax_marginal_relevance_search_with_score_by_vector</span><span class="p">(</span>
                <span class="n">embedding</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
                <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">_results_to_docs</span><span class="p">(</span><span class="n">docs_and_scores</span><span class="p">)</span></div>


    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">_make_sync_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Session</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make an async session.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Attempting to use a sync method in when async mode is turned on. &quot;</span>
                <span class="s2">&quot;Please use the corresponding async method instead.&quot;</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_maker</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">typing_cast</span><span class="p">(</span><span class="n">Session</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_make_async_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make an async session.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Attempting to use an async method in when sync mode is turned on. &quot;</span>
                <span class="s2">&quot;Please use the corresponding async method instead.&quot;</span>
            <span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_maker</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">typing_cast</span><span class="p">(</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

<div class="viewcode-block" id="PGVector.upsert">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.upsert">[docs]</a>
    <span class="k">def</span> <span class="nf">upsert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Document</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UpsertResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upsert documents into the vectorstore.</span>

<span class="sd">        Args:</span>
<span class="sd">            items: Sequence of documents to upsert.</span>
<span class="sd">            kwargs: vectorstore specific parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            UpsertResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;This method must be called in sync mode.&quot;</span><span class="p">)</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">page_content</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span><span class="o">.</span><span class="n">embed_documents</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span>
        <span class="n">added_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_embeddings</span><span class="p">(</span>
            <span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span> <span class="n">embeddings</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;succeeded&quot;</span><span class="p">:</span> <span class="n">added_ids</span><span class="p">,</span>
            <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">item</span><span class="o">.</span><span class="n">id</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">added_ids</span>
            <span class="p">],</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="PGVector.aupsert">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.aupsert">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">aupsert</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Document</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UpsertResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upsert documents into the vectorstore.</span>

<span class="sd">        Args:</span>
<span class="sd">            items: Sequence of documents to upsert.</span>
<span class="sd">            kwargs: vectorstore specific parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">            UpsertResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_engine</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;This method must be called with async_mode&quot;</span><span class="p">)</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">page_content</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">metadata</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_function</span><span class="o">.</span><span class="n">aembed_documents</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span>
        <span class="n">added_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aadd_embeddings</span><span class="p">(</span>
            <span class="n">texts</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span> <span class="n">embeddings</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;succeeded&quot;</span><span class="p">:</span> <span class="n">added_ids</span><span class="p">,</span>
            <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">item</span><span class="o">.</span><span class="n">id</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">added_ids</span>
            <span class="p">],</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="PGVector.get_by_ids">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.get_by_ids">[docs]</a>
    <span class="k">def</span> <span class="nf">get_by_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get documents by ids.&quot;&quot;&quot;</span>
        <span class="n">documents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_sync_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="n">filter_by</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">select</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">filter_by</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">documents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Document</span><span class="p">(</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">page_content</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">document</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">documents</span></div>


<div class="viewcode-block" id="PGVector.aget_by_ids">
<a class="viewcode-back" href="../../postgres/vectorstores/langchain_postgres.vectorstores.PGVector.html#langchain_postgres.vectorstores.PGVector.aget_by_ids">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">aget_by_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get documents by ids.&quot;&quot;&quot;</span>
        <span class="n">documents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_async_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aget_collection</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="n">filter_by</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">collection_id</span> <span class="o">==</span> <span class="n">collection</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span>

            <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">select</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EmbeddingStore</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">filter_by</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">results</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">))</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">documents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Document</span><span class="p">(</span>
                        <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                        <span class="n">page_content</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">document</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">cmetadata</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">documents</span></div>
</div>

</pre></div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  <div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item">
<div class="prev-next-area">
</div></div>
  
</div>
                </footer>
              
              
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright 2023, LangChain, Inc.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
</div>

  </footer>
  </body>
</html>