
<!DOCTYPE html>

<html data-content_root="" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>sqlalchemy.orm.decl_base â€” ðŸ¦œðŸ”— LangChain  documentation</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/autodoc_pydantic.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/css/custom.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" rel="preload"/>
<link as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" rel="preload"/>
<script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>
<script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/doctools.js"></script>
<script src="../../../_static/sphinx_highlight.js"></script>
<script src="../../../_static/clipboard.min.js"></script>
<script src="../../../_static/copybutton.js"></script>
<script src="../../../_static/design-tabs.js"></script>
<script>DOCUMENTATION_OPTIONS.pagename = '_modules/sqlalchemy/orm/decl_base';</script>
<link href="../../../_static/favicon.png" rel="icon"/>
<link href="../../../search.html" rel="search" title="Search"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
<meta content="Aug 23, 2024" name="docbuild:last-update"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
<div class="skip-link d-print-none" id="pst-skip-link"><a href="#main-content">Skip to main content</a></div>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>Back to top</button>
<input class="sidebar-toggle" id="pst-primary-sidebar-checkbox" type="checkbox"/>
<label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
<input class="sidebar-toggle" id="pst-secondary-sidebar-checkbox" type="checkbox"/>
<label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
</div>
<div class="pst-async-banner-revealer d-none">
<aside aria-label="Version warning" class="d-none d-print-none" id="bd-header-version-warning"></aside>
</div>
<header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
<button aria-label="Site navigation" class="pst-navbar-icon sidebar-toggle primary-toggle">
<span class="fa-solid fa-bars"></span>
</button>
<div class="navbar-header-items__start">
<div class="navbar-item">
<a class="navbar-brand logo" href="../../../index.html">
<img alt="ðŸ¦œðŸ”— LangChain  documentation - Home" class="logo__image only-light" src="../../../_static/wordmark-api.svg"/>
<script>document.write(`<img src="../../../_static/wordmark-api-dark.svg" class="logo__image only-dark" alt="ðŸ¦œðŸ”— LangChain  documentation - Home"/>`);</script>
</a></div>
</div>
<div class="navbar-header-items">
<div class="me-auto navbar-header-items__center">
<div class="navbar-item">
<nav>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../reference.html">
    Reference
  </a>
</li>
<li class="nav-item">
<a class="nav-link nav-external" href="https://api.python.langchain.com/">
    Legacy reference
  </a>
</li>
</ul>
</nav></div>
</div>
<div class="navbar-header-items__end">
<div class="navbar-item navbar-persistent--container">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
<div class="navbar-item"><!-- This will display a link to LangChain docs -->
<head>
<style>
        .text-link {
            text-decoration: none; /* Remove underline */
            color: inherit;        /* Inherit color from parent element */
        }
    </style>
</head>
<body>
<a class="text-link" href="https://python.langchain.com/">Docs</a>
</body></div>
<div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
<div class="navbar-item"><ul aria-label="Quick Links" class="navbar-icon-links">
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/langchain-ai/langchain" rel="noopener" target="_blank" title="GitHub"><i aria-hidden="true" class="fa-brands fa-square-github fa-lg"></i>
<span class="sr-only">GitHub</span></a>
</li>
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/langchainai" rel="noopener" target="_blank" title="X / Twitter"><i aria-hidden="true" class="fab fa-twitter-square fa-lg"></i>
<span class="sr-only">X / Twitter</span></a>
</li>
</ul></div>
</div>
</div>
<div class="navbar-persistent--mobile">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
</div>
</header>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar hide-on-wide">
<div class="sidebar-header-items sidebar-primary__section">
<div class="sidebar-header-items__center">
<div class="navbar-item">
<nav>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../reference.html">
    Reference
  </a>
</li>
<li class="nav-item">
<a class="nav-link nav-external" href="https://api.python.langchain.com/">
    Legacy reference
  </a>
</li>
</ul>
</nav></div>
</div>
<div class="sidebar-header-items__end">
<div class="navbar-item"><!-- This will display a link to LangChain docs -->
<head>
<style>
        .text-link {
            text-decoration: none; /* Remove underline */
            color: inherit;        /* Inherit color from parent element */
        }
    </style>
</head>
<body>
<a class="text-link" href="https://python.langchain.com/">Docs</a>
</body></div>
<div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
<div class="navbar-item"><ul aria-label="Quick Links" class="navbar-icon-links">
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/langchain-ai/langchain" rel="noopener" target="_blank" title="GitHub"><i aria-hidden="true" class="fa-brands fa-square-github fa-lg"></i>
<span class="sr-only">GitHub</span></a>
</li>
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/langchainai" rel="noopener" target="_blank" title="X / Twitter"><i aria-hidden="true" class="fab fa-twitter-square fa-lg"></i>
<span class="sr-only">X / Twitter</span></a>
</li>
</ul></div>
</div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content" role="main">
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item">
<nav aria-label="Breadcrumb" class="d-print-none">
<ul class="bd-breadcrumbs">
<li class="breadcrumb-item breadcrumb-home">
<a aria-label="Home" class="nav-link" href="../../../index.html">
<i class="fa-solid fa-home"></i>
</a>
</li>
<li class="breadcrumb-item"><a class="nav-link" href="../../index.html">Module code</a></li>
<li aria-current="page" class="breadcrumb-item active">sqlalchemy.o...</li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article">
<h1>Source code for sqlalchemy.orm.decl_base</h1><div class="highlight"><pre>
<span></span><span class="c1"># orm/decl_base.py</span>
<span class="c1"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
<span class="c1"># &lt;see AUTHORS file&gt;</span>
<span class="c1">#</span>
<span class="c1"># This module is part of SQLAlchemy and is released under</span>
<span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>

<span class="sd">"""Internal implementation for declarative."""</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NoReturn</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">attributes</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">clsregistry</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">orm_exc</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">instrumentation</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">mapperlib</span>
<span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_O</span>
<span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">attr_is_internal_proxy</span>
<span class="kn">from</span> <span class="nn">.attributes</span> <span class="kn">import</span> <span class="n">InstrumentedAttribute</span>
<span class="kn">from</span> <span class="nn">.attributes</span> <span class="kn">import</span> <span class="n">QueryableAttribute</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_is_mapped_class</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">InspectionAttr</span>
<span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">CompositeProperty</span>
<span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">SynonymProperty</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_AttributeOptions</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_DCAttributeOptions</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_IntrospectsAnnotations</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_MappedAttribute</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_MapsColumns</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">MapperProperty</span>
<span class="kn">from</span> <span class="nn">.mapper</span> <span class="kn">import</span> <span class="n">Mapper</span>
<span class="kn">from</span> <span class="nn">.properties</span> <span class="kn">import</span> <span class="n">ColumnProperty</span>
<span class="kn">from</span> <span class="nn">.properties</span> <span class="kn">import</span> <span class="n">MappedColumn</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">_extract_mapped_subtype</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">_is_mapped_annotation</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">class_mapper</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">de_stringify_annotation</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">exc</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">_NoArg</span>
<span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">topological</span>
<span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">_AnnotationScanType</span>
<span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_fwd_ref</span>
<span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_literal</span>
<span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Protocol</span>
<span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">TypedDict</span>
<span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">typing_get_args</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_ClassDict</span>
    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_RegistryType</span>
    <span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">Mapped</span>
    <span class="kn">from</span> <span class="nn">.decl_api</span> <span class="kn">import</span> <span class="n">declared_attr</span>
    <span class="kn">from</span> <span class="nn">.instrumentation</span> <span class="kn">import</span> <span class="n">ClassManager</span>
    <span class="kn">from</span> <span class="nn">..sql.elements</span> <span class="kn">import</span> <span class="n">NamedColumn</span>
    <span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">MetaData</span>
    <span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">FromClause</span>

<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">"_T"</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>

<span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="n">_TableArgsType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>


<span class="k">class</span> <span class="nc">MappedClassProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">[</span><span class="n">_O</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">"""A protocol representing a SQLAlchemy mapped class.</span>

<span class="sd">    The protocol is generic on the type of class, use</span>
<span class="sd">    ``MappedClassProtocol[Any]`` to allow any mapped class.</span>
<span class="sd">    """</span>

    <span class="vm">__name__</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">__mapper__</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
    <span class="n">__table__</span><span class="p">:</span> <span class="n">FromClause</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span> <span class="o">...</span>


<span class="k">class</span> <span class="nc">_DeclMappedClassProtocol</span><span class="p">(</span><span class="n">MappedClassProtocol</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">Protocol</span><span class="p">):</span>
    <span class="s2">"Internal more detailed version of ``MappedClassProtocol``."</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">MetaData</span>
    <span class="n">__tablename__</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">__mapper_args__</span><span class="p">:</span> <span class="n">_MapperKwArgs</span>
    <span class="n">__table_args__</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_TableArgsType</span><span class="p">]</span>

    <span class="n">_sa_apply_dc_transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_DataclassArguments</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__declare_first__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">__declare_last__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>


<span class="k">class</span> <span class="nc">_DataclassArguments</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
    <span class="nb">repr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
    <span class="n">eq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
    <span class="n">order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
    <span class="n">unsafe_hash</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
    <span class="n">match_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
    <span class="n">kw_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
    <span class="n">dataclass_callable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>


<span class="k">def</span> <span class="nf">_declared_mapping_info</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">_DeferredMapperConfig</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
    <span class="c1"># deferred mapping</span>
    <span class="k">if</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">config_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="c1"># regular mapping</span>
    <span class="k">elif</span> <span class="n">_is_mapped_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">class_mapper</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">configure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_is_supercls_for_inherits</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""return True if this class will be used as a superclass to set in</span>
<span class="sd">    'inherits'.</span>

<span class="sd">    This includes deferred mapper configs that aren't mapped yet, however does</span>
<span class="sd">    not include classes with _sa_decl_prepare_nocascade (e.g.</span>
<span class="sd">    ``AbstractConcreteBase``); these concrete-only classes are not set up as</span>
<span class="sd">    "inherits" until after mappers are configured using</span>
<span class="sd">    mapper._set_concrete_base()</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="s2">"_sa_decl_prepare_nocascade"</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="c1"># regular mapping</span>
    <span class="k">elif</span> <span class="n">_is_mapped_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="nb">object</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">sup</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"__abstract__"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">base_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
            <span class="n">sup</span> <span class="o">=</span> <span class="n">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="n">base_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sup</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clsmanager</span> <span class="o">=</span> <span class="n">_dive_for_cls_manager</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clsmanager</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">clsmanager</span><span class="o">.</span><span class="n">class_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span>


<span class="k">def</span> <span class="nf">_get_immediate_cls_attr</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">attrname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""return an attribute of the class that is either present directly</span>
<span class="sd">    on the class, e.g. not on a superclass, or is from a superclass but</span>
<span class="sd">    this superclass is a non-mapped mixin, that is, not a descendant of</span>
<span class="sd">    the declarative base and is also not classically mapped.</span>

<span class="sd">    This is used to detect attributes that indicate something about</span>
<span class="sd">    a mapped class independently from any mapped classes that it may</span>
<span class="sd">    inherit from.</span>

<span class="sd">    """</span>

    <span class="c1"># the rules are different for this name than others,</span>
    <span class="c1"># make sure we've moved it out.  transitional</span>
    <span class="k">assert</span> <span class="n">attrname</span> <span class="o">!=</span> <span class="s2">"__abstract__"</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">_is_classical_inherits</span> <span class="o">=</span> <span class="n">_dive_for_cls_manager</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">base</span> <span class="ow">is</span> <span class="bp">cls</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span> <span class="k">if</span> <span class="n">strict</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_classical_inherits</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_dive_for_cls_manager</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClassManager</span><span class="p">[</span><span class="n">_O</span><span class="p">]]:</span>
    <span class="c1"># because the class manager registration is pluggable,</span>
    <span class="c1"># we need to do the search for every class in the hierarchy,</span>
    <span class="c1"># rather than just a simple "cls._sa_class_manager"</span>

    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
        <span class="n">manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClassManager</span><span class="p">[</span><span class="n">_O</span><span class="p">]]</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span>
            <span class="n">base</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">manager</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">manager</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_as_declarative</span><span class="p">(</span>
    <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_ClassDict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_MapperConfig</span><span class="p">]:</span>
    <span class="c1"># declarative scans the class for attributes.  no table or mapper</span>
    <span class="c1"># args passed separately.</span>
    <span class="k">return</span> <span class="n">_MapperConfig</span><span class="o">.</span><span class="n">setup_mapping</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{})</span>


<span class="k">def</span> <span class="nf">_mapper</span><span class="p">(</span>
    <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
    <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
    <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
    <span class="n">_ImperativeMapperConfig</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="s2">"MappedClassProtocol[_O]"</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__mapper__</span>


<span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">"sqlalchemy.orm.decl_api"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">_declared_attr_common</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_decl_api</span><span class="o">.</span><span class="n">_declared_attr_common</span>

    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">_declared_attr_common</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">classproperty</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_check_declared_props_nocascade</span><span class="p">(</span>
    <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">"_cascading"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">"@declared_attr.cascading is not supported on the </span><span class="si">%s</span><span class="s2"> "</span>
                <span class="s2">"attribute on class </span><span class="si">%s</span><span class="s2">.  This attribute invokes for "</span>
                <span class="s2">"subclasses in any case."</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">_MapperConfig</span><span class="p">:</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"cls"</span><span class="p">,</span>
        <span class="s2">"classname"</span><span class="p">,</span>
        <span class="s2">"properties"</span><span class="p">,</span>
        <span class="s2">"declared_attr_reg"</span><span class="p">,</span>
        <span class="s2">"__weakref__"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="n">classname</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">properties</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">[</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="n">Union</span><span class="p">[</span>
            <span class="n">Sequence</span><span class="p">[</span><span class="n">NamedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">NamedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
        <span class="p">],</span>
    <span class="p">]</span>
    <span class="n">declared_attr_reg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">declared_attr</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setup_mapping</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
        <span class="n">dict_</span><span class="p">:</span> <span class="n">_ClassDict</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_MapperConfig</span><span class="p">]:</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">manager</span> <span class="ow">and</span> <span class="n">manager</span><span class="o">.</span><span class="n">class_</span> <span class="ow">is</span> <span class="n">cls_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Class </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> already has been instrumented declaratively"</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"__abstract__"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">defer_map</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
            <span class="n">cls_</span><span class="p">,</span> <span class="s2">"_sa_decl_prepare_nocascade"</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="s2">"_sa_decl_prepare"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">defer_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_DeferredMapperConfig</span><span class="p">(</span>
                <span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">mapper_kw</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_ClassScanMapperConfig</span><span class="p">(</span>
                <span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">mapper_kw</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">assert_arg_type</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="s2">"cls_"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classname</span> <span class="o">=</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_attr_reg</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"non_primary"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">instrumentation</span><span class="o">.</span><span class="n">register_class</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span>
                <span class="n">finalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">registry</span><span class="o">=</span><span class="n">registry</span><span class="p">,</span>
                <span class="n">declarative_scan</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">init_method</span><span class="o">=</span><span class="n">registry</span><span class="o">.</span><span class="n">constructor</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s2">"Class </span><span class="si">%s</span><span class="s2"> has no primary mapper configured.  Configure "</span>
                    <span class="s2">"a primary mapper first before setting up a non primary "</span>
                    <span class="s2">"Mapper."</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_cls_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">instrumentation</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">install_member</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_early_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ImperativeMapperConfig</span><span class="p">(</span><span class="n">_MapperConfig</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"local_table"</span><span class="p">,</span> <span class="s2">"inherits"</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span><span class="s2">"__table__"</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">mapperlib</span><span class="o">.</span><span class="n">_CONFIGURE_MUTEX</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"non_primary"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">clsregistry</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">registry</span><span class="o">.</span><span class="n">_class_registry</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inheritance</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_early_mapping</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="n">mapper_cls</span> <span class="o">=</span> <span class="n">Mapper</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
            <span class="s2">"__mapper__"</span><span class="p">,</span>
            <span class="n">mapper_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span> <span class="o">**</span><span class="n">mapper_kw</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>

        <span class="n">inherits</span> <span class="o">=</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"inherits"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># since we search for classical mappings now, search for</span>
            <span class="c1"># multiple mapped bases as well and raise an error.</span>
            <span class="n">inherits_search</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">base_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="n">base_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">_is_supercls_for_inherits</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inherits_search</span><span class="p">:</span>
                    <span class="n">inherits_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inherits_search</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inherits_search</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                        <span class="s2">"Class </span><span class="si">%s</span><span class="s2"> has multiple mapped bases: </span><span class="si">%r</span><span class="s2">"</span>
                        <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inherits_search</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherits</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">):</span>
            <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span><span class="o">.</span><span class="n">class_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span>


<span class="k">class</span> <span class="nc">_CollectedAnnotation</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">raw_annotation</span><span class="p">:</span> <span class="n">_AnnotationScanType</span>
    <span class="n">mapped_container</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Mapped</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
    <span class="n">extracted_mapped_annotation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>
    <span class="n">is_dataclass</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">attr_value</span><span class="p">:</span> <span class="n">Any</span>
    <span class="n">originating_module</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_ClassScanMapperConfig</span><span class="p">(</span><span class="n">_MapperConfig</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"registry"</span><span class="p">,</span>
        <span class="s2">"clsdict_view"</span><span class="p">,</span>
        <span class="s2">"collected_attributes"</span><span class="p">,</span>
        <span class="s2">"collected_annotations"</span><span class="p">,</span>
        <span class="s2">"local_table"</span><span class="p">,</span>
        <span class="s2">"persist_selectable"</span><span class="p">,</span>
        <span class="s2">"declared_columns"</span><span class="p">,</span>
        <span class="s2">"column_ordering"</span><span class="p">,</span>
        <span class="s2">"column_copies"</span><span class="p">,</span>
        <span class="s2">"table_args"</span><span class="p">,</span>
        <span class="s2">"tablename"</span><span class="p">,</span>
        <span class="s2">"mapper_args"</span><span class="p">,</span>
        <span class="s2">"mapper_args_fn"</span><span class="p">,</span>
        <span class="s2">"table_fn"</span><span class="p">,</span>
        <span class="s2">"inherits"</span><span class="p">,</span>
        <span class="s2">"single"</span><span class="p">,</span>
        <span class="s2">"allow_dataclass_fields"</span><span class="p">,</span>
        <span class="s2">"dataclass_setup_arguments"</span><span class="p">,</span>
        <span class="s2">"is_dataclass_prior_to_mapping"</span><span class="p">,</span>
        <span class="s2">"allow_unmapped_annotations"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">is_deferred</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span>
    <span class="n">clsdict_view</span><span class="p">:</span> <span class="n">_ClassDict</span>
    <span class="n">collected_annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_CollectedAnnotation</span><span class="p">]</span>
    <span class="n">collected_attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">local_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
    <span class="n">persist_selectable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
    <span class="n">declared_columns</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">[</span><span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
    <span class="n">column_ordering</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">column_copies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
        <span class="n">Union</span><span class="p">[</span><span class="n">MappedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
        <span class="n">Union</span><span class="p">[</span><span class="n">MappedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
    <span class="p">]</span>
    <span class="n">tablename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">mapper_args</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">table_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_TableArgsType</span><span class="p">]</span>
    <span class="n">mapper_args_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
    <span class="n">inherits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
    <span class="n">single</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="n">is_dataclass_prior_to_mapping</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">allow_unmapped_annotations</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="n">dataclass_setup_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_DataclassArguments</span><span class="p">]</span>
<span class="w">    </span><span class="sd">"""if the class has SQLAlchemy native dataclass parameters, where</span>
<span class="sd">    we will turn the class into a dataclass within the declarative mapping</span>
<span class="sd">    process.</span>

<span class="sd">    """</span>

    <span class="n">allow_dataclass_fields</span><span class="p">:</span> <span class="nb">bool</span>
<span class="w">    </span><span class="sd">"""if true, look for dataclass-processed Field objects on the target</span>
<span class="sd">    class as well as superclasses and extract ORM mapping directives from</span>
<span class="sd">    the "metadata" attribute of each Field.</span>

<span class="sd">    if False, dataclass fields can still be used, however they won't be</span>
<span class="sd">    mapped.</span>

<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
        <span class="n">dict_</span><span class="p">:</span> <span class="n">_ClassDict</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># grab class dict before the instrumentation manager has been added.</span>
        <span class="c1"># reduces cycles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span> <span class="k">if</span> <span class="n">dict_</span> <span class="k">else</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persist_selectable</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_ordering</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span> <span class="o">=</span> <span class="n">dca</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">"_sa_apply_dc_transforms"</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allow_unmapped_annotations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">"__allow_unmapped__"</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_dataclass_prior_to_mapping</span> <span class="o">=</span> <span class="n">cld</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span>
            <span class="n">cls_</span>
        <span class="p">)</span>

        <span class="n">sdk</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="s2">"__sa_dataclass_metadata_key__"</span><span class="p">)</span>

        <span class="c1"># we don't want to consume Field objects from a not-already-dataclass.</span>
        <span class="c1"># the Field objects won't have their "name" or "type" populated,</span>
        <span class="c1"># and while it seems like we could just set these on Field as we</span>
        <span class="c1"># read them, Field is documented as "user read only" and we need to</span>
        <span class="c1"># stay far away from any off-label use of dataclasses APIs.</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cld</span> <span class="ow">or</span> <span class="n">dca</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sdk</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s2">"SQLAlchemy mapped dataclasses can't consume mapping "</span>
                <span class="s2">"information from dataclass.Field() objects if the immediate "</span>
                <span class="s2">"class is not already a dataclass."</span>
            <span class="p">)</span>

        <span class="c1"># if already a dataclass, and __sa_dataclass_metadata_key__ present,</span>
        <span class="c1"># then also look inside of dataclass.Field() objects yielded by</span>
        <span class="c1"># dataclasses.get_fields(cls) when scanning for attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_dataclass_fields</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sdk</span> <span class="ow">and</span> <span class="n">cld</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_declared_events</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_attributes</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dataclasses_transforms</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mapperlib</span><span class="o">.</span><span class="n">_CONFIGURE_MUTEX</span><span class="p">:</span>
            <span class="n">clsregistry</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">registry</span><span class="o">.</span><span class="n">_class_registry</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inheriting_mapper</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_mappable_attributes</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_declared_columns</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inheriting_columns</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_early_mapping</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_declared_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">"__declare_last__"</span><span class="p">):</span>

            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Mapper</span><span class="p">,</span> <span class="s2">"after_configured"</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">after_configured</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cast</span><span class="p">(</span>
                    <span class="s2">"_DeclMappedClassProtocol[Any]"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
                <span class="p">)</span><span class="o">.</span><span class="n">__declare_last__</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">"__declare_first__"</span><span class="p">):</span>

            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Mapper</span><span class="p">,</span> <span class="s2">"before_configured"</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">before_configured</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cast</span><span class="p">(</span>
                    <span class="s2">"_DeclMappedClassProtocol[Any]"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
                <span class="p">)</span><span class="o">.</span><span class="n">__declare_first__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cls_attr_override_checker</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Produce a function that checks if a class has overridden an</span>
<span class="sd">        attribute, taking SQLAlchemy-enabled dataclass fields into account.</span>

<span class="sd">        """</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_dataclass_fields</span><span class="p">:</span>
            <span class="n">sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
                <span class="bp">cls</span><span class="p">,</span> <span class="s2">"__sa_dataclass_metadata_key__"</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">attribute_is_overridden</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_datacls_fields</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">sa_dataclass_metadata_key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">dataclass_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sa_dataclass_metadata_key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span>
            <span class="p">}</span>
            <span class="n">local_datacls_fields</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">sa_dataclass_metadata_key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">local_dataclass_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sa_dataclass_metadata_key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span>
            <span class="p">}</span>

            <span class="n">absent</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">attribute_is_overridden</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span>

                <span class="c1"># this function likely has some failure modes still if</span>
                <span class="c1"># someone is doing a deep mixing of the same attribute</span>
                <span class="c1"># name as plain Python attribute vs. dataclass field.</span>

                <span class="n">ret</span> <span class="o">=</span> <span class="n">local_datacls_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">absent</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">fget</span>

                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">absent</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="n">all_field</span> <span class="o">=</span> <span class="n">all_datacls_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">absent</span><span class="p">)</span>

                <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="c1"># for dataclasses, this could be the</span>
                <span class="c1"># 'default' of the field.  so filter more specifically</span>
                <span class="c1"># for an already-mapped InstrumentedAttribute</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">absent</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">ret</span><span class="p">,</span> <span class="n">InstrumentedAttribute</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">all_field</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">all_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">absent</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="c1"># can't find another attribute</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">attribute_is_overridden</span>

    <span class="n">_include_dunders</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"__table__"</span><span class="p">,</span>
        <span class="s2">"__mapper_args__"</span><span class="p">,</span>
        <span class="s2">"__tablename__"</span><span class="p">,</span>
        <span class="s2">"__table_args__"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">_match_exclude_dunders</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"^(?:_sa_|__)"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cls_attr_resolver</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">"""produce a function to iterate the "attributes" of a class</span>
<span class="sd">        which we want to consider for mapping, adjusting for SQLAlchemy fields</span>
<span class="sd">        embedded in dataclass fields.</span>

<span class="sd">        """</span>
        <span class="n">cls_annotations</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="n">cls_vars</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="n">_include_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_dunders</span>
        <span class="n">_match_exclude_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_exclude_dunders</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">n</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">merge_lists_w_ordering</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">cls_vars</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">cls_annotations</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_match_exclude_dunders</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">_include_dunders</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_dataclass_fields</span><span class="p">:</span>
            <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
                <span class="bp">cls</span><span class="p">,</span> <span class="s2">"__sa_dataclass_metadata_key__"</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">local_attributes_for_class</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span>
                <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span>
                        <span class="n">cls_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                        <span class="n">cls_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                        <span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataclass_fields</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">local_dataclass_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="n">fixed_sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="n">sa_dataclass_metadata_key</span>

            <span class="k">def</span> <span class="nf">local_attributes_for_class</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span>
                <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">dataclass_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">sa_dataclass_metadata_key</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_as_dc_declaredattr</span><span class="p">(</span>
                            <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">fixed_sa_dataclass_metadata_key</span>
                        <span class="p">),</span> <span class="n">cls_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">cls_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">name</span>
                        <span class="p">),</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">local_attributes_for_class</span>

    <span class="k">def</span> <span class="nf">_scan_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>

        <span class="n">cls_as_Decl</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">"_DeclMappedClassProtocol[Any]"</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>

        <span class="n">clsdict_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
        <span class="n">collected_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span>
        <span class="n">column_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span>
        <span class="n">_include_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_dunders</span>
        <span class="n">mapper_args_fn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">table_args</span> <span class="o">=</span> <span class="n">inherited_table_args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">table_fn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tablename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fixed_table</span> <span class="o">=</span> <span class="s2">"__table__"</span> <span class="ow">in</span> <span class="n">clsdict_view</span>

        <span class="n">attribute_is_overridden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_attr_override_checker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>

        <span class="n">bases</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
            <span class="c1"># collect bases and make sure standalone columns are copied</span>
            <span class="c1"># to be the column they will ultimately be on the class,</span>
            <span class="c1"># so that declared_attr functions use the right columns.</span>
            <span class="c1"># need to do this all the way up the hierarchy first</span>
            <span class="c1"># (see #8190)</span>

            <span class="n">class_mapped</span> <span class="o">=</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span> <span class="ow">and</span> <span class="n">_is_supercls_for_inherits</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

            <span class="n">local_attributes_for_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_attr_resolver</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
                <span class="n">locally_collected_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_produce_column_copies</span><span class="p">(</span>
                    <span class="n">local_attributes_for_class</span><span class="p">,</span>
                    <span class="n">attribute_is_overridden</span><span class="p">,</span>
                    <span class="n">fixed_table</span><span class="p">,</span>
                    <span class="n">base</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">locally_collected_columns</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">base</span><span class="p">,</span>
                    <span class="n">class_mapped</span><span class="p">,</span>
                    <span class="n">local_attributes_for_class</span><span class="p">,</span>
                    <span class="n">locally_collected_columns</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span>
            <span class="n">base</span><span class="p">,</span>
            <span class="n">class_mapped</span><span class="p">,</span>
            <span class="n">local_attributes_for_class</span><span class="p">,</span>
            <span class="n">locally_collected_columns</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="c1"># this transfer can also take place as we scan each name</span>
            <span class="c1"># for finer-grained control of how collected_attributes is</span>
            <span class="c1"># populated, as this is what impacts column ordering.</span>
            <span class="c1"># however it's simpler to get it out of the way here.</span>
            <span class="n">collected_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">locally_collected_columns</span><span class="p">)</span>

            <span class="k">for</span> <span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">obj</span><span class="p">,</span>
                <span class="n">annotation</span><span class="p">,</span>
                <span class="n">is_dataclass_field</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="n">local_attributes_for_class</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_include_dunders</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"__mapper_args__"</span><span class="p">:</span>
                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper_args_fn</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">or</span> <span class="n">check_decl</span>
                        <span class="p">):</span>
                            <span class="c1"># don't even invoke __mapper_args__ until</span>
                            <span class="c1"># after we've determined everything about the</span>
                            <span class="c1"># mapped table.</span>
                            <span class="c1"># make a copy of it so a class-level dictionary</span>
                            <span class="c1"># is not overwritten when we update column-based</span>
                            <span class="c1"># arguments.</span>
                            <span class="k">def</span> <span class="nf">_mapper_args_fn</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
                                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__mapper_args__</span><span class="p">)</span>

                            <span class="n">mapper_args_fn</span> <span class="o">=</span> <span class="n">_mapper_args_fn</span>

                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"__tablename__"</span><span class="p">:</span>
                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">tablename</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">or</span> <span class="n">check_decl</span><span class="p">):</span>
                            <span class="n">tablename</span> <span class="o">=</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__tablename__</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"__table__"</span><span class="p">:</span>
                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
                        <span class="p">)</span>
                        <span class="c1"># if a @declared_attr using "__table__" is detected,</span>
                        <span class="c1"># wrap up a callable to look for "__table__" from</span>
                        <span class="c1"># the final concrete class when we set up a table.</span>
                        <span class="c1"># this was fixed by</span>
                        <span class="c1"># #11509, regression in 2.0 from version 1.4.</span>
                        <span class="k">if</span> <span class="n">check_decl</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">table_fn</span><span class="p">:</span>
                            <span class="c1"># don't even invoke __table__ until we're ready</span>
                            <span class="k">def</span> <span class="nf">_table_fn</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FromClause</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__table__</span>

                            <span class="n">table_fn</span> <span class="o">=</span> <span class="n">_table_fn</span>

                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"__table_args__"</span><span class="p">:</span>
                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">table_args</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">or</span> <span class="n">check_decl</span><span class="p">):</span>
                            <span class="n">table_args</span> <span class="o">=</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__table_args__</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                                <span class="n">table_args</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                            <span class="p">):</span>
                                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                                    <span class="s2">"__table_args__ value must be a tuple, "</span>
                                    <span class="s2">"dict, or None"</span>
                                <span class="p">)</span>
                            <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
                                <span class="n">inherited_table_args</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># any other dunder names; should not be here</span>
                        <span class="c1"># as we have tested for all four names in</span>
                        <span class="c1"># _include_dunders</span>
                        <span class="k">assert</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">class_mapped</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">_quiet</span><span class="p">:</span>
                        <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s2">"Regular (i.e. not __special__) "</span>
                            <span class="s2">"attribute '</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">' uses @declared_attr, "</span>
                            <span class="s2">"but owning class </span><span class="si">%s</span><span class="s2"> is mapped - "</span>
                            <span class="s2">"not applying to subclass </span><span class="si">%s</span><span class="s2">."</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
                    <span class="c1"># we're a mixin, abstract base, or something that is</span>
                    <span class="c1"># acting like that for now.</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">MappedColumn</span><span class="p">)):</span>
                        <span class="c1"># already copied columns to the mapped class.</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                            <span class="s2">"Mapper properties (i.e. deferred,"</span>
                            <span class="s2">"column_property(), relationship(), etc.) must "</span>
                            <span class="s2">"be declared as @declared_attr callables "</span>
                            <span class="s2">"on declarative mixin classes.  For dataclass "</span>
                            <span class="s2">"field() objects, use a lambda:"</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                        <span class="c1"># tried to get overloads to tell this to</span>
                        <span class="c1"># pylance, no luck</span>
                        <span class="k">assert</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_cascading</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">clsdict_view</span><span class="p">:</span>
                                <span class="c1"># unfortunately, while we can use the user-</span>
                                <span class="c1"># defined attribute here to allow a clean</span>
                                <span class="c1"># override, if there's another</span>
                                <span class="c1"># subclass below then it still tries to use</span>
                                <span class="c1"># this.  not sure if there is enough</span>
                                <span class="c1"># information here to add this as a feature</span>
                                <span class="c1"># later on.</span>
                                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                    <span class="s2">"Attribute '</span><span class="si">%s</span><span class="s2">' on class </span><span class="si">%s</span><span class="s2"> cannot be "</span>
                                    <span class="s2">"processed due to "</span>
                                    <span class="s2">"@declared_attr.cascading; "</span>
                                    <span class="s2">"skipping"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_copies</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">ret</span>
                            <span class="p">)</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">is_dataclass_field</span><span class="p">:</span>
                                <span class="c1"># access attribute using normal class access</span>
                                <span class="c1"># first, to see if it's been mapped on a</span>
                                <span class="c1"># superclass.   note if the dataclasses.field()</span>
                                <span class="c1"># has "default", this value can be anything.</span>
                                <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                                <span class="c1"># so, if it's anything that's not ORM</span>
                                <span class="c1"># mapped, assume we should invoke the</span>
                                <span class="c1"># declared_attr</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">InspectionAttr</span><span class="p">):</span>
                                    <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># access attribute using normal class access.</span>
                                <span class="c1"># if the declared attr already took place</span>
                                <span class="c1"># on a superclass that is mapped, then</span>
                                <span class="c1"># this is no longer a declared_attr, it will</span>
                                <span class="c1"># be the InstrumentedAttribute</span>
                                <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

                            <span class="c1"># correct for proxies created from hybrid_property</span>
                            <span class="c1"># or similar.  note there is no known case that</span>
                            <span class="c1"># produces nested proxies, so we are only</span>
                            <span class="c1"># looking one level deep right now.</span>

                            <span class="k">if</span> <span class="p">(</span>
                                <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">InspectionAttr</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="n">attr_is_internal_proxy</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                                    <span class="n">ret</span><span class="o">.</span><span class="n">original_property</span><span class="p">,</span> <span class="n">MapperProperty</span>
                                <span class="p">)</span>
                            <span class="p">):</span>
                                <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">descriptor</span>

                            <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_copies</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">ret</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span>
                            <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">))</span>
                            <span class="ow">and</span> <span class="n">ret</span><span class="o">.</span><span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="p">):</span>
                            <span class="n">ret</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__doc__</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
                            <span class="n">name</span><span class="p">,</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">_collect_return_annotation</span><span class="p">(),</span>
                            <span class="n">base</span><span class="p">,</span>
                            <span class="kc">True</span><span class="p">,</span>
                            <span class="n">obj</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">_is_mapped_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
                        <span class="c1"># Mapped annotation without any object.</span>
                        <span class="c1"># product_column_copies should have handled this.</span>
                        <span class="c1"># if future support for other MapperProperty,</span>
                        <span class="c1"># then test if this name is already handled and</span>
                        <span class="c1"># otherwise proceed to generate.</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">fixed_table</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="p">(</span>
                                <span class="n">name</span> <span class="ow">in</span> <span class="n">collected_attributes</span>
                                <span class="ow">or</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># here, the attribute is some other kind of</span>
                        <span class="c1"># property that we assume is not part of the</span>
                        <span class="c1"># declarative mapping.  however, check for some</span>
                        <span class="c1"># more common mistakes</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_for_decl_attributes</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_dataclass_field</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clsdict_view</span> <span class="ow">or</span> <span class="n">clsdict_view</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span>
                <span class="p">):</span>
                    <span class="c1"># here, we are definitely looking at the target class</span>
                    <span class="c1"># and not a superclass.   this is currently a</span>
                    <span class="c1"># dataclass-only path.  if the name is only</span>
                    <span class="c1"># a dataclass field and isn't in local cls.__dict__,</span>
                    <span class="c1"># put the object there.</span>
                    <span class="c1"># assert that the dataclass-enabled resolver agrees</span>
                    <span class="c1"># with what we are seeing</span>

                    <span class="k">assert</span> <span class="ow">not</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="p">()</span>

                    <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">obj</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">collected_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">obj</span>
                    <span class="p">)</span>
                    <span class="n">is_mapped</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">collected_annotation</span><span class="o">.</span><span class="n">mapped_container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="p">)</span>
                    <span class="n">generated_obj</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">collected_annotation</span><span class="o">.</span><span class="n">attr_value</span>
                        <span class="k">if</span> <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="k">else</span> <span class="n">obj</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fixed_table</span> <span class="ow">and</span> <span class="n">is_mapped</span><span class="p">:</span>
                        <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">generated_obj</span>
                            <span class="k">if</span> <span class="n">generated_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="k">else</span> <span class="n">MappedColumn</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">clsdict_view</span><span class="p">:</span>
                        <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                    <span class="c1"># else if the name is not in the cls.__dict__,</span>
                    <span class="c1"># don't collect it as an attribute.</span>
                    <span class="c1"># we will see the annotation only, which is meaningful</span>
                    <span class="c1"># both for mapping and dataclasses setup</span>

        <span class="k">if</span> <span class="n">inherited_table_args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tablename</span><span class="p">:</span>
            <span class="n">table_args</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table_args</span> <span class="o">=</span> <span class="n">table_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span> <span class="o">=</span> <span class="n">tablename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args_fn</span> <span class="o">=</span> <span class="n">mapper_args_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_fn</span> <span class="o">=</span> <span class="n">table_fn</span>

    <span class="k">def</span> <span class="nf">_setup_dataclasses_transforms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dataclass_setup_arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataclass_setup_arguments</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># can't use is_dataclass since it uses hasattr</span>
        <span class="k">if</span> <span class="s2">"__dataclass_fields__"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Class </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="si">}</span><span class="s2"> is already a dataclass; ensure that "</span>
                <span class="s2">"base classes / decorator styles of establishing dataclasses "</span>
                <span class="s2">"are not being mixed. "</span>
                <span class="s2">"This can happen if a class that inherits from "</span>
                <span class="s2">"'MappedAsDataclass', even indirectly, is been mapped with "</span>
                <span class="s2">"'@registry.mapped_as_dataclass'"</span>
            <span class="p">)</span>

        <span class="n">warn_for_non_dc_attrs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_allow_dataclass_field</span><span class="p">(</span>
            <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">originating_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
                <span class="ow">and</span> <span class="s2">"__dataclass_fields__"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">originating_class</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="p">):</span>
                <span class="n">warn_for_non_dc_attrs</span><span class="p">[</span><span class="n">originating_class</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">manager</span> <span class="o">=</span> <span class="n">instrumentation</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">field_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_AttributeOptions</span><span class="o">.</span><span class="n">_get_arguments_for_make_dataclass</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">anno</span><span class="p">,</span>
                <span class="n">mapped_container</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">anno</span><span class="p">,</span> <span class="n">mapped_container</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span>
                    <span class="n">mapped_anno</span> <span class="k">if</span> <span class="n">mapped_anno</span> <span class="k">else</span> <span class="n">raw_anno</span><span class="p">,</span>
                    <span class="n">mapped_container</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span>
                    <span class="n">raw_anno</span><span class="p">,</span>
                    <span class="n">mapped_container</span><span class="p">,</span>
                    <span class="n">mapped_anno</span><span class="p">,</span>
                    <span class="n">is_dc</span><span class="p">,</span>
                    <span class="n">attr_value</span><span class="p">,</span>
                    <span class="n">originating_module</span><span class="p">,</span>
                    <span class="n">originating_class</span><span class="p">,</span>
                <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">_allow_dataclass_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span>
                    <span class="c1"># issue #9226; check for attributes that we've collected</span>
                    <span class="c1"># which are already instrumented, which we would assume</span>
                    <span class="c1"># mean we are in an ORM inheritance mapping and this</span>
                    <span class="c1"># attribute is already mapped on the superclass.   Under</span>
                    <span class="c1"># no circumstance should any QueryableAttribute be sent to</span>
                    <span class="c1"># the dataclass() function; anything that's mapped should</span>
                    <span class="c1"># be Field and that's it</span>
                    <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">QueryableAttribute</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">warn_for_non_dc_attrs</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span>
                <span class="n">originating_class</span><span class="p">,</span>
                <span class="n">non_dc_attrs</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="n">warn_for_non_dc_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">util</span><span class="o">.</span><span class="n">warn_deprecated</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"When transforming </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="si">}</span><span class="s2"> to a dataclass, "</span>
                    <span class="sa">f</span><span class="s2">"attribute(s) "</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">non_dc_attrs</span><span class="p">)</span><span class="si">}</span><span class="s2"> "</span>
                    <span class="sa">f</span><span class="s2">"originates from superclass "</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">originating_class</span><span class="si">}</span><span class="s2">, which is not a dataclass.  This "</span>
                    <span class="sa">f</span><span class="s2">"usage is deprecated and will raise an error in "</span>
                    <span class="sa">f</span><span class="s2">"SQLAlchemy 2.1.  When declaring SQLAlchemy Declarative "</span>
                    <span class="sa">f</span><span class="s2">"Dataclasses, ensure that all mixin classes and other "</span>
                    <span class="sa">f</span><span class="s2">"superclasses which include attributes are also a "</span>
                    <span class="sa">f</span><span class="s2">"subclass of MappedAsDataclass."</span><span class="p">,</span>
                    <span class="s2">"2.0"</span><span class="p">,</span>
                    <span class="n">code</span><span class="o">=</span><span class="s2">"dcmx"</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">item</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span>
            <span class="n">annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_dataclasses_to_any_class</span><span class="p">(</span>
            <span class="n">dataclass_setup_arguments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">annotations</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_update_annotations_for_non_mapped_class</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">klass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_AnnotationScanType</span><span class="p">]:</span>
        <span class="n">cls_annotations</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>

        <span class="n">new_anno</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">cls_annotations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_is_mapped_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">klass</span><span class="p">):</span>
                <span class="n">extracted</span> <span class="o">=</span> <span class="n">_extract_mapped_subtype</span><span class="p">(</span>
                    <span class="n">annotation</span><span class="p">,</span>
                    <span class="n">klass</span><span class="p">,</span>
                    <span class="n">klass</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">is_dataclass_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">expect_mapped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">extracted</span><span class="p">:</span>
                    <span class="n">inner</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extracted</span>
                    <span class="n">new_anno</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">inner</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_anno</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span>
        <span class="k">return</span> <span class="n">new_anno</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_apply_dataclasses_to_any_class</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">dataclass_setup_arguments</span><span class="p">:</span> <span class="n">_DataclassArguments</span><span class="p">,</span>
        <span class="n">klass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
        <span class="n">use_annotations</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_AnnotationScanType</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_assert_dc_arguments</span><span class="p">(</span><span class="n">dataclass_setup_arguments</span><span class="p">)</span>

        <span class="n">dataclass_callable</span> <span class="o">=</span> <span class="n">dataclass_setup_arguments</span><span class="p">[</span><span class="s2">"dataclass_callable"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dataclass_callable</span> <span class="ow">is</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">:</span>
            <span class="n">dataclass_callable</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">dataclass</span>

        <span class="n">restored</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">use_annotations</span><span class="p">:</span>
            <span class="c1"># apply constructed annotations that should look "normal" to a</span>
            <span class="c1"># dataclasses callable, based on the fields present.  This</span>
            <span class="c1"># means remove the Mapped[] container and ensure all Field</span>
            <span class="c1"># entries have an annotation</span>
            <span class="n">restored</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="s2">"__annotations__"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">klass</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">"Dict[str, Any]"</span><span class="p">,</span> <span class="n">use_annotations</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">restored</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataclass_callable</span><span class="p">(</span>
                <span class="n">klass</span><span class="p">,</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataclass_setup_arguments</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">"dataclass_callable"</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Python dataclasses error encountered when creating "</span>
                <span class="sa">f</span><span class="s2">"dataclass for </span><span class="si">{</span><span class="n">klass</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2">: "</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ex</span><span class="si">!r}</span><span class="s2">. Please refer to Python dataclasses "</span>
                <span class="s2">"documentation for additional information."</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="s2">"dcte"</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># restore original annotations outside of the dataclasses</span>
            <span class="c1"># process; for mixins and __abstract__ superclasses, SQLAlchemy</span>
            <span class="c1"># Declarative will need to see the Mapped[] container inside the</span>
            <span class="c1"># annotations in order to map subclasses</span>
            <span class="k">if</span> <span class="n">use_annotations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">restored</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__annotations__</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">klass</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="n">restored</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_assert_dc_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">_DataclassArguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"init"</span><span class="p">,</span>
            <span class="s2">"repr"</span><span class="p">,</span>
            <span class="s2">"order"</span><span class="p">,</span>
            <span class="s2">"eq"</span><span class="p">,</span>
            <span class="s2">"unsafe_hash"</span><span class="p">,</span>
            <span class="s2">"kw_only"</span><span class="p">,</span>
            <span class="s2">"match_args"</span><span class="p">,</span>
            <span class="s2">"dataclass_callable"</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">disallowed_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">disallowed_args</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">disallowed_args</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Dataclass argument(s) </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> are not accepted"</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_collect_annotation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">raw_annotation</span><span class="p">:</span> <span class="n">_AnnotationScanType</span><span class="p">,</span>
        <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">expect_mapped</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
        <span class="n">attr_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CollectedAnnotation</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">raw_annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">is_dataclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dataclass_prior_to_mapping</span>
        <span class="n">allow_unmapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unmapped_annotations</span>

        <span class="k">if</span> <span class="n">expect_mapped</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_dataclass_field</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span><span class="p">)</span>
            <span class="n">expect_mapped</span> <span class="o">=</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">is_dataclass_field</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_unmapped</span>
                <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="n">_MappedAttribute</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_dataclass_field</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">is_dataclass_field</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">extracted</span> <span class="o">=</span> <span class="n">_extract_mapped_subtype</span><span class="p">(</span>
            <span class="n">raw_annotation</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span>
            <span class="n">originating_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">attr_value</span><span class="p">),</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">is_dataclass_field</span><span class="o">=</span><span class="n">is_dataclass_field</span><span class="p">,</span>
            <span class="n">expect_mapped</span><span class="o">=</span><span class="n">expect_mapped</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_dataclass</span><span class="p">,</span>  <span class="c1"># self.allow_dataclass_fields,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">extracted</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># ClassVar can come out here</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">extracted_mapped_annotation</span><span class="p">,</span> <span class="n">mapped_container</span> <span class="o">=</span> <span class="n">extracted</span>

        <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_literal</span><span class="p">(</span><span class="n">extracted_mapped_annotation</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">typing_get_args</span><span class="p">(</span><span class="n">extracted_mapped_annotation</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_fwd_ref</span><span class="p">(</span>
                    <span class="n">elem</span><span class="p">,</span> <span class="n">check_generic</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">):</span>
                    <span class="n">elem</span> <span class="o">=</span> <span class="n">de_stringify_annotation</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span>
                        <span class="n">elem</span><span class="p">,</span>
                        <span class="n">originating_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                        <span class="n">include_generic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="c1"># look in Annotated[...] for an ORM construct,</span>
                <span class="c1"># such as Annotated[int, mapped_column(primary_key=True)]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">_IntrospectsAnnotations</span><span class="p">):</span>
                    <span class="n">attr_value</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">found_in_pep593_annotated</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">_CollectedAnnotation</span><span class="p">(</span>
            <span class="n">raw_annotation</span><span class="p">,</span>
            <span class="n">mapped_container</span><span class="p">,</span>
            <span class="n">extracted_mapped_annotation</span><span class="p">,</span>
            <span class="n">is_dataclass</span><span class="p">,</span>
            <span class="n">attr_value</span><span class="p">,</span>
            <span class="n">originating_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="n">originating_class</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ca</span>

    <span class="k">def</span> <span class="nf">_warn_for_decl_attributes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">):</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Attribute '</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">' on class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> appears to "</span>
                <span class="s2">"be a non-schema SQLAlchemy expression "</span>
                <span class="s2">"object; this won't be part of the declarative mapping. "</span>
                <span class="s2">"To map arbitrary expressions, use ``column_property()`` "</span>
                <span class="s2">"or a similar function such as ``deferred()``, "</span>
                <span class="s2">"``query_expression()`` etc. "</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_produce_column_copies</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">attributes_for_class</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
            <span class="p">[],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
        <span class="p">],</span>
        <span class="n">attribute_is_overridden</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">fixed_table</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">MappedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
        <span class="n">locally_collected_attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">column_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span>
        <span class="c1"># copy mixin columns to the mapped class</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">is_dataclass</span> <span class="ow">in</span> <span class="n">attributes_for_class</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">fixed_table</span>
                <span class="ow">and</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">_is_mapped_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># obj is None means this is the annotation only path</span>

                <span class="k">if</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                    <span class="c1"># perform same "overridden" check as we do for</span>
                    <span class="c1"># Column/MappedColumn, this is how a mixin col is not</span>
                    <span class="c1"># applied to an inherited subclass that does not have</span>
                    <span class="c1"># the mixin.   the anno-only path added here for</span>
                    <span class="c1"># #9564</span>
                    <span class="k">continue</span>

                <span class="n">collected_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">obj</span>
                <span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">collected_annotation</span><span class="o">.</span><span class="n">attr_value</span>
                    <span class="k">if</span> <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="n">obj</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">MappedColumn</span><span class="p">()</span>

                <span class="n">locally_collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">MappedColumn</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                    <span class="c1"># if column has been overridden</span>
                    <span class="c1"># (like by the InstrumentedAttribute of the</span>
                    <span class="c1"># superclass), skip.  don't collect the annotation</span>
                    <span class="c1"># either (issue #8718)</span>
                    <span class="k">continue</span>

                <span class="n">collected_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">obj</span>
                <span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">collected_annotation</span><span class="o">.</span><span class="n">attr_value</span>
                    <span class="k">if</span> <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="n">obj</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="s2">"__table__"</span> <span class="ow">in</span> <span class="n">dict_</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
                    <span class="ow">in</span> <span class="n">dict_</span><span class="p">[</span><span class="s2">"__table__"</span><span class="p">]</span><span class="o">.</span><span class="n">c</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">fk</span><span class="o">.</span><span class="n">_table_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                <span class="ow">and</span> <span class="n">fk</span><span class="o">.</span><span class="n">_table_column</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span>
                            <span class="p">):</span>
                                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                                    <span class="s2">"Columns with foreign keys to "</span>
                                    <span class="s2">"non-table-bound "</span>
                                    <span class="s2">"columns must be declared as "</span>
                                    <span class="s2">"@declared_attr callables "</span>
                                    <span class="s2">"on declarative mixin classes.  "</span>
                                    <span class="s2">"For dataclass "</span>
                                    <span class="s2">"field() objects, use a lambda:."</span>
                                <span class="p">)</span>

                    <span class="n">column_copies</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_copy</span><span class="p">()</span>

                    <span class="n">locally_collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">copy_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">locally_collected_attributes</span>

    <span class="k">def</span> <span class="nf">_extract_mappable_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
        <span class="n">collected_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span>

        <span class="n">our_stuff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>

        <span class="n">_include_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_dunders</span>

        <span class="n">late_mapped</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="s2">"_sa_decl_prepare_nocascade"</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">allow_unmapped_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unmapped_annotations</span>
        <span class="n">expect_annotations_wo_mapped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">allow_unmapped_annotations</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dataclass_prior_to_mapping</span>
        <span class="p">)</span>

        <span class="n">look_for_dataclass_things</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">collected_attributes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_include_dunders</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">collected_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="c1"># @declared_attr in collected_attributes only occurs here for a</span>
                <span class="c1"># @declared_attr that's directly on the mapped class;</span>
                <span class="c1"># for a mixin, these have already been evaluated</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">_cascading</span><span class="p">:</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">"Use of @declared_attr.cascading only applies to "</span>
                        <span class="s2">"Declarative 'mixin' and 'abstract' classes.  "</span>
                        <span class="s2">"Currently, this flag is ignored on mapped class "</span>
                        <span class="s2">"</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
                    <span class="p">)</span>

                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">class_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span>
                <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">k</span>
            <span class="p">):</span>
                <span class="c1"># detect a QueryableAttribute that's already mapped being</span>
                <span class="c1"># assigned elsewhere in userland, turn into a synonym()</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">SynonymProperty</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">_MappedAttribute</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">"Ignoring declarative-like tuple value of attribute "</span>
                    <span class="s2">"'</span><span class="si">%s</span><span class="s2">': possibly a copy-and-paste error with a comma "</span>
                    <span class="s2">"accidentally placed at the end of the line?"</span> <span class="o">%</span> <span class="n">k</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">look_for_dataclass_things</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span>
            <span class="p">):</span>
                <span class="c1"># we collected a dataclass Field; dataclasses would have</span>
                <span class="c1"># set up the correct state on the class</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">_DCAttributeOptions</span><span class="p">)):</span>
                <span class="c1"># using @declared_attr for some object that</span>
                <span class="c1"># isn't Column/MapperProperty/_DCAttributeOptions; remove</span>
                <span class="c1"># from the clsdict_view</span>
                <span class="c1"># and place the evaluated value onto the class.</span>
                <span class="n">collected_attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_warn_for_decl_attributes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">late_mapped</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># we expect to see the name 'metadata' in some valid cases;</span>
            <span class="c1"># however at this point we see it's assigned to something trying</span>
            <span class="c1"># to be mapped, so raise for that.</span>
            <span class="c1"># TODO: should "registry" here be also?   might be too late</span>
            <span class="c1"># to change that now (2.0 betas)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"metadata"</span><span class="p">,):</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"Attribute name '</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">' is reserved when using the "</span>
                    <span class="s2">"Declarative API."</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
                <span class="n">_undefer_column_name</span><span class="p">(</span>
                    <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_IntrospectsAnnotations</span><span class="p">):</span>
                    <span class="p">(</span>
                        <span class="n">annotation</span><span class="p">,</span>
                        <span class="n">mapped_container</span><span class="p">,</span>
                        <span class="n">extracted_mapped_annotation</span><span class="p">,</span>
                        <span class="n">is_dataclass</span><span class="p">,</span>
                        <span class="n">attr_value</span><span class="p">,</span>
                        <span class="n">originating_module</span><span class="p">,</span>
                        <span class="n">originating_class</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="c1"># issue #8692 - don't do any annotation interpretation if</span>
                    <span class="c1"># an annotation were present and a container such as</span>
                    <span class="c1"># Mapped[] etc. were not used.  If annotation is None,</span>
                    <span class="c1"># do declarative_scan so that the property can raise</span>
                    <span class="c1"># for required</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">mapped_container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">or</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span>
                        <span class="c1"># issue #10516: need to do declarative_scan even with</span>
                        <span class="c1"># a non-Mapped annotation if we are doing</span>
                        <span class="c1"># __allow_unmapped__, for things like col.name</span>
                        <span class="c1"># assignment</span>
                        <span class="ow">or</span> <span class="n">allow_unmapped_annotations</span>
                    <span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">value</span><span class="o">.</span><span class="n">declarative_scan</span><span class="p">(</span>
                                <span class="bp">self</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span>
                                <span class="bp">cls</span><span class="p">,</span>
                                <span class="n">originating_module</span><span class="p">,</span>
                                <span class="n">k</span><span class="p">,</span>
                                <span class="n">mapped_container</span><span class="p">,</span>
                                <span class="n">annotation</span><span class="p">,</span>
                                <span class="n">extracted_mapped_annotation</span><span class="p">,</span>
                                <span class="n">is_dataclass</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">ne</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">"Could not resolve all types within mapped "</span>
                                <span class="sa">f</span><span class="s1">'annotation: "</span><span class="si">{</span><span class="n">annotation</span><span class="si">}</span><span class="s1">".  Ensure all '</span>
                                <span class="sa">f</span><span class="s2">"types are written correctly and are "</span>
                                <span class="sa">f</span><span class="s2">"imported within the module in use."</span>
                            <span class="p">)</span> <span class="kn">from</span> <span class="nn">ne</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># assert that we were expecting annotations</span>
                        <span class="c1"># without Mapped[] were going to be passed.</span>
                        <span class="c1"># otherwise an error should have been raised</span>
                        <span class="c1"># by util._extract_mapped_subtype before we got here.</span>
                        <span class="k">assert</span> <span class="n">expect_annotations_wo_mapped</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_DCAttributeOptions</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">value</span><span class="o">.</span><span class="n">_has_dataclass_arguments</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">look_for_dataclass_things</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
                            <span class="n">argnames</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="s2">"init"</span><span class="p">,</span>
                                <span class="s2">"default_factory"</span><span class="p">,</span>
                                <span class="s2">"repr"</span><span class="p">,</span>
                                <span class="s2">"default"</span><span class="p">,</span>
                            <span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">argnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"init"</span><span class="p">,</span> <span class="s2">"default_factory"</span><span class="p">,</span> <span class="s2">"repr"</span><span class="p">]</span>

                        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">a</span>
                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">argnames</span>
                            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span>
                                <span class="n">value</span><span class="o">.</span><span class="n">_attribute_options</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"dataclasses_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">"</span>
                            <span class="p">)</span>
                            <span class="ow">is</span> <span class="ow">not</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span>
                        <span class="p">}</span>

                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">"Attribute '</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">' on class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> includes "</span>
                            <span class="sa">f</span><span class="s2">"dataclasses argument(s): "</span>
                            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">args</span><span class="p">))</span><span class="si">}</span><span class="s2"> but "</span>
                            <span class="sa">f</span><span class="s2">"class does not specify "</span>
                            <span class="s2">"SQLAlchemy native dataclass configuration."</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">MapperProperty</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">)):</span>
                        <span class="c1"># filter for _DCAttributeOptions objects that aren't</span>
                        <span class="c1"># MapperProperty / mapped_column().  Currently this</span>
                        <span class="c1"># includes AssociationProxy.   pop it from the things</span>
                        <span class="c1"># we're going to map and set it up as a descriptor</span>
                        <span class="c1"># on the class.</span>
                        <span class="n">collected_attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

                        <span class="c1"># Assoc Prox (or other descriptor object that may</span>
                        <span class="c1"># use _DCAttributeOptions) is usually here, except if</span>
                        <span class="c1"># 1. we're a</span>
                        <span class="c1"># dataclass, dataclasses would have removed the</span>
                        <span class="c1"># attr here or 2. assoc proxy is coming from a</span>
                        <span class="c1"># superclass, we want it to be direct here so it</span>
                        <span class="c1"># tracks state or 3. assoc prox comes from</span>
                        <span class="c1"># declared_attr, uncommon case</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">continue</span>

            <span class="n">our_stuff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_extract_declared_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">our_stuff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>

        <span class="c1"># extract columns from the class dict</span>
        <span class="n">declared_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span>
        <span class="n">column_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ordering</span>
        <span class="n">name_to_prop_key</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">our_stuff</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">):</span>
                <span class="n">mp_to_assign</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mapper_property_to_assign</span>
                <span class="k">if</span> <span class="n">mp_to_assign</span><span class="p">:</span>
                    <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp_to_assign</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if no mapper property to assign, this currently means</span>
                    <span class="c1"># this is a MappedColumn that will produce a Column for us</span>
                    <span class="k">del</span> <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">sort_order</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">columns_to_assign</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CompositeProperty</span><span class="p">):</span>
                        <span class="n">name_to_prop_key</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">declared_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

                    <span class="c1"># we would assert this, however we want the below</span>
                    <span class="c1"># warning to take effect instead.  See #9630</span>
                    <span class="c1"># assert col not in column_ordering</span>

                    <span class="n">column_ordering</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_order</span>

                    <span class="c1"># if this is a MappedColumn and the attribute key we</span>
                    <span class="c1"># have is not what the column has for its key, map the</span>
                    <span class="c1"># Column explicitly under the attribute key name.</span>
                    <span class="c1"># otherwise, Mapper will map it under the column key.</span>
                    <span class="k">if</span> <span class="n">mp_to_assign</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">col</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                        <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
                <span class="c1"># undefer previously occurred here, and now occurs earlier.</span>
                <span class="c1"># ensure every column we get here has been named</span>
                <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">name_to_prop_key</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">declared_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="c1"># if the column is the same name as the key,</span>
                <span class="c1"># remove it from the explicit properties dict.</span>
                <span class="c1"># the normal rules for assigning column-based properties</span>
                <span class="c1"># will take over, including precedence of columns</span>
                <span class="c1"># in multi-column ColumnProperties.</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">name_to_prop_key</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">"On class </span><span class="si">%r</span><span class="s2">, Column object </span><span class="si">%r</span><span class="s2"> named "</span>
                    <span class="s2">"directly multiple times, "</span>
                    <span class="s2">"only one will be used: </span><span class="si">%s</span><span class="s2">. "</span>
                    <span class="s2">"Consider using orm.synonym instead"</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">))))</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
        <span class="n">cls_as_Decl</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">"MappedClassProtocol[Any]"</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>

        <span class="n">tablename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span>
        <span class="n">table_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_args</span>
        <span class="n">clsdict_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
        <span class="n">declared_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span>
        <span class="n">column_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ordering</span>

        <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_fn</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="s2">"__table__"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clsdict_view</span>
            <span class="ow">and</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">"__table_cls__"</span><span class="p">):</span>
                <span class="n">table_cls</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                    <span class="n">Type</span><span class="p">[</span><span class="n">Table</span><span class="p">],</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">unbound_method_to_callable</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__table_cls__</span><span class="p">),</span>  <span class="c1"># type: ignore  # noqa: E501</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table_cls</span> <span class="o">=</span> <span class="n">Table</span>

            <span class="k">if</span> <span class="n">tablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
                <span class="n">table_kw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="n">table_args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">table_kw</span> <span class="o">=</span> <span class="n">table_args</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">args</span><span class="p">,</span> <span class="n">table_kw</span> <span class="o">=</span> <span class="n">table_args</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">table_args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="n">table_args</span>

                <span class="n">autoload_with</span> <span class="o">=</span> <span class="n">clsdict_view</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"__autoload_with__"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">autoload_with</span><span class="p">:</span>
                    <span class="n">table_kw</span><span class="p">[</span><span class="s2">"autoload_with"</span><span class="p">]</span> <span class="o">=</span> <span class="n">autoload_with</span>

                <span class="n">autoload</span> <span class="o">=</span> <span class="n">clsdict_view</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"__autoload__"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
                    <span class="n">table_kw</span><span class="p">[</span><span class="s2">"autoload"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">sorted_columns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">declared_columns</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">column_ordering</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
                    <span class="s2">"__table__"</span><span class="p">,</span>
                    <span class="n">table_cls</span><span class="p">(</span>
                        <span class="n">tablename</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_for_cls</span><span class="p">(</span><span class="n">manager</span><span class="p">),</span>
                        <span class="o">*</span><span class="n">sorted_columns</span><span class="p">,</span>
                        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">table_kw</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_fn</span><span class="p">:</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
                        <span class="s2">"__table__"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_fn</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__table__</span>
            <span class="k">if</span> <span class="n">declared_columns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">declared_columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                            <span class="s2">"Can't add additional column </span><span class="si">%r</span><span class="s2"> when "</span>
                            <span class="s2">"specifying __table__"</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span>
                        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="o">=</span> <span class="n">table</span>

    <span class="k">def</span> <span class="nf">_metadata_for_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">ClassManager</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MetaData</span><span class="p">:</span>
        <span class="n">meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">"metadata"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">meta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">metadata</span>

    <span class="k">def</span> <span class="nf">_setup_inheriting_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>

        <span class="n">inherits</span> <span class="o">=</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"inherits"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># since we search for classical mappings now, search for</span>
            <span class="c1"># multiple mapped bases as well and raise an error.</span>
            <span class="n">inherits_search</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">base_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="n">base_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">_is_supercls_for_inherits</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inherits_search</span><span class="p">:</span>
                    <span class="n">inherits_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inherits_search</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inherits_search</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                        <span class="s2">"Class </span><span class="si">%s</span><span class="s2"> has multiple mapped bases: </span><span class="si">%r</span><span class="s2">"</span>
                        <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inherits_search</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherits</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">):</span>
            <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span><span class="o">.</span><span class="n">class_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span>

        <span class="n">clsdict_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
        <span class="k">if</span> <span class="s2">"__table__"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clsdict_view</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_setup_inheriting_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
        <span class="n">table_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_args</span>
        <span class="n">declared_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">"__no_table__"</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s2">"Class </span><span class="si">%r</span><span class="s2"> does not have a __table__ or __tablename__ "</span>
                <span class="s2">"specified and does not inherit from an existing "</span>
                <span class="s2">"table-mapped class."</span> <span class="o">%</span> <span class="bp">cls</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
            <span class="n">inherited_mapper_or_config</span> <span class="o">=</span> <span class="n">_declared_mapping_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">inherited_mapper_or_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">inherited_table</span> <span class="o">=</span> <span class="n">inherited_mapper_or_config</span><span class="o">.</span><span class="n">local_table</span>
            <span class="n">inherited_persist_selectable</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">inherited_mapper_or_config</span><span class="o">.</span><span class="n">persist_selectable</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># single table inheritance.</span>
                <span class="c1"># ensure no table args</span>
                <span class="k">if</span> <span class="n">table_args</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                        <span class="s2">"Can't place __table_args__ on an inherited class "</span>
                        <span class="s2">"with no table."</span>
                    <span class="p">)</span>

                <span class="c1"># add any columns declared here to the inherited table.</span>
                <span class="k">if</span> <span class="n">declared_columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherited_table</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"Can't declare columns on single-table-inherited "</span>
                        <span class="sa">f</span><span class="s2">"subclass </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="si">}</span><span class="s2">; superclass </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="si">}</span><span class="s2"> "</span>
                        <span class="s2">"is not mapped to a Table"</span>
                    <span class="p">)</span>

                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">declared_columns</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">inherited_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="n">col</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">"Column '</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">' on class </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> "</span>
                            <span class="sa">f</span><span class="s2">"conflicts with existing column "</span>
                            <span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">'.  If using "</span>
                            <span class="sa">f</span><span class="s2">"Declarative, consider using the "</span>
                            <span class="s2">"use_existing_column parameter of mapped_column() "</span>
                            <span class="s2">"to resolve conflicts."</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                            <span class="s2">"Can't place primary key columns on an inherited "</span>
                            <span class="s2">"class with no table."</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherited_table</span><span class="p">,</span> <span class="n">Table</span><span class="p">)</span>

                    <span class="n">inherited_table</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">inherited_persist_selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">inherited_persist_selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inherited_table</span>
                    <span class="p">):</span>
                        <span class="n">inherited_persist_selectable</span><span class="o">.</span><span class="n">_refresh_for_new_column</span><span class="p">(</span>
                            <span class="n">col</span>
                        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_mapper_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args_fn</span><span class="p">:</span>
            <span class="n">mapper_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args_fn</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapper_args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">mapper_kw</span><span class="p">:</span>
            <span class="n">mapper_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">"properties"</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
            <span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mapper_args</span><span class="p">[</span><span class="s2">"properties"</span><span class="p">])</span>

        <span class="c1"># make sure that column copies are used rather</span>
        <span class="c1"># than the original columns from any mixins</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"version_id_col"</span><span class="p">,</span> <span class="s2">"polymorphic_on"</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">mapper_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">mapper_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">"primary_key"</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
            <span class="n">mapper_args</span><span class="p">[</span><span class="s2">"primary_key"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">mapper_args</span><span class="p">[</span><span class="s2">"primary_key"</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="s2">"inherits"</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
            <span class="n">inherits_arg</span> <span class="o">=</span> <span class="n">mapper_args</span><span class="p">[</span><span class="s2">"inherits"</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherits_arg</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">):</span>
                <span class="n">inherits_arg</span> <span class="o">=</span> <span class="n">inherits_arg</span><span class="o">.</span><span class="n">class_</span>

            <span class="k">if</span> <span class="n">inherits_arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s2">"mapper inherits argument given for non-inheriting "</span>
                    <span class="s2">"class </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">mapper_args</span><span class="p">[</span><span class="s2">"inherits"</span><span class="p">])</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
            <span class="n">mapper_args</span><span class="p">[</span><span class="s2">"inherits"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mapper_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"concrete"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># note the superclass is expected to have a Mapper assigned and</span>
            <span class="c1"># not be a deferred config, as this is called within map()</span>
            <span class="n">inherited_mapper</span> <span class="o">=</span> <span class="n">class_mapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">inherited_table</span> <span class="o">=</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">local_table</span>

            <span class="c1"># single or joined inheritance</span>
            <span class="c1"># exclude any cols on the inherited table which are</span>
            <span class="c1"># not mapped on the parent class, to avoid</span>
            <span class="c1"># mapping columns specific to sibling/nephew classes</span>
            <span class="k">if</span> <span class="s2">"exclude_properties"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
                <span class="n">mapper_args</span><span class="p">[</span><span class="s2">"exclude_properties"</span><span class="p">]</span> <span class="o">=</span> <span class="n">exclude_properties</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">key</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">_columntoproperty</span>
                <span class="p">}</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">inherited_mapper</span><span class="o">.</span><span class="n">exclude_properties</span> <span class="ow">or</span> <span class="p">())</span>
                <span class="n">exclude_properties</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="c1"># look through columns in the current mapper that</span>
            <span class="c1"># are keyed to a propname different than the colname</span>
            <span class="c1"># (if names were the same, we'd have popped it out above,</span>
            <span class="c1"># in which case the mapper makes this combination).</span>
            <span class="c1"># See if the superclass has a similar column property.</span>
            <span class="c1"># If so, join them together.</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ColumnProperty</span><span class="p">):</span>
                        <span class="c1"># note here we place the subclass column</span>
                        <span class="c1"># first.  See [ticket:1892] for background.</span>
                        <span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">result_mapper_args</span> <span class="o">=</span> <span class="n">mapper_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">result_mapper_args</span><span class="p">[</span><span class="s2">"properties"</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args</span> <span class="o">=</span> <span class="n">result_mapper_args</span>

    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_mapper_arguments</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">"__mapper_cls__"</span><span class="p">):</span>
            <span class="n">mapper_cls</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                <span class="s2">"Type[Mapper[Any]]"</span><span class="p">,</span>
                <span class="n">util</span><span class="o">.</span><span class="n">unbound_method_to_callable</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">__mapper_cls__</span>  <span class="c1"># type: ignore</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapper_cls</span> <span class="o">=</span> <span class="n">Mapper</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
            <span class="s2">"__mapper__"</span><span class="p">,</span>
            <span class="n">mapper_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mapper_args</span><span class="p">),</span>
        <span class="p">)</span>


<span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">"sqlalchemy.orm.decl_api"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_as_dc_declaredattr</span><span class="p">(</span>
    <span class="n">field_metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="c1"># wrap lambdas inside dataclass fields inside an ad-hoc declared_attr.</span>
    <span class="c1"># we can't write it because field.metadata is immutable :( so we have</span>
    <span class="c1"># to go through extra trouble to compare these</span>
    <span class="n">decl_api</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_decl_api</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">field_metadata</span><span class="p">[</span><span class="n">sa_dataclass_metadata_key</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">decl_api</span><span class="o">.</span><span class="n">declared_attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">decl_api</span><span class="o">.</span><span class="n">declared_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span>


<span class="k">class</span> <span class="nc">_DeferredMapperConfig</span><span class="p">(</span><span class="n">_ClassScanMapperConfig</span><span class="p">):</span>
    <span class="n">_cls</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>

    <span class="n">is_deferred</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">_configs</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">[</span>
        <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">_DeferredMapperConfig</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_early_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># mypy disallows plain property override of variable</span>
    <span class="nd">@property</span>  <span class="c1"># type: ignore</span>
    <span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

    <span class="nd">@cls</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_config_cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_remove_config_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># 2.6 fails on weakref if class_ is an old style class</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">raise_unmapped_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="s2">"_sa_raise_deferred_config"</span><span class="p">):</span>
            <span class="n">class_</span><span class="o">.</span><span class="n">_sa_raise_deferred_config</span><span class="p">()</span>

        <span class="k">raise</span> <span class="n">orm_exc</span><span class="o">.</span><span class="n">UnmappedClassError</span><span class="p">(</span>
            <span class="n">class_</span><span class="p">,</span>
            <span class="n">msg</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Class </span><span class="si">{</span><span class="n">orm_exc</span><span class="o">.</span><span class="n">_safe_cls_name</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span><span class="si">}</span><span class="s2"> has a deferred "</span>
                <span class="s2">"mapping on it.  It is not yet usable as a mapped class."</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">config_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_DeferredMapperConfig</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span><span class="p">[</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">class_</span><span class="p">)]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">classes_for_base</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">base_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_DeferredMapperConfig</span><span class="p">]:</span>
        <span class="n">classes_for_base</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">m</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">cls_</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">cls_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="n">base_cls</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sort</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">classes_for_base</span>

        <span class="n">all_m_by_cls</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="o">.</span><span class="n">cls</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">classes_for_base</span><span class="p">}</span>

        <span class="n">tuples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_DeferredMapperConfig</span><span class="p">,</span> <span class="n">_DeferredMapperConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m_cls</span> <span class="ow">in</span> <span class="n">all_m_by_cls</span><span class="p">:</span>
            <span class="n">tuples</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">(</span><span class="n">all_m_by_cls</span><span class="p">[</span><span class="n">base_cls</span><span class="p">],</span> <span class="n">all_m_by_cls</span><span class="p">[</span><span class="n">m_cls</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">base_cls</span> <span class="ow">in</span> <span class="n">m_cls</span><span class="o">.</span><span class="vm">__bases__</span>
                <span class="k">if</span> <span class="n">base_cls</span> <span class="ow">in</span> <span class="n">all_m_by_cls</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">topological</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span> <span class="n">classes_for_base</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_attribute</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""add an attribute to an existing declarative class.</span>

<span class="sd">    This runs through the logic to determine MapperProperty,</span>
<span class="sd">    adds it to the Mapper, adds a column to the mapped Table, etc.</span>

<span class="sd">    """</span>

    <span class="k">if</span> <span class="s2">"__mapper__"</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
        <span class="n">mapped_cls</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">"MappedClassProtocol[Any]"</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_table_or_raise</span><span class="p">(</span><span class="n">mc</span><span class="p">:</span> <span class="n">MappedClassProtocol</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">__table__</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">mc</span><span class="o">.</span><span class="n">__table__</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Cannot add a new attribute to mapped class </span><span class="si">{</span><span class="n">mc</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> "</span>
                <span class="s2">"because it's not mapped against a table."</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
            <span class="n">_undefer_column_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">_table_or_raise</span><span class="p">(</span><span class="n">mapped_cls</span><span class="p">)</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">replace_existing</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">):</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">mapper_property_to_assign</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">columns_to_assign</span><span class="p">:</span>
                <span class="n">_undefer_column_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                <span class="n">_table_or_raise</span><span class="p">(</span><span class="n">mapped_cls</span><span class="p">)</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span>
                    <span class="n">col</span><span class="p">,</span> <span class="n">replace_existing</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mp</span><span class="p">:</span>
                    <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mp</span><span class="p">:</span>
                <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">key</span><span class="p">:</span>
            <span class="c1"># detect a QueryableAttribute that's already mapped being</span>
            <span class="c1"># assigned elsewhere in userland, turn into a synonym()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">SynonymProperty</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">type</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">_expire_memoizations</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">type</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_del_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">"__mapper__"</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">cast</span><span class="p">(</span>
            <span class="s2">"MappedClassProtocol[Any]"</span><span class="p">,</span> <span class="bp">cls</span>
        <span class="p">)</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">_dispose_called</span>
    <span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">"Can't un-map individual mapped attributes on a mapped class."</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">type</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">cast</span><span class="p">(</span>
                <span class="s2">"MappedClassProtocol[Any]"</span><span class="p">,</span> <span class="bp">cls</span>
            <span class="p">)</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">_expire_memoizations</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">type</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_declarative_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A simple constructor that allows initialization from kwargs.</span>

<span class="sd">    Sets attributes on the constructed instance using the names and</span>
<span class="sd">    values in ``kwargs``.</span>

<span class="sd">    Only keys that are present as</span>
<span class="sd">    attributes of the instance's class are allowed. These could be,</span>
<span class="sd">    for example, any mapped columns or relationships.</span>
<span class="sd">    """</span>
    <span class="n">cls_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">"</span><span class="si">%r</span><span class="s2"> is an invalid keyword argument for </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>


<span class="n">_declarative_constructor</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s2">"__init__"</span>


<span class="k">def</span> <span class="nf">_undefer_column_name</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">key</span>
</pre></div>
</article>
</div>
</div>
<footer class="bd-footer-content">
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>
<footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
<div class="footer-items__start">
<div class="footer-item">
<p class="copyright">
    
      Â© Copyright 2023, LangChain Inc.
      <br/>
</p>
</div>
</div>
</div>
</footer>
</body>
</html>