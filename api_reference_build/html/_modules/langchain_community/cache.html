
<!DOCTYPE html>

<html data-content_root="" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>langchain_community.cache â€” ðŸ¦œðŸ”— LangChain  documentation</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/autodoc_pydantic.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/css/custom.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" rel="preload"/>
<link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" rel="preload"/>
<script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>
<script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
<script src="../../_static/doctools.js"></script>
<script src="../../_static/sphinx_highlight.js"></script>
<script src="../../_static/clipboard.min.js"></script>
<script src="../../_static/copybutton.js"></script>
<script src="../../_static/design-tabs.js"></script>
<script>DOCUMENTATION_OPTIONS.pagename = '_modules/langchain_community/cache';</script>
<link href="../../_static/favicon.png" rel="icon"/>
<link href="../../search.html" rel="search" title="Search"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
<meta content="Sep 09, 2024" name="docbuild:last-update"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
<div class="skip-link d-print-none" id="pst-skip-link"><a href="#main-content">Skip to main content</a></div>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>Back to top</button>
<input class="sidebar-toggle" id="pst-primary-sidebar-checkbox" type="checkbox"/>
<label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
<input class="sidebar-toggle" id="pst-secondary-sidebar-checkbox" type="checkbox"/>
<label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
</div>
<div class="pst-async-banner-revealer d-none">
<aside aria-label="Version warning" class="d-none d-print-none" id="bd-header-version-warning"></aside>
</div>
<header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
<button aria-label="Site navigation" class="pst-navbar-icon sidebar-toggle primary-toggle">
<span class="fa-solid fa-bars"></span>
</button>
<div class="navbar-header-items__start">
<div class="navbar-item">
<a class="navbar-brand logo" href="../../index.html">
<img alt="ðŸ¦œðŸ”— LangChain  documentation - Home" class="logo__image only-light" src="../../_static/wordmark-api.svg"/>
<script>document.write(`<img src="../../_static/wordmark-api-dark.svg" class="logo__image only-dark" alt="ðŸ¦œðŸ”— LangChain  documentation - Home"/>`);</script>
</a></div>
</div>
<div class="navbar-header-items">
<div class="me-auto navbar-header-items__center">
<div class="navbar-item">
<nav>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../reference.html">
    Reference
  </a>
</li>
<li class="nav-item">
<a class="nav-link nav-external" href="https://api.python.langchain.com/">
    Legacy reference
  </a>
</li>
</ul>
</nav></div>
</div>
<div class="navbar-header-items__end">
<div class="navbar-item navbar-persistent--container">
<form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
<div class="navbar-item"><!-- This will display a link to LangChain docs -->
<head>
<style>
        .text-link {
            text-decoration: none; /* Remove underline */
            color: inherit;        /* Inherit color from parent element */
        }
    </style>
</head>
<body>
<a class="text-link" href="https://python.langchain.com/">Docs</a>
</body></div>
<div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
<div class="navbar-item"><ul aria-label="Quick Links" class="navbar-icon-links">
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/langchain-ai/langchain" rel="noopener" target="_blank" title="GitHub"><i aria-hidden="true" class="fa-brands fa-square-github fa-lg"></i>
<span class="sr-only">GitHub</span></a>
</li>
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/langchainai" rel="noopener" target="_blank" title="X / Twitter"><i aria-hidden="true" class="fab fa-twitter-square fa-lg"></i>
<span class="sr-only">X / Twitter</span></a>
</li>
</ul></div>
</div>
</div>
<div class="navbar-persistent--mobile">
<form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search" spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
</div>
</header>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar hide-on-wide">
<div class="sidebar-header-items sidebar-primary__section">
<div class="sidebar-header-items__center">
<div class="navbar-item">
<nav>
<ul class="bd-navbar-elements navbar-nav">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../reference.html">
    Reference
  </a>
</li>
<li class="nav-item">
<a class="nav-link nav-external" href="https://api.python.langchain.com/">
    Legacy reference
  </a>
</li>
</ul>
</nav></div>
</div>
<div class="sidebar-header-items__end">
<div class="navbar-item"><!-- This will display a link to LangChain docs -->
<head>
<style>
        .text-link {
            text-decoration: none; /* Remove underline */
            color: inherit;        /* Inherit color from parent element */
        }
    </style>
</head>
<body>
<a class="text-link" href="https://python.langchain.com/">Docs</a>
</body></div>
<div class="navbar-item">
<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
<div class="navbar-item"><ul aria-label="Quick Links" class="navbar-icon-links">
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/langchain-ai/langchain" rel="noopener" target="_blank" title="GitHub"><i aria-hidden="true" class="fa-brands fa-square-github fa-lg"></i>
<span class="sr-only">GitHub</span></a>
</li>
<li class="nav-item">
<a class="nav-link pst-navbar-icon" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/langchainai" rel="noopener" target="_blank" title="X / Twitter"><i aria-hidden="true" class="fab fa-twitter-square fa-lg"></i>
<span class="sr-only">X / Twitter</span></a>
</li>
</ul></div>
</div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content" role="main">
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item">
<nav aria-label="Breadcrumb" class="d-print-none">
<ul class="bd-breadcrumbs">
<li class="breadcrumb-item breadcrumb-home">
<a aria-label="Home" class="nav-link" href="../../index.html">
<i class="fa-solid fa-home"></i>
</a>
</li>
<li class="breadcrumb-item"><a class="nav-link" href="../index.html">Module code</a></li>
<li aria-current="page" class="breadcrumb-item active">langchain_co...</li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article">
<h1>Source code for langchain_community.cache</h1><div class="highlight"><pre>
<span></span><span class="sd">"""</span>
<span class="sd">.. warning::</span>
<span class="sd">  Beta Feature!</span>

<span class="sd">**Cache** provides an optional caching layer for LLMs.</span>

<span class="sd">Cache is useful for two reasons:</span>

<span class="sd">- It can save you money by reducing the number of API calls you make to the LLM</span>
<span class="sd">  provider if you're often requesting the same completion multiple times.</span>
<span class="sd">- It can speed up your application by reducing the number of API calls you make</span>
<span class="sd">  to the LLM provider.</span>

<span class="sd">Cache directly competes with Memory. See documentation for Pros and Cons.</span>

<span class="sd">**Class hierarchy:**</span>

<span class="sd">.. code-block::</span>

<span class="sd">    BaseCache --&gt; &lt;name&gt;Cache  # Examples: InMemoryCache, RedisCache, GPTCache</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">Row</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine.base</span> <span class="kn">import</span> <span class="n">Engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="kn">from</span> <span class="nn">langchain_community.utilities.cassandra</span> <span class="kn">import</span> <span class="n">SetupMode</span> <span class="k">as</span> <span class="n">CassandraSetupMode</span>
<span class="kn">from</span> <span class="nn">langchain_community.vectorstores.azure_cosmos_db</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CosmosDBSimilarityType</span><span class="p">,</span>
    <span class="n">CosmosDBVectorSearchType</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">langchain_community.vectorstores.utils</span> <span class="kn">import</span> <span class="n">DistanceStrategy</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="kn">from</span> <span class="nn">langchain_core._api.deprecation</span> <span class="kn">import</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">warn_deprecated</span>
<span class="kn">from</span> <span class="nn">langchain_core.caches</span> <span class="kn">import</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">,</span> <span class="n">BaseCache</span>
<span class="kn">from</span> <span class="nn">langchain_core.embeddings</span> <span class="kn">import</span> <span class="n">Embeddings</span>
<span class="kn">from</span> <span class="nn">langchain_core.language_models.llms</span> <span class="kn">import</span> <span class="n">LLM</span><span class="p">,</span> <span class="n">aget_prompts</span><span class="p">,</span> <span class="n">get_prompts</span>
<span class="kn">from</span> <span class="nn">langchain_core.load.dump</span> <span class="kn">import</span> <span class="n">dumps</span>
<span class="kn">from</span> <span class="nn">langchain_core.load.load</span> <span class="kn">import</span> <span class="n">loads</span>
<span class="kn">from</span> <span class="nn">langchain_core.outputs</span> <span class="kn">import</span> <span class="n">ChatGeneration</span><span class="p">,</span> <span class="n">Generation</span>
<span class="kn">from</span> <span class="nn">langchain_core.utils</span> <span class="kn">import</span> <span class="n">get_from_env</span>

<span class="kn">from</span> <span class="nn">langchain_community.utilities.astradb</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SetupMode</span> <span class="k">as</span> <span class="n">AstraSetupMode</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">langchain_community.utilities.astradb</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_AstraDBCollectionEnvironment</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">langchain_community.vectorstores</span> <span class="kn">import</span> <span class="n">AzureCosmosDBVectorSearch</span>
<span class="kn">from</span> <span class="nn">langchain_community.vectorstores</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OpenSearchVectorSearch</span> <span class="k">as</span> <span class="n">OpenSearchVectorStore</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">langchain_community.vectorstores.redis</span> <span class="kn">import</span> <span class="n">Redis</span> <span class="k">as</span> <span class="n">RedisVectorstore</span>
<span class="kn">from</span> <span class="nn">langchain_community.vectorstores.singlestoredb</span> <span class="kn">import</span> <span class="n">SingleStoreDB</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">momento</span>
    <span class="kn">from</span> <span class="nn">astrapy.db</span> <span class="kn">import</span> <span class="n">AstraDB</span><span class="p">,</span> <span class="n">AsyncAstraDB</span>
    <span class="kn">from</span> <span class="nn">cassandra.cluster</span> <span class="kn">import</span> <span class="n">Session</span> <span class="k">as</span> <span class="n">CassandraSession</span>


<span class="k">def</span> <span class="nf">_hash</span><span class="p">(</span><span class="n">_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Use a deterministic hashing approach."""</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">_input</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_dump_generations_to_json</span><span class="p">(</span><span class="n">generations</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Dump generations to json.</span>

<span class="sd">    Args:</span>
<span class="sd">        generations (RETURN_VAL_TYPE): A list of language model generations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Json representing a list of generations.</span>

<span class="sd">    Warning: would not work well with arbitrary subclasses of `Generation`</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">generation</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">generation</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_load_generations_from_json</span><span class="p">(</span><span class="n">generations_json</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Load generations from json.</span>

<span class="sd">    Args:</span>
<span class="sd">        generations_json (str): A string of json representing a list of generations.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Could not decode json string to list of generations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        RETURN_VAL_TYPE: A list of generations.</span>

<span class="sd">    Warning: would not work well with arbitrary subclasses of `Generation`</span>
<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">generations_json</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Generation</span><span class="p">(</span><span class="o">**</span><span class="n">generation_dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">generation_dict</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Could not decode json to list of generations: </span><span class="si">{</span><span class="n">generations_json</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_dumps_generations</span><span class="p">(</span><span class="n">generations</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Serialization for generic RETURN_VAL_TYPE, i.e. sequence of `Generation`</span>

<span class="sd">    Args:</span>
<span class="sd">        generations (RETURN_VAL_TYPE): A list of language model generations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: a single string representing a list of generations.</span>

<span class="sd">    This function (+ its counterpart `_loads_generations`) rely on</span>
<span class="sd">    the dumps/loads pair with Reviver, so are able to deal</span>
<span class="sd">    with all subclasses of Generation.</span>

<span class="sd">    Each item in the list can be `dumps`ed to a string,</span>
<span class="sd">    then we make the whole list of strings into a json-dumped.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">dumps</span><span class="p">(</span><span class="n">_item</span><span class="p">)</span> <span class="k">for</span> <span class="n">_item</span> <span class="ow">in</span> <span class="n">generations</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_loads_generations</span><span class="p">(</span><span class="n">generations_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Deserialization of a string into a generic RETURN_VAL_TYPE</span>
<span class="sd">    (i.e. a sequence of `Generation`).</span>

<span class="sd">    See `_dumps_generations`, the inverse of this function.</span>

<span class="sd">    Args:</span>
<span class="sd">        generations_str (str): A string representing a list of generations.</span>

<span class="sd">    Compatible with the legacy cache-blob format</span>
<span class="sd">    Does not raise exceptions for malformed entries, just logs a warning</span>
<span class="sd">    and returns none: the caller should be prepared for such a cache miss.</span>

<span class="sd">    Returns:</span>
<span class="sd">        RETURN_VAL_TYPE: A list of generations.</span>
<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">generations</span> <span class="o">=</span> <span class="p">[</span><span class="n">loads</span><span class="p">(</span><span class="n">_item_str</span><span class="p">)</span> <span class="k">for</span> <span class="n">_item_str</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">generations_str</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">generations</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="c1"># deferring the (soft) handling to after the legacy-format attempt</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">gen_dicts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">generations_str</span><span class="p">)</span>
        <span class="c1"># not relying on `_load_generations_from_json` (which could disappear):</span>
        <span class="n">generations</span> <span class="o">=</span> <span class="p">[</span><span class="n">Generation</span><span class="p">(</span><span class="o">**</span><span class="n">generation_dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">generation_dict</span> <span class="ow">in</span> <span class="n">gen_dicts</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Legacy 'Generation' cached blob encountered: '</span><span class="si">{</span><span class="n">generations_str</span><span class="si">}</span><span class="s2">'"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">generations</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Malformed/unparsable cached blob encountered: '</span><span class="si">{</span><span class="n">generations_str</span><span class="si">}</span><span class="s2">'"</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="InMemoryCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.InMemoryCache.html#langchain_community.cache.InMemoryCache">[docs]</a><span class="k">class</span> <span class="nc">InMemoryCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that stores things in memory."""</span>

<div class="viewcode-block" id="InMemoryCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.InMemoryCache.html#langchain_community.cache.InMemoryCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Initialize with empty cache."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="InMemoryCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.InMemoryCache.html#langchain_community.cache.InMemoryCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="InMemoryCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.InMemoryCache.html#langchain_community.cache.InMemoryCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache based on prompt and llm_string."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)]</span> <span class="o">=</span> <span class="n">return_val</span></div>

<div class="viewcode-block" id="InMemoryCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.InMemoryCache.html#langchain_community.cache.InMemoryCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear cache."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="InMemoryCache.alookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.InMemoryCache.html#langchain_community.cache.InMemoryCache.alookup">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">alookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="InMemoryCache.aupdate"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.InMemoryCache.html#langchain_community.cache.InMemoryCache.aupdate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aupdate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache based on prompt and llm_string."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">,</span> <span class="n">return_val</span><span class="p">)</span></div>

<div class="viewcode-block" id="InMemoryCache.aclear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.InMemoryCache.html#langchain_community.cache.InMemoryCache.aclear">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear cache."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div></div>


<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>


<div class="viewcode-block" id="FullLLMCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.FullLLMCache.html#langchain_community.cache.FullLLMCache">[docs]</a><span class="k">class</span> <span class="nc">FullLLMCache</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
<span class="w">    </span><span class="sd">"""SQLite table for full LLM Cache (all generations)."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"full_llm_cache"</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLAlchemyCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyCache.html#langchain_community.cache.SQLAlchemyCache">[docs]</a><span class="k">class</span> <span class="nc">SQLAlchemyCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that uses SQAlchemy as a backend."""</span>

<div class="viewcode-block" id="SQLAlchemyCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyCache.html#langchain_community.cache.SQLAlchemyCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">cache_schema</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">FullLLMCache</span><span class="p">]</span> <span class="o">=</span> <span class="n">FullLLMCache</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize by creating all tables."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span> <span class="o">=</span> <span class="n">cache_schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLAlchemyCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyCache.html#langchain_community.cache.SQLAlchemyCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">prompt</span> <span class="o">==</span> <span class="n">prompt</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">llm</span> <span class="o">==</span> <span class="n">llm_string</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">"Retrieving a cache value that could not be deserialized "</span>
                        <span class="s2">"properly. This is likely due to the cache being in an "</span>
                        <span class="s2">"older format. Please recreate your cache to avoid this "</span>
                        <span class="s2">"error."</span>
                    <span class="p">)</span>
                    <span class="c1"># In a previous life we stored the raw text directly</span>
                    <span class="c1"># in the table, so assume it's in that format.</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">Generation</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SQLAlchemyCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyCache.html#langchain_community.cache.SQLAlchemyCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update based on prompt and llm_string."""</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="n">llm_string</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">dumps</span><span class="p">(</span><span class="n">gen</span><span class="p">),</span> <span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gen</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLAlchemyCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyCache.html#langchain_community.cache.SQLAlchemyCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear cache."""</span>
        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="SQLiteCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLiteCache.html#langchain_community.cache.SQLiteCache">[docs]</a><span class="k">class</span> <span class="nc">SQLiteCache</span><span class="p">(</span><span class="n">SQLAlchemyCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that uses SQLite as a backend."""</span>

<div class="viewcode-block" id="SQLiteCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLiteCache.html#langchain_community.cache.SQLiteCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">".langchain.db"</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize by creating the engine and all tables."""</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sqlite:///</span><span class="si">{</span><span class="n">database_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UpstashRedisCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.UpstashRedisCache.html#langchain_community.cache.UpstashRedisCache">[docs]</a><span class="k">class</span> <span class="nc">UpstashRedisCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that uses Upstash Redis as a backend."""</span>

<div class="viewcode-block" id="UpstashRedisCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.UpstashRedisCache.html#langchain_community.cache.UpstashRedisCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Initialize an instance of UpstashRedisCache.</span>

<span class="sd">        This method initializes an object with Upstash Redis caching capabilities.</span>
<span class="sd">        It takes a `redis_` parameter, which should be an instance of an Upstash Redis</span>
<span class="sd">        client class, allowing the object to interact with Upstash Redis</span>
<span class="sd">        server for caching purposes.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            redis_: An instance of Upstash Redis client class</span>
<span class="sd">                (e.g., Redis) used for caching.</span>
<span class="sd">                This allows the object to communicate with</span>
<span class="sd">                Redis server for caching operations on.</span>
<span class="sd">            ttl (int, optional): Time-to-live (TTL) for cached items in seconds.</span>
<span class="sd">                If provided, it sets the time duration for how long cached</span>
<span class="sd">                items will remain valid. If not provided, cached items will not</span>
<span class="sd">                have an automatic expiration.</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">upstash_redis</span> <span class="kn">import</span> <span class="n">Redis</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">"Could not import upstash_redis python package. "</span>
                <span class="s2">"Please install it with `pip install upstash_redis`."</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">redis_</span><span class="p">,</span> <span class="n">Redis</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Please pass in Upstash Redis object."</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl</span></div>

    <span class="k">def</span> <span class="nf">_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute key from prompt and llm_string"""</span>
        <span class="k">return</span> <span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="n">llm_string</span><span class="p">)</span>

<div class="viewcode-block" id="UpstashRedisCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.UpstashRedisCache.html#langchain_community.cache.UpstashRedisCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="n">generations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Read from a HASH</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">generations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Generation</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">generations</span> <span class="k">if</span> <span class="n">generations</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="UpstashRedisCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.UpstashRedisCache.html#langchain_community.cache.UpstashRedisCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache based on prompt and llm_string."""</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">Generation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"UpstashRedisCache supports caching of normal LLM generations, "</span>
                    <span class="sa">f</span><span class="s2">"got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">ChatGeneration</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">"NOTE: Generation has not been cached. UpstashRedisCache does not"</span>
                    <span class="s2">" support caching ChatModel outputs."</span>
                <span class="p">)</span>
                <span class="k">return</span>
        <span class="c1"># Write to a HASH</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>

        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span> <span class="n">generation</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">generation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">mapping</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpstashRedisCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.UpstashRedisCache.html#langchain_community.cache.UpstashRedisCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Clear cache. If `asynchronous` is True, flush asynchronously.</span>
<span class="sd">        This flushes the *whole* db.</span>
<span class="sd">        """</span>
        <span class="n">asynchronous</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"asynchronous"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">asynchronous</span><span class="p">:</span>
            <span class="n">asynchronous</span> <span class="o">=</span> <span class="s2">"ASYNC"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">asynchronous</span> <span class="o">=</span> <span class="s2">"SYNC"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">flushdb</span><span class="p">(</span><span class="n">flush_type</span><span class="o">=</span><span class="n">asynchronous</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">_RedisCacheBase</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_key</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute key from prompt and llm_string"""</span>
        <span class="k">return</span> <span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="n">llm_string</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_ensure_generation_type</span><span class="p">(</span><span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">Generation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"RedisCache only supports caching of normal LLM generations, "</span>
                    <span class="sa">f</span><span class="s2">"got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_generations</span><span class="p">(</span>
        <span class="n">results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Generation</span><span class="p">]]:</span>
        <span class="n">generations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">generations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loads</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">"Retrieving a cache value that could not be deserialized "</span>
                        <span class="s2">"properly. This is likely due to the cache being in an "</span>
                        <span class="s2">"older format. Please recreate your cache to avoid this "</span>
                        <span class="s2">"error."</span>
                    <span class="p">)</span>
                    <span class="c1"># In a previous life we stored the raw text directly</span>
                    <span class="c1"># in the table, so assume it's in that format.</span>
                    <span class="n">generations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Generation</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">))</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">return</span> <span class="n">generations</span> <span class="k">if</span> <span class="n">generations</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_configure_pipeline_for_update</span><span class="p">(</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pipe</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span> <span class="n">dumps</span><span class="p">(</span><span class="n">generation</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">generation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">ttl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ttl</span><span class="p">)</span>


<div class="viewcode-block" id="RedisCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.RedisCache.html#langchain_community.cache.RedisCache">[docs]</a><span class="k">class</span> <span class="nc">RedisCache</span><span class="p">(</span><span class="n">_RedisCacheBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Cache that uses Redis as a backend. Allows to use a sync `redis.Redis` client.</span>
<span class="sd">    """</span>

<div class="viewcode-block" id="RedisCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.RedisCache.html#langchain_community.cache.RedisCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Initialize an instance of RedisCache.</span>

<span class="sd">        This method initializes an object with Redis caching capabilities.</span>
<span class="sd">        It takes a `redis_` parameter, which should be an instance of a Redis</span>
<span class="sd">        client class (`redis.Redis`), allowing the object</span>
<span class="sd">        to interact with a Redis server for caching purposes.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            redis_ (Any): An instance of a Redis client class</span>
<span class="sd">                (`redis.Redis`) to be used for caching.</span>
<span class="sd">                This allows the object to communicate with a</span>
<span class="sd">                Redis server for caching operations.</span>
<span class="sd">            ttl (int, optional): Time-to-live (TTL) for cached items in seconds.</span>
<span class="sd">                If provided, it sets the time duration for how long cached</span>
<span class="sd">                items will remain valid. If not provided, cached items will not</span>
<span class="sd">                have an automatic expiration.</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">"Could not import `redis` python package. "</span>
                <span class="s2">"Please install it with `pip install redis`."</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">redis_</span><span class="p">,</span> <span class="n">Redis</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Please pass a valid `redis.Redis` client."</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl</span></div>

<div class="viewcode-block" id="RedisCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.RedisCache.html#langchain_community.cache.RedisCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="c1"># Read from a Redis HASH</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_generations</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Redis lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="RedisCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.RedisCache.html#langchain_community.cache.RedisCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache based on prompt and llm_string."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_generation_type</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span> <span class="k">as</span> <span class="n">pipe</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_configure_pipeline_for_update</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">return_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span><span class="p">)</span>
                <span class="n">pipe</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Redis update failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span></div>

<div class="viewcode-block" id="RedisCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.RedisCache.html#langchain_community.cache.RedisCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear cache. If `asynchronous` is True, flush asynchronously."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">asynchronous</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"asynchronous"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">flushdb</span><span class="p">(</span><span class="n">asynchronous</span><span class="o">=</span><span class="n">asynchronous</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Redis clear failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AsyncRedisCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AsyncRedisCache.html#langchain_community.cache.AsyncRedisCache">[docs]</a><span class="k">class</span> <span class="nc">AsyncRedisCache</span><span class="p">(</span><span class="n">_RedisCacheBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Cache that uses Redis as a backend. Allows to use an</span>
<span class="sd">    async `redis.asyncio.Redis` client.</span>
<span class="sd">    """</span>

<div class="viewcode-block" id="AsyncRedisCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AsyncRedisCache.html#langchain_community.cache.AsyncRedisCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Initialize an instance of AsyncRedisCache.</span>

<span class="sd">        This method initializes an object with Redis caching capabilities.</span>
<span class="sd">        It takes a `redis_` parameter, which should be an instance of a Redis</span>
<span class="sd">        client class (`redis.asyncio.Redis`), allowing the object</span>
<span class="sd">        to interact with a Redis server for caching purposes.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            redis_ (Any): An instance of a Redis client class</span>
<span class="sd">                (`redis.asyncio.Redis`) to be used for caching.</span>
<span class="sd">                This allows the object to communicate with a</span>
<span class="sd">                Redis server for caching operations.</span>
<span class="sd">            ttl (int, optional): Time-to-live (TTL) for cached items in seconds.</span>
<span class="sd">                If provided, it sets the time duration for how long cached</span>
<span class="sd">                items will remain valid. If not provided, cached items will not</span>
<span class="sd">                have an automatic expiration.</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">redis.asyncio</span> <span class="kn">import</span> <span class="n">Redis</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">"Could not import `redis.asyncio` python package. "</span>
                <span class="s2">"Please install it with `pip install redis`."</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">redis_</span><span class="p">,</span> <span class="n">Redis</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Please pass a valid `redis.asyncio.Redis` client."</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl</span></div>

<div class="viewcode-block" id="AsyncRedisCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AsyncRedisCache.html#langchain_community.cache.AsyncRedisCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">"This async Redis cache does not implement `lookup()` method. "</span>
            <span class="s2">"Consider using the async `alookup()` version."</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AsyncRedisCache.alookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AsyncRedisCache.html#langchain_community.cache.AsyncRedisCache.alookup">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">alookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string. Async version."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_generations</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Redis async lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AsyncRedisCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AsyncRedisCache.html#langchain_community.cache.AsyncRedisCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache based on prompt and llm_string."""</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">"This async Redis cache does not implement `update()` method. "</span>
            <span class="s2">"Consider using the async `aupdate()` version."</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AsyncRedisCache.aupdate"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AsyncRedisCache.html#langchain_community.cache.AsyncRedisCache.aupdate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aupdate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache based on prompt and llm_string. Async version."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_generation_type</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span> <span class="k">as</span> <span class="n">pipe</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_configure_pipeline_for_update</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">return_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">pipe</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Redis async update failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncRedisCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AsyncRedisCache.html#langchain_community.cache.AsyncRedisCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear cache. If `asynchronous` is True, flush asynchronously."""</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">"This async Redis cache does not implement `clear()` method. "</span>
            <span class="s2">"Consider using the async `aclear()` version."</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AsyncRedisCache.aclear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AsyncRedisCache.html#langchain_community.cache.AsyncRedisCache.aclear">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Clear cache. If `asynchronous` is True, flush asynchronously.</span>
<span class="sd">        Async version.</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">asynchronous</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"asynchronous"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">flushdb</span><span class="p">(</span><span class="n">asynchronous</span><span class="o">=</span><span class="n">asynchronous</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Redis async clear failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RedisSemanticCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.RedisSemanticCache.html#langchain_community.cache.RedisSemanticCache">[docs]</a><span class="k">class</span> <span class="nc">RedisSemanticCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that uses Redis as a vector-store backend."""</span>

    <span class="c1"># TODO - implement a TTL policy in Redis</span>

    <span class="n">DEFAULT_SCHEMA</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"content_key"</span><span class="p">:</span> <span class="s2">"prompt"</span><span class="p">,</span>
        <span class="s2">"text"</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"prompt"</span><span class="p">},</span>
        <span class="p">],</span>
        <span class="s2">"extra"</span><span class="p">:</span> <span class="p">[{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"return_val"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"llm_string"</span><span class="p">}],</span>
    <span class="p">}</span>

<div class="viewcode-block" id="RedisSemanticCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.RedisSemanticCache.html#langchain_community.cache.RedisSemanticCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">redis_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span> <span class="n">score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize by passing in the `init` GPTCache func</span>

<span class="sd">        Args:</span>
<span class="sd">            redis_url (str): URL to connect to Redis.</span>
<span class="sd">            embedding (Embedding): Embedding provider for semantic encoding and search.</span>
<span class="sd">            score_threshold (float, 0.2):</span>

<span class="sd">        Example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from langchain_community.globals import set_llm_cache</span>

<span class="sd">            from langchain_community.cache import RedisSemanticCache</span>
<span class="sd">            from langchain_community.embeddings import OpenAIEmbeddings</span>

<span class="sd">            set_llm_cache(RedisSemanticCache(</span>
<span class="sd">                redis_url="redis://localhost:6379",</span>
<span class="sd">                embedding=OpenAIEmbeddings()</span>
<span class="sd">            ))</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RedisVectorstore</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_url</span> <span class="o">=</span> <span class="n">redis_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span> <span class="o">=</span> <span class="n">score_threshold</span></div>

    <span class="k">def</span> <span class="nf">_index_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">hashed_index</span> <span class="o">=</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"cache:</span><span class="si">{</span><span class="n">hashed_index</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span> <span class="nf">_get_llm_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RedisVectorstore</span><span class="p">:</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>

        <span class="c1"># return vectorstore client for the specific llm string</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span>

        <span class="c1"># create new vectorstore client for the specific llm string</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">RedisVectorstore</span><span class="o">.</span><span class="n">from_existing_index</span><span class="p">(</span>
                <span class="n">embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
                <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span>
                <span class="n">redis_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_url</span><span class="p">,</span>
                <span class="n">schema</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_SCHEMA</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">redis</span> <span class="o">=</span> <span class="n">RedisVectorstore</span><span class="p">(</span>
                <span class="n">embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
                <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span>
                <span class="n">redis_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_url</span><span class="p">,</span>
                <span class="n">index_schema</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_SCHEMA</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"test"</span><span class="p">)</span>
            <span class="n">redis</span><span class="o">.</span><span class="n">_create_index_if_not_exist</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">_embedding</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">redis</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span>

<div class="viewcode-block" id="RedisSemanticCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.RedisSemanticCache.html#langchain_community.cache.RedisSemanticCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear semantic cache for a given llm_string."""</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">"llm_string"</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span>
                <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">delete_documents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">redis_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">redis_url</span>
            <span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span></div>

<div class="viewcode-block" id="RedisSemanticCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.RedisSemanticCache.html#langchain_community.cache.RedisSemanticCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="n">llm_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_cache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">generations</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Read from a Hash</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">llm_cache</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">distance_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">generations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">loads</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">"return_val"</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">"Retrieving a cache value that could not be deserialized "</span>
                        <span class="s2">"properly. This is likely due to the cache being in an "</span>
                        <span class="s2">"older format. Please recreate your cache to avoid this "</span>
                        <span class="s2">"error."</span>
                    <span class="p">)</span>
                    <span class="c1"># In a previous life we stored the raw text directly</span>
                    <span class="c1"># in the table, so assume it's in that format.</span>
                    <span class="n">generations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">_load_generations_from_json</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">"return_val"</span><span class="p">])</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">generations</span> <span class="k">if</span> <span class="n">generations</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="RedisSemanticCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.RedisSemanticCache.html#langchain_community.cache.RedisSemanticCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache based on prompt and llm_string."""</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">Generation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"RedisSemanticCache only supports caching of "</span>
                    <span class="sa">f</span><span class="s2">"normal LLM generations, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
        <span class="n">llm_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_cache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"llm_string"</span><span class="p">:</span> <span class="n">llm_string</span><span class="p">,</span>
            <span class="s2">"prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s2">"return_val"</span><span class="p">:</span> <span class="n">dumps</span><span class="p">([</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">]),</span>
        <span class="p">}</span>
        <span class="n">llm_cache</span><span class="o">.</span><span class="n">add_texts</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="p">[</span><span class="n">prompt</span><span class="p">],</span> <span class="n">metadatas</span><span class="o">=</span><span class="p">[</span><span class="n">metadata</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="GPTCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.GPTCache.html#langchain_community.cache.GPTCache">[docs]</a><span class="k">class</span> <span class="nc">GPTCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that uses GPTCache as a backend."""</span>

<div class="viewcode-block" id="GPTCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.GPTCache.html#langchain_community.cache.GPTCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">init_func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize by passing in init function (default: `None`).</span>

<span class="sd">        Args:</span>
<span class="sd">            init_func (Optional[Callable[[Any], None]]): init `GPTCache` function</span>
<span class="sd">            (default: `None`)</span>

<span class="sd">        Example:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            # Initialize GPTCache with a custom init function</span>
<span class="sd">            import gptcache</span>
<span class="sd">            from gptcache.processor.pre import get_prompt</span>
<span class="sd">            from gptcache.manager.factory import get_data_manager</span>
<span class="sd">            from langchain_community.globals import set_llm_cache</span>

<span class="sd">            # Avoid multiple caches using the same file,</span>
<span class="sd">            causing different llm model caches to affect each other</span>

<span class="sd">            def init_gptcache(cache_obj: gptcache.Cache, llm str):</span>
<span class="sd">                cache_obj.init(</span>
<span class="sd">                    pre_embedding_func=get_prompt,</span>
<span class="sd">                    data_manager=manager_factory(</span>
<span class="sd">                        manager="map",</span>
<span class="sd">                        data_dir=f"map_cache_{llm}"</span>
<span class="sd">                    ),</span>
<span class="sd">                )</span>

<span class="sd">            set_llm_cache(GPTCache(init_gptcache))</span>

<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">gptcache</span>  <span class="c1"># noqa: F401</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">"Could not import gptcache python package. "</span>
                <span class="s2">"Please install it with `pip install gptcache`."</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_gptcache_func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="kc">None</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">init_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gptcache_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="k">def</span> <span class="nf">_new_gptcache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""New gptcache object"""</span>
        <span class="kn">from</span> <span class="nn">gptcache</span> <span class="kn">import</span> <span class="n">Cache</span>
        <span class="kn">from</span> <span class="nn">gptcache.manager.factory</span> <span class="kn">import</span> <span class="n">get_data_manager</span>
        <span class="kn">from</span> <span class="nn">gptcache.processor.pre</span> <span class="kn">import</span> <span class="n">get_prompt</span>

        <span class="n">_gptcache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_gptcache_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_gptcache_func</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_gptcache_func</span><span class="p">(</span><span class="n">_gptcache</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_gptcache_func</span><span class="p">(</span><span class="n">_gptcache</span><span class="p">)</span>  <span class="c1"># type: ignore[call-arg]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_gptcache</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                <span class="n">pre_embedding_func</span><span class="o">=</span><span class="n">get_prompt</span><span class="p">,</span>
                <span class="n">data_manager</span><span class="o">=</span><span class="n">get_data_manager</span><span class="p">(</span><span class="n">data_path</span><span class="o">=</span><span class="n">llm_string</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gptcache_dict</span><span class="p">[</span><span class="n">llm_string</span><span class="p">]</span> <span class="o">=</span> <span class="n">_gptcache</span>
        <span class="k">return</span> <span class="n">_gptcache</span>

    <span class="k">def</span> <span class="nf">_get_gptcache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get a cache object.</span>

<span class="sd">        When the corresponding llm model cache does not exist, it will be created."""</span>
        <span class="n">_gptcache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gptcache_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">llm_string</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_gptcache</span><span class="p">:</span>
            <span class="n">_gptcache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_gptcache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_gptcache</span>

<div class="viewcode-block" id="GPTCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.GPTCache.html#langchain_community.cache.GPTCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up the cache data.</span>
<span class="sd">        First, retrieve the corresponding cache object using the `llm_string` parameter,</span>
<span class="sd">        and then retrieve the data from the cache based on the `prompt`.</span>
<span class="sd">        """</span>
        <span class="kn">from</span> <span class="nn">gptcache.adapter.api</span> <span class="kn">import</span> <span class="n">get</span>

        <span class="n">_gptcache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gptcache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">cache_obj</span><span class="o">=</span><span class="n">_gptcache</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_loads_generations</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GPTCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.GPTCache.html#langchain_community.cache.GPTCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache.</span>
<span class="sd">        First, retrieve the corresponding cache object using the `llm_string` parameter,</span>
<span class="sd">        and then store the `prompt` and `return_val` in the cache object.</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">Generation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"GPTCache only supports caching of normal LLM generations, "</span>
                    <span class="sa">f</span><span class="s2">"got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">gptcache.adapter.api</span> <span class="kn">import</span> <span class="n">put</span>

        <span class="n">_gptcache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gptcache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">handled_data</span> <span class="o">=</span> <span class="n">_dumps_generations</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="n">put</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">handled_data</span><span class="p">,</span> <span class="n">cache_obj</span><span class="o">=</span><span class="n">_gptcache</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GPTCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.GPTCache.html#langchain_community.cache.GPTCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear cache."""</span>
        <span class="kn">from</span> <span class="nn">gptcache</span> <span class="kn">import</span> <span class="n">Cache</span>

        <span class="k">for</span> <span class="n">gptcache_instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gptcache_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">gptcache_instance</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Cache</span><span class="p">,</span> <span class="n">gptcache_instance</span><span class="p">)</span>
            <span class="n">gptcache_instance</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gptcache_dict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div></div>


<span class="k">def</span> <span class="nf">_ensure_cache_exists</span><span class="p">(</span><span class="n">cache_client</span><span class="p">:</span> <span class="n">momento</span><span class="o">.</span><span class="n">CacheClient</span><span class="p">,</span> <span class="n">cache_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create cache if it doesn't exist.</span>

<span class="sd">    Raises:</span>
<span class="sd">        SdkException: Momento service or network error</span>
<span class="sd">        Exception: Unexpected response</span>
<span class="sd">    """</span>
    <span class="kn">from</span> <span class="nn">momento.responses</span> <span class="kn">import</span> <span class="n">CreateCache</span>

    <span class="n">create_cache_response</span> <span class="o">=</span> <span class="n">cache_client</span><span class="o">.</span><span class="n">create_cache</span><span class="p">(</span><span class="n">cache_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">create_cache_response</span><span class="p">,</span> <span class="n">CreateCache</span><span class="o">.</span><span class="n">Success</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">create_cache_response</span><span class="p">,</span> <span class="n">CreateCache</span><span class="o">.</span><span class="n">CacheAlreadyExists</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">create_cache_response</span><span class="p">,</span> <span class="n">CreateCache</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">create_cache_response</span><span class="o">.</span><span class="n">inner_exception</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unexpected response cache creation: </span><span class="si">{</span><span class="n">create_cache_response</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_validate_ttl</span><span class="p">(</span><span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ttl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ttl</span> <span class="o">&lt;=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ttl must be positive but was </span><span class="si">{</span><span class="n">ttl</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>


<div class="viewcode-block" id="MomentoCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.MomentoCache.html#langchain_community.cache.MomentoCache">[docs]</a><span class="k">class</span> <span class="nc">MomentoCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that uses Momento as a backend. See https://gomomento.com/"""</span>

<div class="viewcode-block" id="MomentoCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.MomentoCache.html#langchain_community.cache.MomentoCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cache_client</span><span class="p">:</span> <span class="n">momento</span><span class="o">.</span><span class="n">CacheClient</span><span class="p">,</span>
        <span class="n">cache_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ensure_cache_exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Instantiate a prompt cache using Momento as a backend.</span>

<span class="sd">        Note: to instantiate the cache client passed to MomentoCache,</span>
<span class="sd">        you must have a Momento account. See https://gomomento.com/.</span>

<span class="sd">        Args:</span>
<span class="sd">            cache_client (CacheClient): The Momento cache client.</span>
<span class="sd">            cache_name (str): The name of the cache to use to store the data.</span>
<span class="sd">            ttl (Optional[timedelta], optional): The time to live for the cache items.</span>
<span class="sd">                Defaults to None, ie use the client default TTL.</span>
<span class="sd">            ensure_cache_exists (bool, optional): Create the cache if it doesn't</span>
<span class="sd">                exist. Defaults to True.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: Momento python package is not installed.</span>
<span class="sd">            TypeError: cache_client is not of type momento.CacheClientObject</span>
<span class="sd">            ValueError: ttl is non-null and non-negative</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">momento</span> <span class="kn">import</span> <span class="n">CacheClient</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">"Could not import momento python package. "</span>
                <span class="s2">"Please install it with `pip install momento`."</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_client</span><span class="p">,</span> <span class="n">CacheClient</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"cache_client must be a momento.CacheClient object."</span><span class="p">)</span>
        <span class="n">_validate_ttl</span><span class="p">(</span><span class="n">ttl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ensure_cache_exists</span><span class="p">:</span>
            <span class="n">_ensure_cache_exists</span><span class="p">(</span><span class="n">cache_client</span><span class="p">,</span> <span class="n">cache_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache_client</span> <span class="o">=</span> <span class="n">cache_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_name</span> <span class="o">=</span> <span class="n">cache_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">ttl</span></div>

<div class="viewcode-block" id="MomentoCache.from_client_params"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.MomentoCache.html#langchain_community.cache.MomentoCache.from_client_params">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_client_params</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">cache_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ttl</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">configuration</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">momento</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Configuration</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auth_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># for backwards compatibility</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MomentoCache</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Construct cache from CacheClient parameters."""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">momento</span> <span class="kn">import</span> <span class="n">CacheClient</span><span class="p">,</span> <span class="n">Configurations</span><span class="p">,</span> <span class="n">CredentialProvider</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">"Could not import momento python package. "</span>
                <span class="s2">"Please install it with `pip install momento`."</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">configuration</span> <span class="o">=</span> <span class="n">Configurations</span><span class="o">.</span><span class="n">Laptop</span><span class="o">.</span><span class="n">v1</span><span class="p">()</span>

        <span class="c1"># Try checking `MOMENTO_AUTH_TOKEN` first for backwards compatibility</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">auth_token</span> <span class="ow">or</span> <span class="n">get_from_env</span><span class="p">(</span><span class="s2">"auth_token"</span><span class="p">,</span> <span class="s2">"MOMENTO_AUTH_TOKEN"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">get_from_env</span><span class="p">(</span><span class="s2">"api_key"</span><span class="p">,</span> <span class="s2">"MOMENTO_API_KEY"</span><span class="p">)</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="n">CredentialProvider</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
        <span class="n">cache_client</span> <span class="o">=</span> <span class="n">CacheClient</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="n">credentials</span><span class="p">,</span> <span class="n">default_ttl</span><span class="o">=</span><span class="n">ttl</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_client</span><span class="p">,</span> <span class="n">cache_name</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="n">ttl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compute cache key from prompt and associated model and settings.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The prompt run through the language model.</span>
<span class="sd">            llm_string (str): The language model version and settings.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The cache key.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="n">llm_string</span><span class="p">)</span>

<div class="viewcode-block" id="MomentoCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.MomentoCache.html#langchain_community.cache.MomentoCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Lookup llm generations in cache by prompt and associated model and settings.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The prompt run through the language model.</span>
<span class="sd">            llm_string (str): The language model version and settings.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SdkException: Momento service or network error</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[RETURN_VAL_TYPE]: A list of language model generations.</span>
<span class="sd">        """</span>
        <span class="kn">from</span> <span class="nn">momento.responses</span> <span class="kn">import</span> <span class="n">CacheGet</span>

        <span class="n">generations</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">get_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_response</span><span class="p">,</span> <span class="n">CacheGet</span><span class="o">.</span><span class="n">Hit</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">get_response</span><span class="o">.</span><span class="n">value_string</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">_load_generations_from_json</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_response</span><span class="p">,</span> <span class="n">CacheGet</span><span class="o">.</span><span class="n">Miss</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_response</span><span class="p">,</span> <span class="n">CacheGet</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">get_response</span><span class="o">.</span><span class="n">inner_exception</span>
        <span class="k">return</span> <span class="n">generations</span> <span class="k">if</span> <span class="n">generations</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MomentoCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.MomentoCache.html#langchain_community.cache.MomentoCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Store llm generations in cache.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (str): The prompt run through the language model.</span>
<span class="sd">            llm_string (str): The language model string.</span>
<span class="sd">            return_val (RETURN_VAL_TYPE): A list of language model generations.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SdkException: Momento service or network error</span>
<span class="sd">            Exception: Unexpected response</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">Generation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"Momento only supports caching of normal LLM generations, "</span>
                    <span class="sa">f</span><span class="s2">"got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__key</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">_dump_generations_to_json</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="n">set_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">momento.responses</span> <span class="kn">import</span> <span class="n">CacheSet</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">set_response</span><span class="p">,</span> <span class="n">CacheSet</span><span class="o">.</span><span class="n">Success</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">set_response</span><span class="p">,</span> <span class="n">CacheSet</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">set_response</span><span class="o">.</span><span class="n">inner_exception</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unexpected response: </span><span class="si">{</span><span class="n">set_response</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span></div>

<div class="viewcode-block" id="MomentoCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.MomentoCache.html#langchain_community.cache.MomentoCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear the cache.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SdkException: Momento service or network error</span>
<span class="sd">        """</span>
        <span class="kn">from</span> <span class="nn">momento.responses</span> <span class="kn">import</span> <span class="n">CacheFlush</span>

        <span class="n">flush_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_client</span><span class="o">.</span><span class="n">flush_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flush_response</span><span class="p">,</span> <span class="n">CacheFlush</span><span class="o">.</span><span class="n">Success</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flush_response</span><span class="p">,</span> <span class="n">CacheFlush</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">flush_response</span><span class="o">.</span><span class="n">inner_exception</span></div></div>


<span class="n">CASSANDRA_CACHE_DEFAULT_TABLE_NAME</span> <span class="o">=</span> <span class="s2">"langchain_llm_cache"</span>
<span class="n">CASSANDRA_CACHE_DEFAULT_TTL_SECONDS</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="CassandraCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraCache.html#langchain_community.cache.CassandraCache">[docs]</a><span class="k">class</span> <span class="nc">CassandraCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Cache that uses Cassandra / Astra DB as a backend.</span>

<span class="sd">    Example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            import cassio</span>

<span class="sd">            from langchain_community.cache import CassandraCache</span>
<span class="sd">            from langchain_core.globals import set_llm_cache</span>

<span class="sd">            cassio.init(auto=True)  # Requires env. variables, see CassIO docs</span>

<span class="sd">            set_llm_cache(CassandraCache())</span>

<span class="sd">    It uses a single Cassandra table.</span>
<span class="sd">    The lookup keys (which get to form the primary key) are:</span>
<span class="sd">        - prompt, a string</span>
<span class="sd">        - llm_string, a deterministic str representation of the model parameters.</span>
<span class="sd">          (needed to prevent same-prompt-different-model collisions)</span>

<span class="sd">    Args:</span>
<span class="sd">        session: an open Cassandra session.</span>
<span class="sd">            Leave unspecified to use the global cassio init (see below)</span>
<span class="sd">        keyspace: the keyspace to use for storing the cache.</span>
<span class="sd">            Leave unspecified to use the global cassio init (see below)</span>
<span class="sd">        table_name: name of the Cassandra table to use as cache</span>
<span class="sd">        ttl_seconds: time-to-live for cache entries</span>
<span class="sd">            (default: None, i.e. forever)</span>
<span class="sd">        setup_mode: a value in langchain_community.utilities.cassandra.SetupMode.</span>
<span class="sd">            Choose between SYNC, ASYNC and OFF - the latter if the Cassandra</span>
<span class="sd">            table is guaranteed to exist already, for a faster initialization.</span>

<span class="sd">    Note:</span>
<span class="sd">        The session and keyspace parameters, when left out (or passed as None),</span>
<span class="sd">        fall back to the globally-available cassio settings if any are available.</span>
<span class="sd">        In other words, if a previously-run 'cassio.init(...)' has been</span>
<span class="sd">        executed previously anywhere in the code, Cassandra-based objects</span>
<span class="sd">        need not specify the connection parameters at all.</span>
<span class="sd">    """</span>

<div class="viewcode-block" id="CassandraCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraCache.html#langchain_community.cache.CassandraCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CassandraSession</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keyspace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CASSANDRA_CACHE_DEFAULT_TABLE_NAME</span><span class="p">,</span>
        <span class="n">ttl_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">CASSANDRA_CACHE_DEFAULT_TTL_SECONDS</span><span class="p">,</span>
        <span class="n">skip_provisioning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">setup_mode</span><span class="p">:</span> <span class="n">CassandraSetupMode</span> <span class="o">=</span> <span class="n">CassandraSetupMode</span><span class="o">.</span><span class="n">SYNC</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">skip_provisioning</span><span class="p">:</span>
            <span class="n">warn_deprecated</span><span class="p">(</span>
                <span class="s2">"0.0.33"</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"skip_provisioning"</span><span class="p">,</span>
                <span class="n">alternative</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">"setup_mode=langchain_community.utilities.cassandra.SetupMode.OFF"</span>
                <span class="p">),</span>
                <span class="n">pending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cassio.table</span> <span class="kn">import</span> <span class="n">ElasticCassandraTable</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">"Could not import cassio python package. "</span>
                <span class="s2">"Please install it with `pip install -U cassio`."</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace</span> <span class="o">=</span> <span class="n">keyspace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttl_seconds</span> <span class="o">=</span> <span class="n">ttl_seconds</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">setup_mode</span> <span class="o">==</span> <span class="n">CassandraSetupMode</span><span class="o">.</span><span class="n">ASYNC</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"async_setup"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kv_cache</span> <span class="o">=</span> <span class="n">ElasticCassandraTable</span><span class="p">(</span>
            <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="n">keyspace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s2">"llm_string"</span><span class="p">,</span> <span class="s2">"prompt"</span><span class="p">],</span>
            <span class="n">primary_key_type</span><span class="o">=</span><span class="p">[</span><span class="s2">"TEXT"</span><span class="p">,</span> <span class="s2">"TEXT"</span><span class="p">],</span>
            <span class="n">ttl_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ttl_seconds</span><span class="p">,</span>
            <span class="n">skip_provisioning</span><span class="o">=</span><span class="n">skip_provisioning</span> <span class="ow">or</span> <span class="n">setup_mode</span> <span class="o">==</span> <span class="n">CassandraSetupMode</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CassandraCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraCache.html#langchain_community.cache.CassandraCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">llm_string</span><span class="o">=</span><span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">),</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_loads_generations</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">"body_blob"</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CassandraCache.alookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraCache.html#langchain_community.cache.CassandraCache.alookup">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">alookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv_cache</span><span class="o">.</span><span class="n">aget</span><span class="p">(</span>
            <span class="n">llm_string</span><span class="o">=</span><span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">),</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_loads_generations</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">"body_blob"</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CassandraCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraCache.html#langchain_community.cache.CassandraCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">_dumps_generations</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kv_cache</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">llm_string</span><span class="o">=</span><span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">),</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span><span class="p">),</span>
            <span class="n">body_blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CassandraCache.aupdate"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraCache.html#langchain_community.cache.CassandraCache.aupdate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aupdate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">_dumps_generations</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv_cache</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span>
            <span class="n">llm_string</span><span class="o">=</span><span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">),</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span><span class="p">),</span>
            <span class="n">body_blob</span><span class="o">=</span><span class="n">blob</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CassandraCache.delete_through_llm"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraCache.html#langchain_community.cache.CassandraCache.delete_through_llm">[docs]</a>    <span class="k">def</span> <span class="nf">delete_through_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">LLM</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        A wrapper around `delete` with the LLM being passed.</span>
<span class="sd">        In case the llm.invoke(prompt) calls have a `stop` param, you should</span>
<span class="sd">        pass it here</span>
<span class="sd">        """</span>
        <span class="n">llm_string</span> <span class="o">=</span> <span class="n">get_prompts</span><span class="p">(</span>
            <span class="p">{</span><span class="o">**</span><span class="n">llm</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="o">**</span><span class="p">{</span><span class="s2">"stop"</span><span class="p">:</span> <span class="n">stop</span><span class="p">}},</span>
            <span class="p">[],</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="o">=</span><span class="n">llm_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="CassandraCache.delete"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraCache.html#langchain_community.cache.CassandraCache.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Evict from cache if there's an entry."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv_cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
            <span class="n">llm_string</span><span class="o">=</span><span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">),</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CassandraCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraCache.html#langchain_community.cache.CassandraCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear cache. This is for all LLMs at once."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kv_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="CassandraCache.aclear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraCache.html#langchain_community.cache.CassandraCache.aclear">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear cache. This is for all LLMs at once."""</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv_cache</span><span class="o">.</span><span class="n">aclear</span><span class="p">()</span></div></div>


<span class="c1"># This constant is in fact a similarity - the 'distance' name is kept for compatibility:</span>
<span class="n">CASSANDRA_SEMANTIC_CACHE_DEFAULT_DISTANCE_METRIC</span> <span class="o">=</span> <span class="s2">"dot"</span>
<span class="n">CASSANDRA_SEMANTIC_CACHE_DEFAULT_SCORE_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.85</span>
<span class="n">CASSANDRA_SEMANTIC_CACHE_DEFAULT_TABLE_NAME</span> <span class="o">=</span> <span class="s2">"langchain_llm_semantic_cache"</span>
<span class="n">CASSANDRA_SEMANTIC_CACHE_DEFAULT_TTL_SECONDS</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">CASSANDRA_SEMANTIC_CACHE_EMBEDDING_CACHE_SIZE</span> <span class="o">=</span> <span class="mi">16</span>


<div class="viewcode-block" id="CassandraSemanticCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache">[docs]</a><span class="k">class</span> <span class="nc">CassandraSemanticCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Cache that uses Cassandra as a vector-store backend for semantic</span>
<span class="sd">    (i.e. similarity-based) lookup.</span>

<span class="sd">    Example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            import cassio</span>

<span class="sd">            from langchain_community.cache import CassandraSemanticCache</span>
<span class="sd">            from langchain_core.globals import set_llm_cache</span>

<span class="sd">            cassio.init(auto=True)  # Requires env. variables, see CassIO docs</span>

<span class="sd">            my_embedding = ...</span>

<span class="sd">            set_llm_cache(CassandraSemanticCache(</span>
<span class="sd">                embedding=my_embedding,</span>
<span class="sd">                table_name="my_semantic_cache",</span>
<span class="sd">            ))</span>

<span class="sd">    It uses a single (vector) Cassandra table and stores, in principle,</span>
<span class="sd">    cached values from several LLMs, so the LLM's llm_string is part</span>
<span class="sd">    of the rows' primary keys.</span>

<span class="sd">    One can choose a similarity measure (default: "dot" for dot-product).</span>
<span class="sd">    Choosing another one ("cos", "l2") almost certainly requires threshold tuning.</span>
<span class="sd">    (which may be in order nevertheless, even if sticking to "dot").</span>

<span class="sd">    Args:</span>
<span class="sd">        session: an open Cassandra session.</span>
<span class="sd">            Leave unspecified to use the global cassio init (see below)</span>
<span class="sd">        keyspace: the keyspace to use for storing the cache.</span>
<span class="sd">            Leave unspecified to use the global cassio init (see below)</span>
<span class="sd">        embedding: Embedding provider for semantic</span>
<span class="sd">            encoding and search.</span>
<span class="sd">        table_name: name of the Cassandra (vector) table</span>
<span class="sd">            to use as cache. There is a default for "simple" usage, but</span>
<span class="sd">            remember to explicitly specify different tables if several embedding</span>
<span class="sd">            models coexist in your app (they cannot share one cache table).</span>
<span class="sd">        distance_metric: an alias for the 'similarity_measure' parameter (see below).</span>
<span class="sd">            As the "distance" terminology is misleading, please prefer</span>
<span class="sd">            'similarity_measure' for clarity.</span>
<span class="sd">        score_threshold: numeric value to use as</span>
<span class="sd">            cutoff for the similarity searches</span>
<span class="sd">        ttl_seconds: time-to-live for cache entries</span>
<span class="sd">            (default: None, i.e. forever)</span>
<span class="sd">        similarity_measure: which measure to adopt for similarity searches.</span>
<span class="sd">            Note: this parameter is aliased by 'distance_metric' - however,</span>
<span class="sd">            it is suggested to use the "similarity" terminology since this value</span>
<span class="sd">            is in fact a similarity (i.e. higher means closer).</span>
<span class="sd">            Note that at most one of the two parameters 'distance_metric'</span>
<span class="sd">            and 'similarity_measure' can be provided.</span>
<span class="sd">        setup_mode: a value in langchain_community.utilities.cassandra.SetupMode.</span>
<span class="sd">            Choose between SYNC, ASYNC and OFF - the latter if the Cassandra</span>
<span class="sd">            table is guaranteed to exist already, for a faster initialization.</span>

<span class="sd">    Note:</span>
<span class="sd">        The session and keyspace parameters, when left out (or passed as None),</span>
<span class="sd">        fall back to the globally-available cassio settings if any are available.</span>
<span class="sd">        In other words, if a previously-run 'cassio.init(...)' has been</span>
<span class="sd">        executed previously anywhere in the code, Cassandra-based objects</span>
<span class="sd">        need not specify the connection parameters at all.</span>
<span class="sd">    """</span>

<div class="viewcode-block" id="CassandraSemanticCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CassandraSession</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keyspace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Embeddings</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CASSANDRA_SEMANTIC_CACHE_DEFAULT_TABLE_NAME</span><span class="p">,</span>
        <span class="n">distance_metric</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">CASSANDRA_SEMANTIC_CACHE_DEFAULT_SCORE_THRESHOLD</span><span class="p">,</span>
        <span class="n">ttl_seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">CASSANDRA_SEMANTIC_CACHE_DEFAULT_TTL_SECONDS</span><span class="p">,</span>
        <span class="n">skip_provisioning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">similarity_measure</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CASSANDRA_SEMANTIC_CACHE_DEFAULT_DISTANCE_METRIC</span><span class="p">,</span>
        <span class="n">setup_mode</span><span class="p">:</span> <span class="n">CassandraSetupMode</span> <span class="o">=</span> <span class="n">CassandraSetupMode</span><span class="o">.</span><span class="n">SYNC</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">skip_provisioning</span><span class="p">:</span>
            <span class="n">warn_deprecated</span><span class="p">(</span>
                <span class="s2">"0.0.33"</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"skip_provisioning"</span><span class="p">,</span>
                <span class="n">alternative</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">"setup_mode=langchain_community.utilities.cassandra.SetupMode.OFF"</span>
                <span class="p">),</span>
                <span class="n">pending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cassio.table</span> <span class="kn">import</span> <span class="n">MetadataVectorCassandraTable</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">"Could not import cassio python package. "</span>
                <span class="s2">"Please install it with `pip install -U cassio`."</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">embedding</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Missing required parameter 'embedding'."</span><span class="p">)</span>

        <span class="c1"># detect if legacy 'distance_metric' parameter used</span>
        <span class="k">if</span> <span class="n">distance_metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if passed, takes precedence over 'similarity_measure', but we warn:</span>
            <span class="n">warn_deprecated</span><span class="p">(</span>
                <span class="s2">"0.0.33"</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"distance_metric"</span><span class="p">,</span>
                <span class="n">alternative</span><span class="o">=</span><span class="s2">"similarity_measure"</span><span class="p">,</span>
                <span class="n">pending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">similarity_measure</span> <span class="o">=</span> <span class="n">distance_metric</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyspace</span> <span class="o">=</span> <span class="n">keyspace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_measure</span> <span class="o">=</span> <span class="n">similarity_measure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span> <span class="o">=</span> <span class="n">score_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ttl_seconds</span> <span class="o">=</span> <span class="n">ttl_seconds</span>

        <span class="c1"># The contract for this class has separate lookup and update:</span>
        <span class="c1"># in order to spare some embedding calculations we cache them between</span>
        <span class="c1"># the two calls.</span>
        <span class="c1"># Note: each instance of this class has its own `_get_embedding` with</span>
        <span class="c1"># its own lru.</span>
        <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">CASSANDRA_SEMANTIC_CACHE_EMBEDDING_CACHE_SIZE</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_cache_embedding</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding</span> <span class="o">=</span> <span class="n">_cache_embedding</span>

        <span class="nd">@_async_lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">CASSANDRA_SEMANTIC_CACHE_EMBEDDING_CACHE_SIZE</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_acache_embedding</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">aembed_query</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_aget_embedding</span> <span class="o">=</span> <span class="n">_acache_embedding</span>

        <span class="n">embedding_dimension</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">setup_mode</span> <span class="o">==</span> <span class="n">CassandraSetupMode</span><span class="o">.</span><span class="n">ASYNC</span><span class="p">:</span>
            <span class="n">embedding_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aget_embedding_dimension</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">setup_mode</span> <span class="o">==</span> <span class="n">CassandraSetupMode</span><span class="o">.</span><span class="n">SYNC</span><span class="p">:</span>
            <span class="n">embedding_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding_dimension</span><span class="p">()</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">setup_mode</span> <span class="o">==</span> <span class="n">CassandraSetupMode</span><span class="o">.</span><span class="n">ASYNC</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"async_setup"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">MetadataVectorCassandraTable</span><span class="p">(</span>
            <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
            <span class="n">keyspace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keyspace</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
            <span class="n">primary_key_type</span><span class="o">=</span><span class="p">[</span><span class="s2">"TEXT"</span><span class="p">],</span>
            <span class="n">vector_dimension</span><span class="o">=</span><span class="n">embedding_dimension</span><span class="p">,</span>
            <span class="n">ttl_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ttl_seconds</span><span class="p">,</span>
            <span class="n">metadata_indexing</span><span class="o">=</span><span class="p">(</span><span class="s2">"allow"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"_llm_string_hash"</span><span class="p">}),</span>
            <span class="n">skip_provisioning</span><span class="o">=</span><span class="n">skip_provisioning</span> <span class="ow">or</span> <span class="n">setup_mode</span> <span class="o">==</span> <span class="n">CassandraSetupMode</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_embedding_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"This is a sample sentence."</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_aget_embedding_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aget_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"This is a sample sentence."</span><span class="p">))</span>

<div class="viewcode-block" id="CassandraSemanticCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">embedding_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">llm_string_hash</span> <span class="o">=</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">_dumps_generations</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"_prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s2">"_llm_string_hash"</span><span class="p">:</span> <span class="n">llm_string_hash</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">row_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">llm_string_hash</span><span class="si">}</span><span class="s2">"</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">body_blob</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
            <span class="n">vector</span><span class="o">=</span><span class="n">embedding_vector</span><span class="p">,</span>
            <span class="n">row_id</span><span class="o">=</span><span class="n">row_id</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.aupdate"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.aupdate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aupdate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">embedding_vector</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aget_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">llm_string_hash</span> <span class="o">=</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">_dumps_generations</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"_prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s2">"_llm_string_hash"</span><span class="p">:</span> <span class="n">llm_string_hash</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">row_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">llm_string_hash</span><span class="si">}</span><span class="s2">"</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">aput</span><span class="p">(</span>
            <span class="n">body_blob</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
            <span class="n">vector</span><span class="o">=</span><span class="n">embedding_vector</span><span class="p">,</span>
            <span class="n">row_id</span><span class="o">=</span><span class="n">row_id</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
        <span class="n">hit_with_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_with_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hit_with_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hit_with_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.alookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.alookup">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">alookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
        <span class="n">hit_with_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alookup_with_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hit_with_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hit_with_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.lookup_with_id"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.lookup_with_id">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_with_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Look up based on prompt and llm_string.</span>
<span class="sd">        If there are hits, return (document_id, cached_entry)</span>
<span class="sd">        """</span>
        <span class="n">prompt_embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">metric_ann_search</span><span class="p">(</span>
                <span class="n">vector</span><span class="o">=</span><span class="n">prompt_embedding</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">"_llm_string_hash"</span><span class="p">:</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)},</span>
                <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_measure</span><span class="p">,</span>
                <span class="n">metric_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">hits</span><span class="p">:</span>
            <span class="n">hit</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">_loads_generations</span><span class="p">(</span><span class="n">hit</span><span class="p">[</span><span class="s2">"body_blob"</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">generations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># this protects against malformed cached items:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">hit</span><span class="p">[</span><span class="s2">"row_id"</span><span class="p">],</span>
                    <span class="n">generations</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.alookup_with_id"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.alookup_with_id">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">alookup_with_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Look up based on prompt and llm_string.</span>
<span class="sd">        If there are hits, return (document_id, cached_entry)</span>
<span class="sd">        """</span>
        <span class="n">prompt_embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aget_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">ametric_ann_search</span><span class="p">(</span>
                <span class="n">vector</span><span class="o">=</span><span class="n">prompt_embedding</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">"_llm_string_hash"</span><span class="p">:</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)},</span>
                <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_measure</span><span class="p">,</span>
                <span class="n">metric_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">hits</span><span class="p">:</span>
            <span class="n">hit</span> <span class="o">=</span> <span class="n">hits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">_loads_generations</span><span class="p">(</span><span class="n">hit</span><span class="p">[</span><span class="s2">"body_blob"</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">generations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># this protects against malformed cached items:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">hit</span><span class="p">[</span><span class="s2">"row_id"</span><span class="p">],</span>
                    <span class="n">generations</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.lookup_with_id_through_llm"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.lookup_with_id_through_llm">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_with_id_through_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">LLM</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">]]:</span>
        <span class="n">llm_string</span> <span class="o">=</span> <span class="n">get_prompts</span><span class="p">(</span>
            <span class="p">{</span><span class="o">**</span><span class="n">llm</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="o">**</span><span class="p">{</span><span class="s2">"stop"</span><span class="p">:</span> <span class="n">stop</span><span class="p">}},</span>
            <span class="p">[],</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_with_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="o">=</span><span class="n">llm_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.alookup_with_id_through_llm"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.alookup_with_id_through_llm">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">alookup_with_id_through_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">LLM</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">]]:</span>
        <span class="n">llm_string</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">await</span> <span class="n">aget_prompts</span><span class="p">(</span>
                <span class="p">{</span><span class="o">**</span><span class="n">llm</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="o">**</span><span class="p">{</span><span class="s2">"stop"</span><span class="p">:</span> <span class="n">stop</span><span class="p">}},</span>
                <span class="p">[],</span>
            <span class="p">)</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alookup_with_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="o">=</span><span class="n">llm_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.delete_by_document_id"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.delete_by_document_id">[docs]</a>    <span class="k">def</span> <span class="nf">delete_by_document_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Given this is a "similarity search" cache, an invalidation pattern</span>
<span class="sd">        that makes sense is first a lookup to get an ID, and then deleting</span>
<span class="sd">        with that ID. This is for the second step.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">row_id</span><span class="o">=</span><span class="n">document_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.adelete_by_document_id"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.adelete_by_document_id">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">adelete_by_document_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Given this is a "similarity search" cache, an invalidation pattern</span>
<span class="sd">        that makes sense is first a lookup to get an ID, and then deleting</span>
<span class="sd">        with that ID. This is for the second step.</span>
<span class="sd">        """</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">adelete</span><span class="p">(</span><span class="n">row_id</span><span class="o">=</span><span class="n">document_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear the *whole* semantic cache."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="CassandraSemanticCache.aclear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.CassandraSemanticCache.html#langchain_community.cache.CassandraSemanticCache.aclear">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear the *whole* semantic cache."""</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">aclear</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="FullMd5LLMCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.FullMd5LLMCache.html#langchain_community.cache.FullMd5LLMCache">[docs]</a><span class="k">class</span> <span class="nc">FullMd5LLMCache</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
<span class="w">    </span><span class="sd">"""SQLite table for full LLM Cache (all generations)."""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"full_md5_llm_cache"</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">prompt_md5</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></div>


<div class="viewcode-block" id="SQLAlchemyMd5Cache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyMd5Cache.html#langchain_community.cache.SQLAlchemyMd5Cache">[docs]</a><span class="k">class</span> <span class="nc">SQLAlchemyMd5Cache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that uses SQAlchemy as a backend."""</span>

<div class="viewcode-block" id="SQLAlchemyMd5Cache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyMd5Cache.html#langchain_community.cache.SQLAlchemyMd5Cache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">cache_schema</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">FullMd5LLMCache</span><span class="p">]</span> <span class="o">=</span> <span class="n">FullMd5LLMCache</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize by creating all tables."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span> <span class="o">=</span> <span class="n">cache_schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLAlchemyMd5Cache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyMd5Cache.html#langchain_community.cache.SQLAlchemyMd5Cache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_rows</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SQLAlchemyMd5Cache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyMd5Cache.html#langchain_community.cache.SQLAlchemyMd5Cache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update based on prompt and llm_string."""</span>
        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete_previous</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
            <span class="n">prompt_md5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_md5</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">()),</span>
                    <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
                    <span class="n">prompt_md5</span><span class="o">=</span><span class="n">prompt_md5</span><span class="p">,</span>
                    <span class="n">llm</span><span class="o">=</span><span class="n">llm_string</span><span class="p">,</span>
                    <span class="n">response</span><span class="o">=</span><span class="n">dumps</span><span class="p">(</span><span class="n">gen</span><span class="p">),</span>
                    <span class="n">idx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gen</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_delete_previous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">prompt_md5</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_md5</span><span class="p">(</span><span class="n">prompt</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">llm</span> <span class="o">==</span> <span class="n">llm_string</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">prompt</span> <span class="o">==</span> <span class="n">prompt</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_search_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Row</span><span class="p">]:</span>
        <span class="n">prompt_pd5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_md5</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">prompt_md5</span> <span class="o">==</span> <span class="n">prompt_pd5</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">llm</span> <span class="o">==</span> <span class="n">llm_string</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">prompt</span> <span class="o">==</span> <span class="n">prompt</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

<div class="viewcode-block" id="SQLAlchemyMd5Cache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyMd5Cache.html#langchain_community.cache.SQLAlchemyMd5Cache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear cache."""</span>
        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_schema</span><span class="o">.</span><span class="n">delete</span><span class="p">())</span></div>

<div class="viewcode-block" id="SQLAlchemyMd5Cache.get_md5"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SQLAlchemyMd5Cache.html#langchain_community.cache.SQLAlchemyMd5Cache.get_md5">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_md5</span><span class="p">(</span><span class="n">input_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">input_string</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div></div>


<span class="n">ASTRA_DB_CACHE_DEFAULT_COLLECTION_NAME</span> <span class="o">=</span> <span class="s2">"langchain_astradb_cache"</span>


<div class="viewcode-block" id="AstraDBCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache">[docs]</a><span class="nd">@deprecated</span><span class="p">(</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">"0.0.28"</span><span class="p">,</span>
    <span class="n">removal</span><span class="o">=</span><span class="s2">"1.0"</span><span class="p">,</span>
    <span class="n">alternative_import</span><span class="o">=</span><span class="s2">"langchain_astradb.AstraDBCache"</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">class</span> <span class="nc">AstraDBCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>

<div class="viewcode-block" id="AstraDBCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ASTRA_DB_CACHE_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">api_endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">astra_db_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AstraDB</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">async_astra_db_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncAstraDB</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">setup_mode</span><span class="p">:</span> <span class="n">AstraSetupMode</span> <span class="o">=</span> <span class="n">AstraSetupMode</span><span class="o">.</span><span class="n">SYNC</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Cache that uses Astra DB as a backend.</span>

<span class="sd">        It uses a single collection as a kv store</span>
<span class="sd">        The lookup keys, combined in the _id of the documents, are:</span>
<span class="sd">            - prompt, a string</span>
<span class="sd">            - llm_string, a deterministic str representation of the model parameters.</span>
<span class="sd">              (needed to prevent same-prompt-different-model collisions)</span>

<span class="sd">        Args:</span>
<span class="sd">            collection_name: name of the Astra DB collection to create/use.</span>
<span class="sd">            token: API token for Astra DB usage.</span>
<span class="sd">            api_endpoint: full URL to the API endpoint,</span>
<span class="sd">                such as `https://&lt;DB-ID&gt;-us-east1.apps.astra.datastax.com`.</span>
<span class="sd">            astra_db_client: *alternative to token+api_endpoint*,</span>
<span class="sd">                you can pass an already-created 'astrapy.db.AstraDB' instance.</span>
<span class="sd">            async_astra_db_client: *alternative to token+api_endpoint*,</span>
<span class="sd">                you can pass an already-created 'astrapy.db.AsyncAstraDB' instance.</span>
<span class="sd">            namespace: namespace (aka keyspace) where the</span>
<span class="sd">                collection is created. Defaults to the database's "default namespace".</span>
<span class="sd">            setup_mode: mode used to create the Astra DB collection (SYNC, ASYNC or</span>
<span class="sd">                OFF).</span>
<span class="sd">            pre_delete_collection: whether to delete the collection</span>
<span class="sd">                before creating it. If False and the collection already exists,</span>
<span class="sd">                the collection will be used as is.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span> <span class="o">=</span> <span class="n">_AstraDBCollectionEnvironment</span><span class="p">(</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
            <span class="n">api_endpoint</span><span class="o">=</span><span class="n">api_endpoint</span><span class="p">,</span>
            <span class="n">astra_db_client</span><span class="o">=</span><span class="n">astra_db_client</span><span class="p">,</span>
            <span class="n">async_astra_db_client</span><span class="o">=</span><span class="n">async_astra_db_client</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">setup_mode</span><span class="o">=</span><span class="n">setup_mode</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span></div>

<div class="viewcode-block" id="AstraDBCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
            <span class="nb">filter</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">"_id"</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">projection</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">"body_blob"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)[</span><span class="s2">"data"</span><span class="p">][</span><span class="s2">"document"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_loads_generations</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">"body_blob"</span><span class="p">])</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AstraDBCache.alookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.alookup">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">alookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
                <span class="nb">filter</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">"_id"</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">projection</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">"body_blob"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="p">)[</span><span class="s2">"data"</span><span class="p">][</span><span class="s2">"document"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_loads_generations</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">"body_blob"</span><span class="p">])</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AstraDBCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">_dumps_generations</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">"_id"</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">,</span>
                <span class="s2">"body_blob"</span><span class="p">:</span> <span class="n">blob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBCache.aupdate"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.aupdate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aupdate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="n">_dumps_generations</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">"_id"</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">,</span>
                <span class="s2">"body_blob"</span><span class="p">:</span> <span class="n">blob</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBCache.delete_through_llm"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.delete_through_llm">[docs]</a>    <span class="k">def</span> <span class="nf">delete_through_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">LLM</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        A wrapper around `delete` with the LLM being passed.</span>
<span class="sd">        In case the llm.invoke(prompt) calls have a `stop` param, you should</span>
<span class="sd">        pass it here</span>
<span class="sd">        """</span>
        <span class="n">llm_string</span> <span class="o">=</span> <span class="n">get_prompts</span><span class="p">(</span>
            <span class="p">{</span><span class="o">**</span><span class="n">llm</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="o">**</span><span class="p">{</span><span class="s2">"stop"</span><span class="p">:</span> <span class="n">stop</span><span class="p">}},</span>
            <span class="p">[],</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="o">=</span><span class="n">llm_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBCache.adelete_through_llm"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.adelete_through_llm">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">adelete_through_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">LLM</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        A wrapper around `adelete` with the LLM being passed.</span>
<span class="sd">        In case the llm.invoke(prompt) calls have a `stop` param, you should</span>
<span class="sd">        pass it here</span>
<span class="sd">        """</span>
        <span class="n">llm_string</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">await</span> <span class="n">aget_prompts</span><span class="p">(</span>
                <span class="p">{</span><span class="o">**</span><span class="n">llm</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="o">**</span><span class="p">{</span><span class="s2">"stop"</span><span class="p">:</span> <span class="n">stop</span><span class="p">}},</span>
                <span class="p">[],</span>
            <span class="p">)</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">adelete</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="o">=</span><span class="n">llm_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBCache.delete"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Evict from cache if there's an entry."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBCache.adelete"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.adelete">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">adelete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Evict from cache if there's an entry."""</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="AstraDBCache.aclear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBCache.html#langchain_community.cache.AstraDBCache.aclear">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div></div>


<span class="n">ASTRA_DB_SEMANTIC_CACHE_DEFAULT_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.85</span>
<span class="n">ASTRA_DB_CACHE_DEFAULT_COLLECTION_NAME</span> <span class="o">=</span> <span class="s2">"langchain_astradb_semantic_cache"</span>
<span class="n">ASTRA_DB_SEMANTIC_CACHE_EMBEDDING_CACHE_SIZE</span> <span class="o">=</span> <span class="mi">16</span>


<span class="n">_unset</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"unset"</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_CachedAwaitable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Caches the result of an awaitable so it can be awaited multiple times"""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">awaitable</span><span class="p">:</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">awaitable</span> <span class="o">=</span> <span class="n">awaitable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">_unset</span>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="n">_unset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">awaitable</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>  <span class="c1"># type: ignore</span>


<span class="k">def</span> <span class="nf">_reawaitable</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Makes an async function result awaitable multiple times"""</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_CachedAwaitable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_CachedAwaitable</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">_async_lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span> <span class="n">typed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Least-recently-used async cache decorator.</span>
<span class="sd">    Equivalent to functools.lru_cache for async functions"""</span>

    <span class="k">def</span> <span class="nf">decorating_function</span><span class="p">(</span><span class="n">user_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="p">,</span> <span class="n">typed</span><span class="p">)(</span><span class="n">_reawaitable</span><span class="p">(</span><span class="n">user_function</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">decorating_function</span>


<div class="viewcode-block" id="AstraDBSemanticCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache">[docs]</a><span class="nd">@deprecated</span><span class="p">(</span>
    <span class="n">since</span><span class="o">=</span><span class="s2">"0.0.28"</span><span class="p">,</span>
    <span class="n">removal</span><span class="o">=</span><span class="s2">"1.0"</span><span class="p">,</span>
    <span class="n">alternative_import</span><span class="o">=</span><span class="s2">"langchain_astradb.AstraDBSemanticCache"</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">class</span> <span class="nc">AstraDBSemanticCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<div class="viewcode-block" id="AstraDBSemanticCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ASTRA_DB_CACHE_DEFAULT_COLLECTION_NAME</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">api_endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">astra_db_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AstraDB</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">async_astra_db_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncAstraDB</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">setup_mode</span><span class="p">:</span> <span class="n">AstraSetupMode</span> <span class="o">=</span> <span class="n">AstraSetupMode</span><span class="o">.</span><span class="n">SYNC</span><span class="p">,</span>
        <span class="n">pre_delete_collection</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">ASTRA_DB_SEMANTIC_CACHE_DEFAULT_THRESHOLD</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Cache that uses Astra DB as a vector-store backend for semantic</span>
<span class="sd">        (i.e. similarity-based) lookup.</span>

<span class="sd">        It uses a single (vector) collection and can store</span>
<span class="sd">        cached values from several LLMs, so the LLM's 'llm_string' is stored</span>
<span class="sd">        in the document metadata.</span>

<span class="sd">        You can choose the preferred similarity (or use the API default).</span>
<span class="sd">        The default score threshold is tuned to the default metric.</span>
<span class="sd">        Tune it carefully yourself if switching to another distance metric.</span>

<span class="sd">        Args:</span>
<span class="sd">            collection_name: name of the Astra DB collection to create/use.</span>
<span class="sd">            token: API token for Astra DB usage.</span>
<span class="sd">            api_endpoint: full URL to the API endpoint,</span>
<span class="sd">                such as `https://&lt;DB-ID&gt;-us-east1.apps.astra.datastax.com`.</span>
<span class="sd">            astra_db_client: *alternative to token+api_endpoint*,</span>
<span class="sd">                you can pass an already-created 'astrapy.db.AstraDB' instance.</span>
<span class="sd">            async_astra_db_client: *alternative to token+api_endpoint*,</span>
<span class="sd">                you can pass an already-created 'astrapy.db.AsyncAstraDB' instance.</span>
<span class="sd">            namespace: namespace (aka keyspace) where the</span>
<span class="sd">                collection is created. Defaults to the database's "default namespace".</span>
<span class="sd">            setup_mode: mode used to create the Astra DB collection (SYNC, ASYNC or</span>
<span class="sd">                OFF).</span>
<span class="sd">            pre_delete_collection: whether to delete the collection</span>
<span class="sd">                before creating it. If False and the collection already exists,</span>
<span class="sd">                the collection will be used as is.</span>
<span class="sd">            embedding: Embedding provider for semantic encoding and search.</span>
<span class="sd">            metric: the function to use for evaluating similarity of text embeddings.</span>
<span class="sd">                Defaults to 'cosine' (alternatives: 'euclidean', 'dot_product')</span>
<span class="sd">            similarity_threshold: the minimum similarity for accepting a</span>
<span class="sd">                (semantic-search) match.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span> <span class="o">=</span> <span class="n">similarity_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>

        <span class="c1"># The contract for this class has separate lookup and update:</span>
        <span class="c1"># in order to spare some embedding calculations we cache them between</span>
        <span class="c1"># the two calls.</span>
        <span class="c1"># Note: each instance of this class has its own `_get_embedding` with</span>
        <span class="c1"># its own lru.</span>
        <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">ASTRA_DB_SEMANTIC_CACHE_EMBEDDING_CACHE_SIZE</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_cache_embedding</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding</span> <span class="o">=</span> <span class="n">_cache_embedding</span>

        <span class="nd">@_async_lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">ASTRA_DB_SEMANTIC_CACHE_EMBEDDING_CACHE_SIZE</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_acache_embedding</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">aembed_query</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_aget_embedding</span> <span class="o">=</span> <span class="n">_acache_embedding</span>

        <span class="n">embedding_dimension</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">setup_mode</span> <span class="o">==</span> <span class="n">AstraSetupMode</span><span class="o">.</span><span class="n">ASYNC</span><span class="p">:</span>
            <span class="n">embedding_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aget_embedding_dimension</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">setup_mode</span> <span class="o">==</span> <span class="n">AstraSetupMode</span><span class="o">.</span><span class="n">SYNC</span><span class="p">:</span>
            <span class="n">embedding_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding_dimension</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span> <span class="o">=</span> <span class="n">_AstraDBCollectionEnvironment</span><span class="p">(</span>
            <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
            <span class="n">api_endpoint</span><span class="o">=</span><span class="n">api_endpoint</span><span class="p">,</span>
            <span class="n">astra_db_client</span><span class="o">=</span><span class="n">astra_db_client</span><span class="p">,</span>
            <span class="n">async_astra_db_client</span><span class="o">=</span><span class="n">async_astra_db_client</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">setup_mode</span><span class="o">=</span><span class="n">setup_mode</span><span class="p">,</span>
            <span class="n">pre_delete_collection</span><span class="o">=</span><span class="n">pre_delete_collection</span><span class="p">,</span>
            <span class="n">embedding_dimension</span><span class="o">=</span><span class="n">embedding_dimension</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">async_collection</span></div>

    <span class="k">def</span> <span class="nf">_get_embedding_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"This is a sample sentence."</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_aget_embedding_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aget_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"This is a sample sentence."</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">_hash</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">#</span><span class="si">{</span><span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>

<div class="viewcode-block" id="AstraDBSemanticCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="n">llm_string_hash</span> <span class="o">=</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">embedding_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">_dumps_generations</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">"_id"</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">,</span>
                <span class="s2">"body_blob"</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span>
                <span class="s2">"llm_string_hash"</span><span class="p">:</span> <span class="n">llm_string_hash</span><span class="p">,</span>
                <span class="s2">"$vector"</span><span class="p">:</span> <span class="n">embedding_vector</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.aupdate"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.aupdate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aupdate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="n">llm_string_hash</span> <span class="o">=</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">embedding_vector</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aget_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">_dumps_generations</span><span class="p">(</span><span class="n">return_val</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">upsert</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">"_id"</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">,</span>
                <span class="s2">"body_blob"</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span>
                <span class="s2">"llm_string_hash"</span><span class="p">:</span> <span class="n">llm_string_hash</span><span class="p">,</span>
                <span class="s2">"$vector"</span><span class="p">:</span> <span class="n">embedding_vector</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
        <span class="n">hit_with_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_with_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hit_with_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hit_with_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.alookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.alookup">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">alookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
        <span class="n">hit_with_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alookup_with_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hit_with_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hit_with_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.lookup_with_id"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.lookup_with_id">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_with_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Look up based on prompt and llm_string.</span>
<span class="sd">        If there are hits, return (document_id, cached_entry) for the top hit</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="n">prompt_embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">llm_string_hash</span> <span class="o">=</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>

        <span class="n">hit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">vector_find_one</span><span class="p">(</span>
            <span class="n">vector</span><span class="o">=</span><span class="n">prompt_embedding</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">"llm_string_hash"</span><span class="p">:</span> <span class="n">llm_string_hash</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">"body_blob"</span><span class="p">,</span> <span class="s2">"_id"</span><span class="p">],</span>
            <span class="n">include_similarity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">hit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hit</span><span class="p">[</span><span class="s2">"$similarity"</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">_loads_generations</span><span class="p">(</span><span class="n">hit</span><span class="p">[</span><span class="s2">"body_blob"</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">generations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># this protects against malformed cached items:</span>
                <span class="k">return</span> <span class="n">hit</span><span class="p">[</span><span class="s2">"_id"</span><span class="p">],</span> <span class="n">generations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.alookup_with_id"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.alookup_with_id">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">alookup_with_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Look up based on prompt and llm_string.</span>
<span class="sd">        If there are hits, return (document_id, cached_entry) for the top hit</span>
<span class="sd">        """</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="n">prompt_embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aget_embedding</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">llm_string_hash</span> <span class="o">=</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>

        <span class="n">hit</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">vector_find_one</span><span class="p">(</span>
            <span class="n">vector</span><span class="o">=</span><span class="n">prompt_embedding</span><span class="p">,</span>
            <span class="nb">filter</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">"llm_string_hash"</span><span class="p">:</span> <span class="n">llm_string_hash</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">"body_blob"</span><span class="p">,</span> <span class="s2">"_id"</span><span class="p">],</span>
            <span class="n">include_similarity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">hit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hit</span><span class="p">[</span><span class="s2">"$similarity"</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generations</span> <span class="o">=</span> <span class="n">_loads_generations</span><span class="p">(</span><span class="n">hit</span><span class="p">[</span><span class="s2">"body_blob"</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">generations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># this protects against malformed cached items:</span>
                <span class="k">return</span> <span class="n">hit</span><span class="p">[</span><span class="s2">"_id"</span><span class="p">],</span> <span class="n">generations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.lookup_with_id_through_llm"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.lookup_with_id_through_llm">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_with_id_through_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">LLM</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">]]:</span>
        <span class="n">llm_string</span> <span class="o">=</span> <span class="n">get_prompts</span><span class="p">(</span>
            <span class="p">{</span><span class="o">**</span><span class="n">llm</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="o">**</span><span class="p">{</span><span class="s2">"stop"</span><span class="p">:</span> <span class="n">stop</span><span class="p">}},</span>
            <span class="p">[],</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_with_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="o">=</span><span class="n">llm_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.alookup_with_id_through_llm"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.alookup_with_id_through_llm">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">alookup_with_id_through_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">LLM</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">]]:</span>
        <span class="n">llm_string</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">await</span> <span class="n">aget_prompts</span><span class="p">(</span>
                <span class="p">{</span><span class="o">**</span><span class="n">llm</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="o">**</span><span class="p">{</span><span class="s2">"stop"</span><span class="p">:</span> <span class="n">stop</span><span class="p">}},</span>
                <span class="p">[],</span>
            <span class="p">)</span>
        <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">alookup_with_id</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm_string</span><span class="o">=</span><span class="n">llm_string</span><span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.delete_by_document_id"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.delete_by_document_id">[docs]</a>    <span class="k">def</span> <span class="nf">delete_by_document_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Given this is a "similarity search" cache, an invalidation pattern</span>
<span class="sd">        that makes sense is first a lookup to get an ID, and then deleting</span>
<span class="sd">        with that ID. This is for the second step.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span><span class="n">document_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.adelete_by_document_id"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.adelete_by_document_id">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">adelete_by_document_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Given this is a "similarity search" cache, an invalidation pattern</span>
<span class="sd">        that makes sense is first a lookup to get an ID, and then deleting</span>
<span class="sd">        with that ID. This is for the second step.</span>
<span class="sd">        """</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span><span class="n">document_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">ensure_db_setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="AstraDBSemanticCache.aclear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AstraDBSemanticCache.html#langchain_community.cache.AstraDBSemanticCache.aclear">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">astra_env</span><span class="o">.</span><span class="n">aensure_db_setup</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_collection</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="AzureCosmosDBSemanticCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AzureCosmosDBSemanticCache.html#langchain_community.cache.AzureCosmosDBSemanticCache">[docs]</a><span class="k">class</span> <span class="nc">AzureCosmosDBSemanticCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that uses Cosmos DB Mongo vCore vector-store backend"""</span>

    <span class="n">DEFAULT_DATABASE_NAME</span> <span class="o">=</span> <span class="s2">"CosmosMongoVCoreCacheDB"</span>
    <span class="n">DEFAULT_COLLECTION_NAME</span> <span class="o">=</span> <span class="s2">"CosmosMongoVCoreCacheColl"</span>

<div class="viewcode-block" id="AzureCosmosDBSemanticCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AzureCosmosDBSemanticCache.html#langchain_community.cache.AzureCosmosDBSemanticCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cosmosdb_connection_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">database_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">cosmosdb_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_lists</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">similarity</span><span class="p">:</span> <span class="n">CosmosDBSimilarityType</span> <span class="o">=</span> <span class="n">CosmosDBSimilarityType</span><span class="o">.</span><span class="n">COS</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">CosmosDBVectorSearchType</span> <span class="o">=</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_IVF</span><span class="p">,</span>
        <span class="n">dimensions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1536</span><span class="p">,</span>
        <span class="n">m</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
        <span class="n">ef_construction</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
        <span class="n">ef_search</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
        <span class="n">score_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">application_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"LANGCHAIN_CACHING_PYTHON"</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Args:</span>
<span class="sd">            cosmosdb_connection_string: Cosmos DB Mongo vCore connection string</span>
<span class="sd">            cosmosdb_client: Cosmos DB Mongo vCore client</span>
<span class="sd">            embedding (Embedding): Embedding provider for semantic encoding and search.</span>
<span class="sd">            database_name: Database name for the CosmosDBMongoVCoreSemanticCache</span>
<span class="sd">            collection_name: Collection name for the CosmosDBMongoVCoreSemanticCache</span>
<span class="sd">            num_lists: This integer is the number of clusters that the</span>
<span class="sd">                inverted file (IVF) index uses to group the vector data.</span>
<span class="sd">                We recommend that numLists is set to documentCount/1000</span>
<span class="sd">                for up to 1 million documents and to sqrt(documentCount)</span>
<span class="sd">                for more than 1 million documents.</span>
<span class="sd">                Using a numLists value of 1 is akin to performing</span>
<span class="sd">                brute-force search, which has limited performance</span>
<span class="sd">            dimensions: Number of dimensions for vector similarity.</span>
<span class="sd">                The maximum number of supported dimensions is 2000</span>
<span class="sd">            similarity: Similarity metric to use with the IVF index.</span>

<span class="sd">                Possible options are:</span>
<span class="sd">                    - CosmosDBSimilarityType.COS (cosine distance),</span>
<span class="sd">                    - CosmosDBSimilarityType.L2 (Euclidean distance), and</span>
<span class="sd">                    - CosmosDBSimilarityType.IP (inner product).</span>
<span class="sd">            kind: Type of vector index to create.</span>
<span class="sd">                Possible options are:</span>
<span class="sd">                    - vector-ivf</span>
<span class="sd">                    - vector-hnsw: available as a preview feature only,</span>
<span class="sd">                                   to enable visit https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/preview-features</span>
<span class="sd">            m: The max number of connections per layer (16 by default, minimum</span>
<span class="sd">               value is 2, maximum value is 100). Higher m is suitable for datasets</span>
<span class="sd">               with high dimensionality and/or high accuracy requirements.</span>
<span class="sd">            ef_construction: the size of the dynamic candidate list for constructing</span>
<span class="sd">                            the graph (64 by default, minimum value is 4, maximum</span>
<span class="sd">                            value is 1000). Higher ef_construction will result in</span>
<span class="sd">                            better index quality and higher accuracy, but it will</span>
<span class="sd">                            also increase the time required to build the index.</span>
<span class="sd">                            ef_construction has to be at least 2 * m</span>
<span class="sd">            ef_search: The size of the dynamic candidate list for search</span>
<span class="sd">                       (40 by default). A higher value provides better</span>
<span class="sd">                       recall at the cost of speed.</span>
<span class="sd">            score_threshold: Maximum score used to filter the vector search documents.</span>
<span class="sd">            application_name: Application name for the client for tracking and logging</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_enum_value</span><span class="p">(</span><span class="n">similarity</span><span class="p">,</span> <span class="n">CosmosDBSimilarityType</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_enum_value</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">CosmosDBVectorSearchType</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cosmosdb_connection_string</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">" CosmosDB connection string can be empty."</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cosmosdb_connection_string</span> <span class="o">=</span> <span class="n">cosmosdb_connection_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cosmosdb_client</span> <span class="o">=</span> <span class="n">cosmosdb_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database_name</span> <span class="o">=</span> <span class="n">database_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_DATABASE_NAME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_COLLECTION_NAME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_lists</span> <span class="o">=</span> <span class="n">num_lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="o">=</span> <span class="n">dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span> <span class="o">=</span> <span class="n">similarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ef_construction</span> <span class="o">=</span> <span class="n">ef_construction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ef_search</span> <span class="o">=</span> <span class="n">ef_search</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span> <span class="o">=</span> <span class="n">score_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AzureCosmosDBVectorSearch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application_name</span> <span class="o">=</span> <span class="n">application_name</span></div>

    <span class="k">def</span> <span class="nf">_index_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">hashed_index</span> <span class="o">=</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"cache:</span><span class="si">{</span><span class="n">hashed_index</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span> <span class="nf">_get_llm_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AzureCosmosDBVectorSearch</span><span class="p">:</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>

        <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_name</span> <span class="o">+</span> <span class="s2">"."</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span>

        <span class="c1"># return vectorstore client for the specific llm string</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span>

        <span class="c1"># create new vectorstore client for the specific llm string</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmosdb_client</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosmosdb_client</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">AzureCosmosDBVectorSearch</span><span class="p">(</span>
                <span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span>
                <span class="n">embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
                <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">AzureCosmosDBVectorSearch</span><span class="o">.</span><span class="n">from_connection_string</span><span class="p">(</span>
                    <span class="n">connection_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmosdb_connection_string</span><span class="p">,</span>
                    <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
                    <span class="n">embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
                    <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span>
                    <span class="n">application_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">application_name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># create index for the vectorstore</span>
        <span class="n">vectorstore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vectorstore</span><span class="o">.</span><span class="n">index_exists</span><span class="p">():</span>
            <span class="n">vectorstore</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_lists</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">similarity</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ef_construction</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">vectorstore</span>

<div class="viewcode-block" id="AzureCosmosDBSemanticCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AzureCosmosDBSemanticCache.html#langchain_community.cache.AzureCosmosDBSemanticCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="n">llm_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_cache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">generations</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Read from a Hash</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">llm_cache</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">ef_search</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ef_search</span><span class="p">,</span>
            <span class="n">score_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">generations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">loads</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">"return_val"</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">"Retrieving a cache value that could not be deserialized "</span>
                        <span class="s2">"properly. This is likely due to the cache being in an "</span>
                        <span class="s2">"older format. Please recreate your cache to avoid this "</span>
                        <span class="s2">"error."</span>
                    <span class="p">)</span>
                    <span class="c1"># In a previous life we stored the raw text directly</span>
                    <span class="c1"># in the table, so assume it's in that format.</span>
                    <span class="n">generations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">_load_generations_from_json</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">"return_val"</span><span class="p">])</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">generations</span> <span class="k">if</span> <span class="n">generations</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AzureCosmosDBSemanticCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AzureCosmosDBSemanticCache.html#langchain_community.cache.AzureCosmosDBSemanticCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache based on prompt and llm_string."""</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">Generation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"CosmosDBMongoVCoreSemanticCache only supports caching of "</span>
                    <span class="sa">f</span><span class="s2">"normal LLM generations, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>

        <span class="n">llm_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_cache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"llm_string"</span><span class="p">:</span> <span class="n">llm_string</span><span class="p">,</span>
            <span class="s2">"prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s2">"return_val"</span><span class="p">:</span> <span class="n">dumps</span><span class="p">([</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">]),</span>
        <span class="p">}</span>
        <span class="n">llm_cache</span><span class="o">.</span><span class="n">add_texts</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="p">[</span><span class="n">prompt</span><span class="p">],</span> <span class="n">metadatas</span><span class="o">=</span><span class="p">[</span><span class="n">metadata</span><span class="p">])</span></div>

<div class="viewcode-block" id="AzureCosmosDBSemanticCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.AzureCosmosDBSemanticCache.html#langchain_community.cache.AzureCosmosDBSemanticCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear semantic cache for a given llm_string."""</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">"llm_string"</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_collection</span><span class="p">()</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span></div>
            <span class="c1"># self._cache_dict[index_name].clear_collection()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_validate_enum_value</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">enum_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Enum</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">enum_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid enum value: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">. Expected </span><span class="si">{</span><span class="n">enum_type</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenSearchSemanticCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.OpenSearchSemanticCache.html#langchain_community.cache.OpenSearchSemanticCache">[docs]</a><span class="k">class</span> <span class="nc">OpenSearchSemanticCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that uses OpenSearch vector store backend"""</span>

<div class="viewcode-block" id="OpenSearchSemanticCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.OpenSearchSemanticCache.html#langchain_community.cache.OpenSearchSemanticCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">opensearch_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="n">score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Args:</span>
<span class="sd">            opensearch_url (str): URL to connect to OpenSearch.</span>
<span class="sd">            embedding (Embedding): Embedding provider for semantic encoding and search.</span>
<span class="sd">            score_threshold (float, 0.2):</span>
<span class="sd">        Example:</span>
<span class="sd">        .. code-block:: python</span>
<span class="sd">            import langchain</span>
<span class="sd">            from langchain.cache import OpenSearchSemanticCache</span>
<span class="sd">            from langchain.embeddings import OpenAIEmbeddings</span>
<span class="sd">            langchain.llm_cache = OpenSearchSemanticCache(</span>
<span class="sd">                opensearch_url="http//localhost:9200",</span>
<span class="sd">                embedding=OpenAIEmbeddings()</span>
<span class="sd">            )</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">OpenSearchVectorStore</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opensearch_url</span> <span class="o">=</span> <span class="n">opensearch_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span> <span class="o">=</span> <span class="n">score_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span></div>

    <span class="k">def</span> <span class="nf">_index_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">hashed_index</span> <span class="o">=</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"cache_</span><span class="si">{</span><span class="n">hashed_index</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span> <span class="nf">_get_llm_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OpenSearchVectorStore</span><span class="p">:</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>

        <span class="c1"># return vectorstore client for the specific llm string</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span>

        <span class="c1"># create new vectorstore client for the specific llm string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">OpenSearchVectorStore</span><span class="p">(</span>
            <span class="n">opensearch_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opensearch_url</span><span class="p">,</span>
            <span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span>
            <span class="n">embedding_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># create index for the vectorstore</span>
        <span class="n">vectorstore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vectorstore</span><span class="o">.</span><span class="n">index_exists</span><span class="p">():</span>
            <span class="n">_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"test"</span><span class="p">)</span>
            <span class="n">vectorstore</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_embedding</span><span class="p">),</span> <span class="n">index_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vectorstore</span>

<div class="viewcode-block" id="OpenSearchSemanticCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.OpenSearchSemanticCache.html#langchain_community.cache.OpenSearchSemanticCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="n">llm_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_cache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">generations</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Read from a Hash</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">llm_cache</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">score_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">document</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">generations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">loads</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">"return_val"</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">"Retrieving a cache value that could not be deserialized "</span>
                        <span class="s2">"properly. This is likely due to the cache being in an "</span>
                        <span class="s2">"older format. Please recreate your cache to avoid this "</span>
                        <span class="s2">"error."</span>
                    <span class="p">)</span>

                    <span class="n">generations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">_load_generations_from_json</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">"return_val"</span><span class="p">])</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">generations</span> <span class="k">if</span> <span class="n">generations</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OpenSearchSemanticCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.OpenSearchSemanticCache.html#langchain_community.cache.OpenSearchSemanticCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache based on prompt and llm_string."""</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">Generation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"OpenSearchSemanticCache only supports caching of "</span>
                    <span class="sa">f</span><span class="s2">"normal LLM generations, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
        <span class="n">llm_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_cache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"llm_string"</span><span class="p">:</span> <span class="n">llm_string</span><span class="p">,</span>
            <span class="s2">"prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s2">"return_val"</span><span class="p">:</span> <span class="n">dumps</span><span class="p">([</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">]),</span>
        <span class="p">}</span>
        <span class="n">llm_cache</span><span class="o">.</span><span class="n">add_texts</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="p">[</span><span class="n">prompt</span><span class="p">],</span> <span class="n">metadatas</span><span class="o">=</span><span class="p">[</span><span class="n">metadata</span><span class="p">])</span></div>

<div class="viewcode-block" id="OpenSearchSemanticCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.OpenSearchSemanticCache.html#langchain_community.cache.OpenSearchSemanticCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear semantic cache for a given llm_string."""</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">"llm_string"</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span><span class="o">.</span><span class="n">delete_index</span><span class="p">(</span><span class="n">index_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="SingleStoreDBSemanticCache"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SingleStoreDBSemanticCache.html#langchain_community.cache.SingleStoreDBSemanticCache">[docs]</a><span class="k">class</span> <span class="nc">SingleStoreDBSemanticCache</span><span class="p">(</span><span class="n">BaseCache</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache that uses SingleStore DB as a backend"""</span>

<div class="viewcode-block" id="SingleStoreDBSemanticCache.__init__"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SingleStoreDBSemanticCache.html#langchain_community.cache.SingleStoreDBSemanticCache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">cache_table_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"cache_"</span><span class="p">,</span>
        <span class="n">search_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize with necessary components.</span>

<span class="sd">        Args:</span>
<span class="sd">            embedding (Embeddings): A text embedding model.</span>
<span class="sd">            cache_table_prefix (str, optional): Prefix for the cache table name.</span>
<span class="sd">                Defaults to "cache_".</span>
<span class="sd">            search_threshold (float, optional): The minimum similarity score for</span>
<span class="sd">                a search result to be considered a match. Defaults to 0.2.</span>

<span class="sd">            Following arguments pertrain to the SingleStoreDB vector store:</span>

<span class="sd">            distance_strategy (DistanceStrategy, optional):</span>
<span class="sd">                Determines the strategy employed for calculating</span>
<span class="sd">                the distance between vectors in the embedding space.</span>
<span class="sd">                Defaults to DOT_PRODUCT.</span>
<span class="sd">                Available options are:</span>
<span class="sd">                - DOT_PRODUCT: Computes the scalar product of two vectors.</span>
<span class="sd">                    This is the default behavior</span>
<span class="sd">                - EUCLIDEAN_DISTANCE: Computes the Euclidean distance between</span>
<span class="sd">                    two vectors. This metric considers the geometric distance in</span>
<span class="sd">                    the vector space, and might be more suitable for embeddings</span>
<span class="sd">                    that rely on spatial relationships. This metric is not</span>
<span class="sd">                    compatible with the WEIGHTED_SUM search strategy.</span>

<span class="sd">            content_field (str, optional): Specifies the field to store the content.</span>
<span class="sd">                Defaults to "content".</span>
<span class="sd">            metadata_field (str, optional): Specifies the field to store metadata.</span>
<span class="sd">                Defaults to "metadata".</span>
<span class="sd">            vector_field (str, optional): Specifies the field to store the vector.</span>
<span class="sd">                Defaults to "vector".</span>
<span class="sd">            id_field (str, optional): Specifies the field to store the id.</span>
<span class="sd">                Defaults to "id".</span>

<span class="sd">            use_vector_index (bool, optional): Toggles the use of a vector index.</span>
<span class="sd">                Works only with SingleStoreDB 8.5 or later. Defaults to False.</span>
<span class="sd">                If set to True, vector_size parameter is required to be set to</span>
<span class="sd">                a proper value.</span>

<span class="sd">            vector_index_name (str, optional): Specifies the name of the vector index.</span>
<span class="sd">                Defaults to empty. Will be ignored if use_vector_index is set to False.</span>

<span class="sd">            vector_index_options (dict, optional): Specifies the options for</span>
<span class="sd">                the vector index. Defaults to {}.</span>
<span class="sd">                Will be ignored if use_vector_index is set to False. The options are:</span>
<span class="sd">                index_type (str, optional): Specifies the type of the index.</span>
<span class="sd">                    Defaults to IVF_PQFS.</span>
<span class="sd">                For more options, please refer to the SingleStoreDB documentation:</span>
<span class="sd">                https://docs.singlestore.com/cloud/reference/sql-reference/vector-functions/vector-indexing/</span>

<span class="sd">            vector_size (int, optional): Specifies the size of the vector.</span>
<span class="sd">                Defaults to 1536. Required if use_vector_index is set to True.</span>
<span class="sd">                Should be set to the same value as the size of the vectors</span>
<span class="sd">                stored in the vector_field.</span>

<span class="sd">            Following arguments pertain to the connection pool:</span>

<span class="sd">            pool_size (int, optional): Determines the number of active connections in</span>
<span class="sd">                the pool. Defaults to 5.</span>
<span class="sd">            max_overflow (int, optional): Determines the maximum number of connections</span>
<span class="sd">                allowed beyond the pool_size. Defaults to 10.</span>
<span class="sd">            timeout (float, optional): Specifies the maximum wait time in seconds for</span>
<span class="sd">                establishing a connection. Defaults to 30.</span>

<span class="sd">            Following arguments pertain to the database connection:</span>

<span class="sd">            host (str, optional): Specifies the hostname, IP address, or URL for the</span>
<span class="sd">                database connection. The default scheme is "mysql".</span>
<span class="sd">            user (str, optional): Database username.</span>
<span class="sd">            password (str, optional): Database password.</span>
<span class="sd">            port (int, optional): Database port. Defaults to 3306 for non-HTTP</span>
<span class="sd">                connections, 80 for HTTP connections, and 443 for HTTPS connections.</span>
<span class="sd">            database (str, optional): Database name.</span>

<span class="sd">            Additional optional arguments provide further customization over the</span>
<span class="sd">            database connection:</span>

<span class="sd">            pure_python (bool, optional): Toggles the connector mode. If True,</span>
<span class="sd">                operates in pure Python mode.</span>
<span class="sd">            local_infile (bool, optional): Allows local file uploads.</span>
<span class="sd">            charset (str, optional): Specifies the character set for string values.</span>
<span class="sd">            ssl_key (str, optional): Specifies the path of the file containing the SSL</span>
<span class="sd">                key.</span>
<span class="sd">            ssl_cert (str, optional): Specifies the path of the file containing the SSL</span>
<span class="sd">                certificate.</span>
<span class="sd">            ssl_ca (str, optional): Specifies the path of the file containing the SSL</span>
<span class="sd">                certificate authority.</span>
<span class="sd">            ssl_cipher (str, optional): Sets the SSL cipher list.</span>
<span class="sd">            ssl_disabled (bool, optional): Disables SSL usage.</span>
<span class="sd">            ssl_verify_cert (bool, optional): Verifies the server's certificate.</span>
<span class="sd">                Automatically enabled if ``ssl_ca`` is specified.</span>
<span class="sd">            ssl_verify_identity (bool, optional): Verifies the server's identity.</span>
<span class="sd">            conv (dict[int, Callable], optional): A dictionary of data conversion</span>
<span class="sd">                functions.</span>
<span class="sd">            credential_type (str, optional): Specifies the type of authentication to</span>
<span class="sd">                use: auth.PASSWORD, auth.JWT, or auth.BROWSER_SSO.</span>
<span class="sd">            autocommit (bool, optional): Enables autocommits.</span>
<span class="sd">            results_type (str, optional): Determines the structure of the query results:</span>
<span class="sd">                tuples, namedtuples, dicts.</span>
<span class="sd">            results_format (str, optional): Deprecated. This option has been renamed to</span>
<span class="sd">                results_type.</span>

<span class="sd">        Examples:</span>
<span class="sd">            Basic Usage:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                import langchain</span>
<span class="sd">                from langchain.cache import SingleStoreDBSemanticCache</span>
<span class="sd">                from langchain.embeddings import OpenAIEmbeddings</span>

<span class="sd">                langchain.llm_cache = SingleStoreDBSemanticCache(</span>
<span class="sd">                    embedding=OpenAIEmbeddings(),</span>
<span class="sd">                    host="https://user:password@127.0.0.1:3306/database"</span>
<span class="sd">                )</span>

<span class="sd">            Advanced Usage:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                import langchain</span>
<span class="sd">                from langchain.cache import SingleStoreDBSemanticCache</span>
<span class="sd">                from langchain.embeddings import OpenAIEmbeddings</span>

<span class="sd">                langchain.llm_cache = = SingleStoreDBSemanticCache(</span>
<span class="sd">                    embeddings=OpenAIEmbeddings(),</span>
<span class="sd">                    use_vector_index=True,</span>
<span class="sd">                    host="127.0.0.1",</span>
<span class="sd">                    port=3306,</span>
<span class="sd">                    user="user",</span>
<span class="sd">                    password="password",</span>
<span class="sd">                    database="db",</span>
<span class="sd">                    table_name="my_custom_table",</span>
<span class="sd">                    pool_size=10,</span>
<span class="sd">                    timeout=60,</span>
<span class="sd">                )</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SingleStoreDB</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_table_prefix</span> <span class="o">=</span> <span class="n">cache_table_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">search_threshold</span> <span class="o">=</span> <span class="n">search_threshold</span>

        <span class="c1"># Pass the rest of the kwargs to the connection.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span></div>

    <span class="k">def</span> <span class="nf">_index_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">hashed_index</span> <span class="o">=</span> <span class="n">_hash</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_table_prefix</span><span class="si">}{</span><span class="n">hashed_index</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span> <span class="nf">_get_llm_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SingleStoreDB</span><span class="p">:</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>

        <span class="c1"># return vectorstore client for the specific llm string</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">SingleStoreDB</span><span class="p">(</span>
                <span class="n">embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
                <span class="n">table_name</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span>

<div class="viewcode-block" id="SingleStoreDBSemanticCache.lookup"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SingleStoreDBSemanticCache.html#langchain_community.cache.SingleStoreDBSemanticCache.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RETURN_VAL_TYPE</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Look up based on prompt and llm_string."""</span>
        <span class="n">llm_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_cache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">generations</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Read from a Hash</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">llm_cache</span><span class="o">.</span><span class="n">similarity_search_with_score</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">document_score</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">document_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_threshold</span>
                    <span class="ow">and</span> <span class="n">llm_cache</span><span class="o">.</span><span class="n">distance_strategy</span> <span class="o">==</span> <span class="n">DistanceStrategy</span><span class="o">.</span><span class="n">DOT_PRODUCT</span>
                <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">document_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_threshold</span>
                    <span class="ow">and</span> <span class="n">llm_cache</span><span class="o">.</span><span class="n">distance_strategy</span>
                    <span class="o">==</span> <span class="n">DistanceStrategy</span><span class="o">.</span><span class="n">EUCLIDEAN_DISTANCE</span>
                <span class="p">):</span>
                    <span class="n">generations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">loads</span><span class="p">(</span><span class="n">document_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">"return_val"</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">generations</span> <span class="k">if</span> <span class="n">generations</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SingleStoreDBSemanticCache.update"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SingleStoreDBSemanticCache.html#langchain_community.cache.SingleStoreDBSemanticCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_val</span><span class="p">:</span> <span class="n">RETURN_VAL_TYPE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Update cache based on prompt and llm_string."""</span>
        <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">Generation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"SingleStoreDBSemanticCache only supports caching of "</span>
                    <span class="sa">f</span><span class="s2">"normal LLM generations, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
        <span class="n">llm_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_llm_cache</span><span class="p">(</span><span class="n">llm_string</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"llm_string"</span><span class="p">:</span> <span class="n">llm_string</span><span class="p">,</span>
            <span class="s2">"prompt"</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s2">"return_val"</span><span class="p">:</span> <span class="n">dumps</span><span class="p">([</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">return_val</span><span class="p">]),</span>
        <span class="p">}</span>
        <span class="n">llm_cache</span><span class="o">.</span><span class="n">add_texts</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="p">[</span><span class="n">prompt</span><span class="p">],</span> <span class="n">metadatas</span><span class="o">=</span><span class="p">[</span><span class="n">metadata</span><span class="p">])</span></div>

<div class="viewcode-block" id="SingleStoreDBSemanticCache.clear"><a class="viewcode-back" href="../../community/cache/langchain_community.cache.SingleStoreDBSemanticCache.html#langchain_community.cache.SingleStoreDBSemanticCache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Clear semantic cache for a given llm_string."""</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">"llm_string"</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_dict</span><span class="p">[</span><span class="n">index_name</span><span class="p">]</span></div></div>
</pre></div>
</article>
</div>
</div>
<footer class="bd-footer-content">
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>
<footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
<div class="footer-items__start">
<div class="footer-item">
<p class="copyright">
    
      Â© Copyright 2023, LangChain Inc.
      <br/>
</p>
</div>
</div>
</div>
</footer>
</body>
</html>